"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExperimentalEventLoopPerformanceMetricsMiddleware = void 0;
const perf_hooks_1 = require("perf_hooks");
class ExperimentalEventLoopPerformanceMetricsMiddlewareRequestHandler {
    onRequestBody(request) {
        return Promise.resolve(request);
    }
    onRequestMetadata(metadata) {
        return Promise.resolve(metadata);
    }
    onResponseMetadata(metadata) {
        return Promise.resolve(metadata);
    }
    onResponseBody(response) {
        return Promise.resolve(response);
    }
    onResponseStatus(status) {
        return Promise.resolve(status);
    }
}
/**
 * This middleware enables event-loop performance metrics.It runs a periodic task specified by metricsLogInterval
 * to gather various event-loop metrics that can be correlated with the overall application's performance. This is
 * particularly helpful to analyze and correlate resource contention with higher network latencies.
 *
 * See {@link StateMetrics} for each heuristic/metric and their description.
 */
class ExperimentalEventLoopPerformanceMetricsMiddleware {
    constructor(loggerFactory) {
        this.metricsLogInterval = 1000;
        this.eventLoopDelayInterval = 20;
        this.isLoggingStarted = false;
        // this is typed as any because JS returns a number for intervalId but
        // TS returns a NodeJS.Timeout.
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        this.intervalId = null; // Store the interval ID
        this.logger = loggerFactory.getLogger(this);
    }
    init() {
        if (!this.isLoggingStarted) {
            this.isLoggingStarted = true;
            this.startLogging();
        }
    }
    startLogging() {
        this.eldMonitor = (0, perf_hooks_1.monitorEventLoopDelay)({
            resolution: this.eventLoopDelayInterval,
        });
        this.eldMonitor.enable();
        this.elu = perf_hooks_1.performance.eventLoopUtilization();
        this.intervalId = setInterval(() => {
            this.elu = perf_hooks_1.performance.eventLoopUtilization(this.elu);
            const metrics = {
                eventLoopUtilization: this.elu.utilization,
                eventLoopDelayMean: this.eldMonitor.mean,
                eventLoopDelayMin: this.eldMonitor.min,
                eventLoopDelayP50: this.eldMonitor.percentile(50),
                eventLoopDelayP75: this.eldMonitor.percentile(75),
                eventLoopDelayP90: this.eldMonitor.percentile(90),
                eventLoopDelayP95: this.eldMonitor.percentile(95),
                eventLoopDelayP99: this.eldMonitor.percentile(99),
                eventLoopDelayMax: this.eldMonitor.max,
                timestamp: Date.now(),
            };
            this.logger.info(JSON.stringify(metrics));
            this.eldMonitor.reset();
        }, this.metricsLogInterval);
    }
    onNewRequest() {
        return new ExperimentalEventLoopPerformanceMetricsMiddlewareRequestHandler();
    }
    close() {
        if (this.intervalId !== null) {
            this.logger.debug('Stopping event loop metrics logging.');
            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
            clearInterval(this.intervalId);
            this.intervalId = null;
            this.isLoggingStarted = false;
            this.logger.debug('Event loop metrics logging stopped.');
        }
    }
}
exports.ExperimentalEventLoopPerformanceMetricsMiddleware = ExperimentalEventLoopPerformanceMetricsMiddleware;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZXJpbWVudGFsLWV2ZW50LWxvb3AtcGVyZi1taWRkbGV3YXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbmZpZy9taWRkbGV3YXJlL2V4cGVyaW1lbnRhbC1ldmVudC1sb29wLXBlcmYtbWlkZGxld2FyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFPQSwyQ0FJb0I7QUF3RHBCLE1BQU0sK0RBQStEO0lBR25FLGFBQWEsQ0FBQyxPQUEwQjtRQUN0QyxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELGlCQUFpQixDQUFDLFFBQTRCO1FBQzVDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsa0JBQWtCLENBQ2hCLFFBQTRCO1FBRTVCLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsY0FBYyxDQUNaLFFBQWtDO1FBRWxDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsTUFBd0I7UUFDdkMsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2pDLENBQUM7Q0FDRjtBQUVEOzs7Ozs7R0FNRztBQUNILE1BQWEsaURBQWlEO0lBYzVELFlBQVksYUFBbUM7UUFYOUIsdUJBQWtCLEdBQUcsSUFBSSxDQUFDO1FBQzFCLDJCQUFzQixHQUFHLEVBQUUsQ0FBQztRQUdyQyxxQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFDakMsc0VBQXNFO1FBQ3RFLCtCQUErQjtRQUMvQiw4REFBOEQ7UUFDdEQsZUFBVSxHQUFlLElBQUksQ0FBQyxDQUFDLHdCQUF3QjtRQUk3RCxJQUFJLENBQUMsTUFBTSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVELElBQUk7UUFDRixJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQzFCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7WUFDN0IsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1NBQ3JCO0lBQ0gsQ0FBQztJQUVPLFlBQVk7UUFDbEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFBLGtDQUFxQixFQUFDO1lBQ3RDLFVBQVUsRUFBRSxJQUFJLENBQUMsc0JBQXNCO1NBQ3hDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDekIsSUFBSSxDQUFDLEdBQUcsR0FBRyx3QkFBVyxDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFFOUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFO1lBQ2pDLElBQUksQ0FBQyxHQUFHLEdBQUcsd0JBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEQsTUFBTSxPQUFPLEdBQWlCO2dCQUM1QixvQkFBb0IsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVc7Z0JBQzFDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSTtnQkFDeEMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHO2dCQUN0QyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7Z0JBQ2pELGlCQUFpQixFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztnQkFDakQsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO2dCQUNqRCxpQkFBaUIsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7Z0JBQ2pELGlCQUFpQixFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztnQkFDakQsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHO2dCQUN0QyxTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTthQUN0QixDQUFDO1lBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQzFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDMUIsQ0FBQyxFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxZQUFZO1FBQ1YsT0FBTyxJQUFJLCtEQUErRCxFQUFFLENBQUM7SUFDL0UsQ0FBQztJQUVELEtBQUs7UUFDSCxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssSUFBSSxFQUFFO1lBQzVCLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7WUFDMUQsaUVBQWlFO1lBQ2pFLGFBQWEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDL0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7WUFDdkIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztZQUM5QixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1NBQzFEO0lBQ0gsQ0FBQztDQUNGO0FBakVELDhHQWlFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIE1pZGRsZXdhcmUsXG4gIE1pZGRsZXdhcmVNZXNzYWdlLFxuICBNaWRkbGV3YXJlTWV0YWRhdGEsXG4gIE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcixcbiAgTWlkZGxld2FyZVN0YXR1cyxcbn0gZnJvbSAnLi9taWRkbGV3YXJlJztcbmltcG9ydCB7XG4gIEV2ZW50TG9vcFV0aWxpemF0aW9uLFxuICBtb25pdG9yRXZlbnRMb29wRGVsYXksXG4gIHBlcmZvcm1hbmNlLFxufSBmcm9tICdwZXJmX2hvb2tzJztcbmltcG9ydCB7TW9tZW50b0xvZ2dlciwgTW9tZW50b0xvZ2dlckZhY3Rvcnl9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUnO1xuaW1wb3J0IHtJbnRlcnZhbEhpc3RvZ3JhbX0gZnJvbSAnbm9kZTpwZXJmX2hvb2tzJztcblxuaW50ZXJmYWNlIFN0YXRlTWV0cmljcyB7XG4gIC8qKlxuICAgKiBUaGUgcHJvcG9ydGlvbiBvZiB0aW1lIHRoZSBldmVudCBsb29wIHdhcyBidXN5IG92ZXIgdGhlIGxhc3Qgc2Vjb25kLlxuICAgKi9cbiAgZXZlbnRMb29wVXRpbGl6YXRpb246IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIGF2ZXJhZ2UgZXZlbnQgbG9vcCBkZWxheSBvdmVyIHRoZSBsYXN0IHNlY29uZCwgbWVhc3VyZWQgaW4gMjBtcyBpbmNyZW1lbnRzLlxuICAgKi9cbiAgZXZlbnRMb29wRGVsYXlNZWFuOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBtaW5pbXVtIGV2ZW50IGxvb3AgZGVsYXkgb3ZlciB0aGUgbGFzdCBzZWNvbmQsIG1lYXN1cmVkIGluIDIwbXMgaW5jcmVtZW50cy5cbiAgICovXG4gIGV2ZW50TG9vcERlbGF5TWluOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSA1MHRoIHBlcmNlbnRpbGUgZXZlbnQgbG9vcCBkZWxheSBvdmVyIHRoZSBsYXN0IHNlY29uZCwgbWVhc3VyZWQgaW4gMjBtcyBpbmNyZW1lbnRzLlxuICAgKi9cbiAgZXZlbnRMb29wRGVsYXlQNTA6IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIDc1dGggcGVyY2VudGlsZSBldmVudCBsb29wIGRlbGF5IG92ZXIgdGhlIGxhc3Qgc2Vjb25kLCBtZWFzdXJlZCBpbiAyMG1zIGluY3JlbWVudHMuXG4gICAqL1xuICBldmVudExvb3BEZWxheVA3NTogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgOTB0aCBwZXJjZW50aWxlIGV2ZW50IGxvb3AgZGVsYXkgb3ZlciB0aGUgbGFzdCBzZWNvbmQsIG1lYXN1cmVkIGluIDIwbXMgaW5jcmVtZW50cy5cbiAgICovXG4gIGV2ZW50TG9vcERlbGF5UDkwOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSA5NXRoIHBlcmNlbnRpbGUgZXZlbnQgbG9vcCBkZWxheSBvdmVyIHRoZSBsYXN0IHNlY29uZCwgbWVhc3VyZWQgaW4gMjBtcyBpbmNyZW1lbnRzLlxuICAgKi9cbiAgZXZlbnRMb29wRGVsYXlQOTU6IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIDk5dGggcGVyY2VudGlsZSBldmVudCBsb29wIGRlbGF5IG92ZXIgdGhlIGxhc3Qgc2Vjb25kLCBtZWFzdXJlZCBpbiAyMG1zIGluY3JlbWVudHMuXG4gICAqL1xuICBldmVudExvb3BEZWxheVA5OTogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgbWF4aW11bSBldmVudCBsb29wIGRlbGF5IG92ZXIgdGhlIGxhc3Qgc2Vjb25kLCBtZWFzdXJlZCBpbiAyMG1zIGluY3JlbWVudHMuXG4gICAqL1xuICBldmVudExvb3BEZWxheU1heDogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgdGltZXN0YW1wIHdoZW4gdGhlIHN0YXRlIG1ldHJpY3MgZ290IHJlY29yZGVkXG4gICAqL1xuICB0aW1lc3RhbXA6IG51bWJlcjtcbn1cblxuY2xhc3MgRXhwZXJpbWVudGFsRXZlbnRMb29wUGVyZm9ybWFuY2VNZXRyaWNzTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyXG4gIGltcGxlbWVudHMgTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyXG57XG4gIG9uUmVxdWVzdEJvZHkocmVxdWVzdDogTWlkZGxld2FyZU1lc3NhZ2UpOiBQcm9taXNlPE1pZGRsZXdhcmVNZXNzYWdlPiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXF1ZXN0KTtcbiAgfVxuXG4gIG9uUmVxdWVzdE1ldGFkYXRhKG1ldGFkYXRhOiBNaWRkbGV3YXJlTWV0YWRhdGEpOiBQcm9taXNlPE1pZGRsZXdhcmVNZXRhZGF0YT4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobWV0YWRhdGEpO1xuICB9XG5cbiAgb25SZXNwb25zZU1ldGFkYXRhKFxuICAgIG1ldGFkYXRhOiBNaWRkbGV3YXJlTWV0YWRhdGFcbiAgKTogUHJvbWlzZTxNaWRkbGV3YXJlTWV0YWRhdGE+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG1ldGFkYXRhKTtcbiAgfVxuXG4gIG9uUmVzcG9uc2VCb2R5KFxuICAgIHJlc3BvbnNlOiBNaWRkbGV3YXJlTWVzc2FnZSB8IG51bGxcbiAgKTogUHJvbWlzZTxNaWRkbGV3YXJlTWVzc2FnZSB8IG51bGw+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3BvbnNlKTtcbiAgfVxuXG4gIG9uUmVzcG9uc2VTdGF0dXMoc3RhdHVzOiBNaWRkbGV3YXJlU3RhdHVzKTogUHJvbWlzZTxNaWRkbGV3YXJlU3RhdHVzPiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShzdGF0dXMpO1xuICB9XG59XG5cbi8qKlxuICogVGhpcyBtaWRkbGV3YXJlIGVuYWJsZXMgZXZlbnQtbG9vcCBwZXJmb3JtYW5jZSBtZXRyaWNzLkl0IHJ1bnMgYSBwZXJpb2RpYyB0YXNrIHNwZWNpZmllZCBieSBtZXRyaWNzTG9nSW50ZXJ2YWxcbiAqIHRvIGdhdGhlciB2YXJpb3VzIGV2ZW50LWxvb3AgbWV0cmljcyB0aGF0IGNhbiBiZSBjb3JyZWxhdGVkIHdpdGggdGhlIG92ZXJhbGwgYXBwbGljYXRpb24ncyBwZXJmb3JtYW5jZS4gVGhpcyBpc1xuICogcGFydGljdWxhcmx5IGhlbHBmdWwgdG8gYW5hbHl6ZSBhbmQgY29ycmVsYXRlIHJlc291cmNlIGNvbnRlbnRpb24gd2l0aCBoaWdoZXIgbmV0d29yayBsYXRlbmNpZXMuXG4gKlxuICogU2VlIHtAbGluayBTdGF0ZU1ldHJpY3N9IGZvciBlYWNoIGhldXJpc3RpYy9tZXRyaWMgYW5kIHRoZWlyIGRlc2NyaXB0aW9uLlxuICovXG5leHBvcnQgY2xhc3MgRXhwZXJpbWVudGFsRXZlbnRMb29wUGVyZm9ybWFuY2VNZXRyaWNzTWlkZGxld2FyZVxuICBpbXBsZW1lbnRzIE1pZGRsZXdhcmVcbntcbiAgcHJpdmF0ZSByZWFkb25seSBtZXRyaWNzTG9nSW50ZXJ2YWwgPSAxMDAwO1xuICBwcml2YXRlIHJlYWRvbmx5IGV2ZW50TG9vcERlbGF5SW50ZXJ2YWwgPSAyMDtcbiAgcHJpdmF0ZSBlbGRNb25pdG9yOiBJbnRlcnZhbEhpc3RvZ3JhbTtcbiAgcHJpdmF0ZSBlbHU6IEV2ZW50TG9vcFV0aWxpemF0aW9uO1xuICBwcml2YXRlIGlzTG9nZ2luZ1N0YXJ0ZWQgPSBmYWxzZTtcbiAgLy8gdGhpcyBpcyB0eXBlZCBhcyBhbnkgYmVjYXVzZSBKUyByZXR1cm5zIGEgbnVtYmVyIGZvciBpbnRlcnZhbElkIGJ1dFxuICAvLyBUUyByZXR1cm5zIGEgTm9kZUpTLlRpbWVvdXQuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIHByaXZhdGUgaW50ZXJ2YWxJZDogYW55IHwgbnVsbCA9IG51bGw7IC8vIFN0b3JlIHRoZSBpbnRlcnZhbCBJRFxuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlcjogTW9tZW50b0xvZ2dlcjtcblxuICBjb25zdHJ1Y3Rvcihsb2dnZXJGYWN0b3J5OiBNb21lbnRvTG9nZ2VyRmFjdG9yeSkge1xuICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyRmFjdG9yeS5nZXRMb2dnZXIodGhpcyk7XG4gIH1cblxuICBpbml0KCkge1xuICAgIGlmICghdGhpcy5pc0xvZ2dpbmdTdGFydGVkKSB7XG4gICAgICB0aGlzLmlzTG9nZ2luZ1N0YXJ0ZWQgPSB0cnVlO1xuICAgICAgdGhpcy5zdGFydExvZ2dpbmcoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHN0YXJ0TG9nZ2luZygpOiB2b2lkIHtcbiAgICB0aGlzLmVsZE1vbml0b3IgPSBtb25pdG9yRXZlbnRMb29wRGVsYXkoe1xuICAgICAgcmVzb2x1dGlvbjogdGhpcy5ldmVudExvb3BEZWxheUludGVydmFsLFxuICAgIH0pO1xuICAgIHRoaXMuZWxkTW9uaXRvci5lbmFibGUoKTtcbiAgICB0aGlzLmVsdSA9IHBlcmZvcm1hbmNlLmV2ZW50TG9vcFV0aWxpemF0aW9uKCk7XG5cbiAgICB0aGlzLmludGVydmFsSWQgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICB0aGlzLmVsdSA9IHBlcmZvcm1hbmNlLmV2ZW50TG9vcFV0aWxpemF0aW9uKHRoaXMuZWx1KTtcbiAgICAgIGNvbnN0IG1ldHJpY3M6IFN0YXRlTWV0cmljcyA9IHtcbiAgICAgICAgZXZlbnRMb29wVXRpbGl6YXRpb246IHRoaXMuZWx1LnV0aWxpemF0aW9uLFxuICAgICAgICBldmVudExvb3BEZWxheU1lYW46IHRoaXMuZWxkTW9uaXRvci5tZWFuLFxuICAgICAgICBldmVudExvb3BEZWxheU1pbjogdGhpcy5lbGRNb25pdG9yLm1pbixcbiAgICAgICAgZXZlbnRMb29wRGVsYXlQNTA6IHRoaXMuZWxkTW9uaXRvci5wZXJjZW50aWxlKDUwKSxcbiAgICAgICAgZXZlbnRMb29wRGVsYXlQNzU6IHRoaXMuZWxkTW9uaXRvci5wZXJjZW50aWxlKDc1KSxcbiAgICAgICAgZXZlbnRMb29wRGVsYXlQOTA6IHRoaXMuZWxkTW9uaXRvci5wZXJjZW50aWxlKDkwKSxcbiAgICAgICAgZXZlbnRMb29wRGVsYXlQOTU6IHRoaXMuZWxkTW9uaXRvci5wZXJjZW50aWxlKDk1KSxcbiAgICAgICAgZXZlbnRMb29wRGVsYXlQOTk6IHRoaXMuZWxkTW9uaXRvci5wZXJjZW50aWxlKDk5KSxcbiAgICAgICAgZXZlbnRMb29wRGVsYXlNYXg6IHRoaXMuZWxkTW9uaXRvci5tYXgsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIH07XG4gICAgICB0aGlzLmxvZ2dlci5pbmZvKEpTT04uc3RyaW5naWZ5KG1ldHJpY3MpKTtcbiAgICAgIHRoaXMuZWxkTW9uaXRvci5yZXNldCgpO1xuICAgIH0sIHRoaXMubWV0cmljc0xvZ0ludGVydmFsKTtcbiAgfVxuXG4gIG9uTmV3UmVxdWVzdCgpOiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXIge1xuICAgIHJldHVybiBuZXcgRXhwZXJpbWVudGFsRXZlbnRMb29wUGVyZm9ybWFuY2VNZXRyaWNzTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyKCk7XG4gIH1cblxuICBjbG9zZSgpIHtcbiAgICBpZiAodGhpcy5pbnRlcnZhbElkICE9PSBudWxsKSB7XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnU3RvcHBpbmcgZXZlbnQgbG9vcCBtZXRyaWNzIGxvZ2dpbmcuJyk7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVuc2FmZS1hcmd1bWVudFxuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmludGVydmFsSWQpO1xuICAgICAgdGhpcy5pbnRlcnZhbElkID0gbnVsbDtcbiAgICAgIHRoaXMuaXNMb2dnaW5nU3RhcnRlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoJ0V2ZW50IGxvb3AgbWV0cmljcyBsb2dnaW5nIHN0b3BwZWQuJyk7XG4gICAgfVxuICB9XG59XG4iXX0=