"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebhookClient = void 0;
const generated_types_1 = require("@gomomento/generated-types");
var grpcWebhook = generated_types_1.webhook.webhook;
const sdk_core_1 = require("@gomomento/sdk-core");
const grpc_js_1 = require("@grpc/grpc-js");
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const package_json_1 = require("../../package.json");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const retry_interceptor_1 = require("./grpc/retry-interceptor");
const utils_2 = require("@gomomento/sdk-core/dist/src/utils");
class WebhookClient {
    /**
     * @param {TopicClientProps} props
     */
    constructor(props) {
        this.credentialProvider = props.credentialProvider;
        this.logger = props.configuration.getLoggerFactory().getLogger(this);
        this.cacheServiceErrorMapper = new cache_service_error_mapper_1.CacheServiceErrorMapper(props.configuration.getThrowOnErrors());
        const headers = [
            new headers_interceptor_1.Header('Authorization', props.credentialProvider.getAuthToken()),
            new headers_interceptor_1.Header('agent', `nodejs:webhook:${package_json_1.version}`),
            new headers_interceptor_1.Header('runtime-version', `nodejs:${process.versions.node}`),
        ];
        this.unaryInterceptors = [
            headers_interceptor_1.HeaderInterceptor.createHeadersInterceptor(headers),
            retry_interceptor_1.RetryInterceptor.createRetryInterceptor({
                clientName: 'WebhookClient',
                loggerFactory: props.configuration.getLoggerFactory(),
                overallRequestTimeoutMs: WebhookClient.DEFAULT_REQUEST_TIMEOUT_MS,
            }),
        ];
        this.webhookClient = new generated_types_1.webhook.webhook.WebhookClient(props.credentialProvider.getControlEndpoint(), props.credentialProvider.isControlEndpointSecure()
            ? grpc_js_1.ChannelCredentials.createSsl()
            : grpc_js_1.ChannelCredentials.createInsecure());
    }
    async deleteWebhook(id) {
        try {
            (0, utils_1.validateCacheName)(id.cacheName);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.DeleteWebhook.Error(err));
        }
        const request = new grpcWebhook._DeleteWebhookRequest({
            webhook_id: new grpcWebhook._WebhookId({
                cache_name: id.cacheName,
                webhook_name: id.webhookName,
            }),
        });
        this.logger.debug('issuing "DeleteWebhook" request');
        return await new Promise((resolve, reject) => {
            this.webhookClient.DeleteWebhook(request, { interceptors: this.unaryInterceptors }, (err, _resp) => {
                if (err) {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.DeleteWebhook.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
                else {
                    resolve(new sdk_core_1.DeleteWebhook.Success());
                }
            });
        });
    }
    async listWebhooks(cache) {
        try {
            (0, utils_1.validateCacheName)(cache);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.ListWebhooks.Error(err));
        }
        const request = new grpcWebhook._ListWebhookRequest({ cache_name: cache });
        this.logger.debug('issuing "ListWebhooks" request');
        return await new Promise((resolve, reject) => {
            this.webhookClient.ListWebhooks(request, { interceptors: this.unaryInterceptors }, (err, resp) => {
                if (err || !resp) {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.ListWebhooks.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
                else {
                    const webhooks = resp.webhook.map(wh => {
                        const webhook = {
                            id: {
                                cacheName: wh.webhook_id.cache_name,
                                webhookName: wh.webhook_id.webhook_name,
                            },
                            topicName: wh.topic_name,
                            destination: new sdk_core_1.PostUrlWebhookDestination(wh.destination.post_url),
                        };
                        return webhook;
                    });
                    resolve(new sdk_core_1.ListWebhooks.Success(webhooks));
                }
            });
        });
    }
    async putWebhook(webhook) {
        try {
            (0, utils_1.validateCacheName)(webhook.id.cacheName);
            (0, utils_1.validateTopicName)(webhook.topicName);
            (0, utils_1.validateWebhookName)(webhook.id.webhookName);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.PutWebhook.Error(err));
        }
        const request = new grpcWebhook._PutWebhookRequest({
            webhook: new grpcWebhook._Webhook({
                webhook_id: new grpcWebhook._WebhookId({
                    cache_name: webhook.id.cacheName,
                    webhook_name: webhook.id.webhookName,
                }),
                destination: new grpcWebhook._WebhookDestination({
                    post_url: webhook.destination.url(),
                }),
                topic_name: webhook.topicName,
            }),
        });
        this.logger.debug('issuing "PutWebhook" request');
        return await new Promise((resolve, reject) => {
            this.webhookClient.PutWebhook(request, { interceptors: this.unaryInterceptors }, (err, resp) => {
                if (err || !resp) {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.PutWebhook.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
                else {
                    resolve(new sdk_core_1.PutWebhook.Success(resp.secret_string));
                }
            });
        });
    }
    async getWebhookSecret(id) {
        try {
            (0, utils_1.validateCacheName)(id.cacheName);
            (0, utils_1.validateWebhookName)(id.webhookName);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.GetWebhookSecret.Error(err));
        }
        const request = new grpcWebhook._GetWebhookSecretRequest({
            webhook_name: id.webhookName,
            cache_name: id.cacheName,
        });
        this.logger.debug('issuing "GetWebhookSecret" request');
        return await new Promise((resolve, reject) => {
            this.webhookClient.GetWebhookSecret(request, { interceptors: this.unaryInterceptors }, (err, resp) => {
                if (err || !resp) {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.GetWebhookSecret.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
                else {
                    resolve(new sdk_core_1.GetWebhookSecret.Success({
                        secret: resp.secret_string,
                        webhookName: resp.webhook_name,
                        cacheName: resp.cache_name,
                    }));
                }
            });
        });
    }
    async rotateWebhookSecret(id) {
        try {
            (0, utils_1.validateCacheName)(id.cacheName);
            (0, utils_1.validateWebhookName)(id.webhookName);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.RotateWebhookSecret.Error(err));
        }
        const webhookId = grpcWebhook._WebhookId.fromObject({
            webhook_name: id.webhookName,
            cache_name: id.cacheName,
        });
        const request = new grpcWebhook._RotateWebhookSecretRequest({
            webhook_id: webhookId,
        });
        this.logger.debug('issuing "RotateWebhookSecret" request');
        return await new Promise((resolve, reject) => {
            this.webhookClient.RotateWebhookSecret(request, { interceptors: this.unaryInterceptors }, (err, resp) => {
                if (err || !resp) {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.RotateWebhookSecret.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
                else {
                    resolve(new sdk_core_1.RotateWebhookSecret.Success({
                        secret: resp.secret_string,
                        webhookName: id.webhookName,
                        cacheName: id.cacheName,
                    }));
                }
            });
        });
    }
}
exports.WebhookClient = WebhookClient;
WebhookClient.DEFAULT_REQUEST_TIMEOUT_MS = (0, utils_2.secondsToMilliseconds)(5);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViaG9vay1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaW50ZXJuYWwvd2ViaG9vay1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsZ0VBQW1EO0FBQ25ELElBQU8sV0FBVyxHQUFHLHlCQUFPLENBQUMsT0FBTyxDQUFDO0FBQ3JDLGtEQVc2QjtBQUM3QiwyQ0FBOEQ7QUFFOUQsb0VBQXFFO0FBQ3JFLHFEQUEyQztBQUMzQyxxRkFBNkU7QUFDN0UsdUVBSXFEO0FBQ3JELGdFQUEwRDtBQUUxRCw4REFBeUU7QUFFekUsTUFBYSxhQUFhO0lBU3hCOztPQUVHO0lBQ0gsWUFBWSxLQUEwQjtRQUNwQyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixDQUFDO1FBQ25ELElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxvREFBdUIsQ0FDeEQsS0FBSyxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxDQUN2QyxDQUFDO1FBQ0YsTUFBTSxPQUFPLEdBQUc7WUFDZCxJQUFJLDRCQUFNLENBQUMsZUFBZSxFQUFFLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNwRSxJQUFJLDRCQUFNLENBQUMsT0FBTyxFQUFFLGtCQUFrQixzQkFBTyxFQUFFLENBQUM7WUFDaEQsSUFBSSw0QkFBTSxDQUFDLGlCQUFpQixFQUFFLFVBQVUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNqRSxDQUFDO1FBQ0YsSUFBSSxDQUFDLGlCQUFpQixHQUFHO1lBQ3ZCLHVDQUFpQixDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQztZQUNuRCxvQ0FBZ0IsQ0FBQyxzQkFBc0IsQ0FBQztnQkFDdEMsVUFBVSxFQUFFLGVBQWU7Z0JBQzNCLGFBQWEsRUFBRSxLQUFLLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFO2dCQUNyRCx1QkFBdUIsRUFBRSxhQUFhLENBQUMsMEJBQTBCO2FBQ2xFLENBQUM7U0FDSCxDQUFDO1FBQ0YsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLHlCQUFPLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FDcEQsS0FBSyxDQUFDLGtCQUFrQixDQUFDLGtCQUFrQixFQUFFLEVBQzdDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyx1QkFBdUIsRUFBRTtZQUNoRCxDQUFDLENBQUMsNEJBQWtCLENBQUMsU0FBUyxFQUFFO1lBQ2hDLENBQUMsQ0FBQyw0QkFBa0IsQ0FBQyxjQUFjLEVBQUUsQ0FDeEMsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsYUFBYSxDQUFDLEVBQWE7UUFDL0IsSUFBSTtZQUNGLElBQUEseUJBQWlCLEVBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ2pDO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxrQkFBa0IsQ0FDcEQsR0FBWSxFQUNaLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSx3QkFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FDcEMsQ0FBQztTQUNIO1FBQ0QsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLENBQUMscUJBQXFCLENBQUM7WUFDcEQsVUFBVSxFQUFFLElBQUksV0FBVyxDQUFDLFVBQVUsQ0FBQztnQkFDckMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxTQUFTO2dCQUN4QixZQUFZLEVBQUUsRUFBRSxDQUFDLFdBQVc7YUFDN0IsQ0FBQztTQUNILENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7UUFFckQsT0FBTyxNQUFNLElBQUksT0FBTyxDQUF5QixDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNuRSxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FDOUIsT0FBTyxFQUNQLEVBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsRUFBQyxFQUN0QyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsRUFBRTtnQkFDYixJQUFJLEdBQUcsRUFBRTtvQkFDUCxJQUFJLENBQUMsdUJBQXVCLENBQUMsb0JBQW9CLENBQUM7d0JBQ2hELEdBQUcsRUFBRSxHQUFHO3dCQUNSLHNCQUFzQixFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSx3QkFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7d0JBQ3ZELFNBQVMsRUFBRSxPQUFPO3dCQUNsQixRQUFRLEVBQUUsTUFBTTtxQkFDakIsQ0FBQyxDQUFDO2lCQUNKO3FCQUFNO29CQUNMLE9BQU8sQ0FBQyxJQUFJLHdCQUFhLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztpQkFDdEM7WUFDSCxDQUFDLENBQ0YsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELEtBQUssQ0FBQyxZQUFZLENBQUMsS0FBYTtRQUM5QixJQUFJO1lBQ0YsSUFBQSx5QkFBaUIsRUFBQyxLQUFLLENBQUMsQ0FBQztTQUMxQjtRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osT0FBTyxJQUFJLENBQUMsdUJBQXVCLENBQUMsa0JBQWtCLENBQ3BELEdBQVksRUFDWixHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksdUJBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQ25DLENBQUM7U0FDSDtRQUNELE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxDQUFDLG1CQUFtQixDQUFDLEVBQUMsVUFBVSxFQUFFLEtBQUssRUFBQyxDQUFDLENBQUM7UUFDekUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUVwRCxPQUFPLE1BQU0sSUFBSSxPQUFPLENBQXdCLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ2xFLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUM3QixPQUFPLEVBQ1AsRUFBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixFQUFDLEVBQ3RDLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO2dCQUNaLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFO29CQUNoQixJQUFJLENBQUMsdUJBQXVCLENBQUMsb0JBQW9CLENBQUM7d0JBQ2hELEdBQUcsRUFBRSxHQUFHO3dCQUNSLHNCQUFzQixFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSx1QkFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7d0JBQ3RELFNBQVMsRUFBRSxPQUFPO3dCQUNsQixRQUFRLEVBQUUsTUFBTTtxQkFDakIsQ0FBQyxDQUFDO2lCQUNKO3FCQUFNO29CQUNMLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFO3dCQUNyQyxNQUFNLE9BQU8sR0FBWTs0QkFDdkIsRUFBRSxFQUFFO2dDQUNGLFNBQVMsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLFVBQVU7Z0NBQ25DLFdBQVcsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLFlBQVk7NkJBQ3hDOzRCQUNELFNBQVMsRUFBRSxFQUFFLENBQUMsVUFBVTs0QkFDeEIsV0FBVyxFQUFFLElBQUksb0NBQXlCLENBQ3hDLEVBQUUsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUN4Qjt5QkFDRixDQUFDO3dCQUNGLE9BQU8sT0FBTyxDQUFDO29CQUNqQixDQUFDLENBQUMsQ0FBQztvQkFDSCxPQUFPLENBQUMsSUFBSSx1QkFBWSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2lCQUM3QztZQUNILENBQUMsQ0FDRixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVUsQ0FBQyxPQUFnQjtRQUMvQixJQUFJO1lBQ0YsSUFBQSx5QkFBaUIsRUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3hDLElBQUEseUJBQWlCLEVBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3JDLElBQUEsMkJBQW1CLEVBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUM3QztRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osT0FBTyxJQUFJLENBQUMsdUJBQXVCLENBQUMsa0JBQWtCLENBQ3BELEdBQVksRUFDWixHQUFHLENBQUMsRUFBRSxDQUFDLElBQUkscUJBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQ2pDLENBQUM7U0FDSDtRQUVELE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxDQUFDLGtCQUFrQixDQUFDO1lBQ2pELE9BQU8sRUFBRSxJQUFJLFdBQVcsQ0FBQyxRQUFRLENBQUM7Z0JBQ2hDLFVBQVUsRUFBRSxJQUFJLFdBQVcsQ0FBQyxVQUFVLENBQUM7b0JBQ3JDLFVBQVUsRUFBRSxPQUFPLENBQUMsRUFBRSxDQUFDLFNBQVM7b0JBQ2hDLFlBQVksRUFBRSxPQUFPLENBQUMsRUFBRSxDQUFDLFdBQVc7aUJBQ3JDLENBQUM7Z0JBQ0YsV0FBVyxFQUFFLElBQUksV0FBVyxDQUFDLG1CQUFtQixDQUFDO29CQUMvQyxRQUFRLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUU7aUJBQ3BDLENBQUM7Z0JBQ0YsVUFBVSxFQUFFLE9BQU8sQ0FBQyxTQUFTO2FBQzlCLENBQUM7U0FDSCxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1FBRWxELE9BQU8sTUFBTSxJQUFJLE9BQU8sQ0FBc0IsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDaEUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQzNCLE9BQU8sRUFDUCxFQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsaUJBQWlCLEVBQUMsRUFDdEMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ1osSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUU7b0JBQ2hCLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxvQkFBb0IsQ0FBQzt3QkFDaEQsR0FBRyxFQUFFLEdBQUc7d0JBQ1Isc0JBQXNCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLHFCQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQzt3QkFDcEQsU0FBUyxFQUFFLE9BQU87d0JBQ2xCLFFBQVEsRUFBRSxNQUFNO3FCQUNqQixDQUFDLENBQUM7aUJBQ0o7cUJBQU07b0JBQ0wsT0FBTyxDQUFDLElBQUkscUJBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7aUJBQ3JEO1lBQ0gsQ0FBQyxDQUNGLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsRUFBYTtRQUNsQyxJQUFJO1lBQ0YsSUFBQSx5QkFBaUIsRUFBQyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDaEMsSUFBQSwyQkFBbUIsRUFBQyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDckM7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLE9BQU8sSUFBSSxDQUFDLHVCQUF1QixDQUFDLGtCQUFrQixDQUNwRCxHQUFZLEVBQ1osR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLDJCQUFnQixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FDdkMsQ0FBQztTQUNIO1FBRUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLENBQUMsd0JBQXdCLENBQUM7WUFDdkQsWUFBWSxFQUFFLEVBQUUsQ0FBQyxXQUFXO1lBQzVCLFVBQVUsRUFBRSxFQUFFLENBQUMsU0FBUztTQUN6QixDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1FBRXhELE9BQU8sTUFBTSxJQUFJLE9BQU8sQ0FBNEIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDdEUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FDakMsT0FBTyxFQUNQLEVBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsRUFBQyxFQUN0QyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTtnQkFDWixJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRTtvQkFDaEIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLG9CQUFvQixDQUFDO3dCQUNoRCxHQUFHLEVBQUUsR0FBRzt3QkFDUixzQkFBc0IsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksMkJBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQzt3QkFDMUQsU0FBUyxFQUFFLE9BQU87d0JBQ2xCLFFBQVEsRUFBRSxNQUFNO3FCQUNqQixDQUFDLENBQUM7aUJBQ0o7cUJBQU07b0JBQ0wsT0FBTyxDQUNMLElBQUksMkJBQWdCLENBQUMsT0FBTyxDQUFDO3dCQUMzQixNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWE7d0JBQzFCLFdBQVcsRUFBRSxJQUFJLENBQUMsWUFBWTt3QkFDOUIsU0FBUyxFQUFFLElBQUksQ0FBQyxVQUFVO3FCQUMzQixDQUFDLENBQ0gsQ0FBQztpQkFDSDtZQUNILENBQUMsQ0FDRixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLG1CQUFtQixDQUN2QixFQUFhO1FBRWIsSUFBSTtZQUNGLElBQUEseUJBQWlCLEVBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2hDLElBQUEsMkJBQW1CLEVBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ3JDO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxrQkFBa0IsQ0FDcEQsR0FBWSxFQUNaLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSw4QkFBbUIsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQzFDLENBQUM7U0FDSDtRQUVELE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDO1lBQ2xELFlBQVksRUFBRSxFQUFFLENBQUMsV0FBVztZQUM1QixVQUFVLEVBQUUsRUFBRSxDQUFDLFNBQVM7U0FDekIsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLENBQUMsMkJBQTJCLENBQUM7WUFDMUQsVUFBVSxFQUFFLFNBQVM7U0FDdEIsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsdUNBQXVDLENBQUMsQ0FBQztRQUUzRCxPQUFPLE1BQU0sSUFBSSxPQUFPLENBQ3RCLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ2xCLElBQUksQ0FBQyxhQUFhLENBQUMsbUJBQW1CLENBQ3BDLE9BQU8sRUFDUCxFQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsaUJBQWlCLEVBQUMsRUFDdEMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ1osSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUU7b0JBQ2hCLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxvQkFBb0IsQ0FBQzt3QkFDaEQsR0FBRyxFQUFFLEdBQUc7d0JBQ1Isc0JBQXNCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLDhCQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7d0JBQzdELFNBQVMsRUFBRSxPQUFPO3dCQUNsQixRQUFRLEVBQUUsTUFBTTtxQkFDakIsQ0FBQyxDQUFDO2lCQUNKO3FCQUFNO29CQUNMLE9BQU8sQ0FDTCxJQUFJLDhCQUFtQixDQUFDLE9BQU8sQ0FBQzt3QkFDOUIsTUFBTSxFQUFFLElBQUksQ0FBQyxhQUFhO3dCQUMxQixXQUFXLEVBQUUsRUFBRSxDQUFDLFdBQVc7d0JBQzNCLFNBQVMsRUFBRSxFQUFFLENBQUMsU0FBUztxQkFDeEIsQ0FBQyxDQUNILENBQUM7aUJBQ0g7WUFDSCxDQUFDLENBQ0YsQ0FBQztRQUNKLENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQzs7QUFsUUgsc0NBbVFDO0FBOVB5Qix3Q0FBMEIsR0FDaEQsSUFBQSw2QkFBcUIsRUFBQyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7d2ViaG9va30gZnJvbSAnQGdvbW9tZW50by9nZW5lcmF0ZWQtdHlwZXMnO1xuaW1wb3J0IGdycGNXZWJob29rID0gd2ViaG9vay53ZWJob29rO1xuaW1wb3J0IHtcbiAgQ3JlZGVudGlhbFByb3ZpZGVyLFxuICBNb21lbnRvTG9nZ2VyLFxuICBXZWJob29rLFxuICBXZWJob29rSWQsXG4gIERlbGV0ZVdlYmhvb2ssXG4gIFB1dFdlYmhvb2ssXG4gIExpc3RXZWJob29rcyxcbiAgUG9zdFVybFdlYmhvb2tEZXN0aW5hdGlvbixcbiAgR2V0V2ViaG9va1NlY3JldCxcbiAgUm90YXRlV2ViaG9va1NlY3JldCxcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZSc7XG5pbXBvcnQge0NoYW5uZWxDcmVkZW50aWFscywgSW50ZXJjZXB0b3J9IGZyb20gJ0BncnBjL2dycGMtanMnO1xuaW1wb3J0IHtJV2ViaG9va0NsaWVudH0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC9jbGllbnRzL3B1YnN1Yi9JV2ViaG9va0NsaWVudCc7XG5pbXBvcnQge0hlYWRlciwgSGVhZGVySW50ZXJjZXB0b3J9IGZyb20gJy4vZ3JwYy9oZWFkZXJzLWludGVyY2VwdG9yJztcbmltcG9ydCB7dmVyc2lvbn0gZnJvbSAnLi4vLi4vcGFja2FnZS5qc29uJztcbmltcG9ydCB7Q2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXJ9IGZyb20gJy4uL2Vycm9ycy9jYWNoZS1zZXJ2aWNlLWVycm9yLW1hcHBlcic7XG5pbXBvcnQge1xuICB2YWxpZGF0ZUNhY2hlTmFtZSxcbiAgdmFsaWRhdGVUb3BpY05hbWUsXG4gIHZhbGlkYXRlV2ViaG9va05hbWUsXG59IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHtSZXRyeUludGVyY2VwdG9yfSBmcm9tICcuL2dycGMvcmV0cnktaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtUb3BpY0NsaWVudEFsbFByb3BzfSBmcm9tICcuL3RvcGljLWNsaWVudC1hbGwtcHJvcHMnO1xuaW1wb3J0IHtzZWNvbmRzVG9NaWxsaXNlY29uZHN9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvdXRpbHMnO1xuXG5leHBvcnQgY2xhc3MgV2ViaG9va0NsaWVudCBpbXBsZW1lbnRzIElXZWJob29rQ2xpZW50IHtcbiAgcHJpdmF0ZSByZWFkb25seSB3ZWJob29rQ2xpZW50OiBncnBjV2ViaG9vay5XZWJob29rQ2xpZW50O1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgY3JlZGVudGlhbFByb3ZpZGVyOiBDcmVkZW50aWFsUHJvdmlkZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyOiBNb21lbnRvTG9nZ2VyO1xuICBwcml2YXRlIHJlYWRvbmx5IGNhY2hlU2VydmljZUVycm9yTWFwcGVyOiBDYWNoZVNlcnZpY2VFcnJvck1hcHBlcjtcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgREVGQVVMVF9SRVFVRVNUX1RJTUVPVVRfTVM6IG51bWJlciA9XG4gICAgc2Vjb25kc1RvTWlsbGlzZWNvbmRzKDUpO1xuICBwcml2YXRlIHJlYWRvbmx5IHVuYXJ5SW50ZXJjZXB0b3JzOiBJbnRlcmNlcHRvcltdO1xuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1RvcGljQ2xpZW50UHJvcHN9IHByb3BzXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcm9wczogVG9waWNDbGllbnRBbGxQcm9wcykge1xuICAgIHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyID0gcHJvcHMuY3JlZGVudGlhbFByb3ZpZGVyO1xuICAgIHRoaXMubG9nZ2VyID0gcHJvcHMuY29uZmlndXJhdGlvbi5nZXRMb2dnZXJGYWN0b3J5KCkuZ2V0TG9nZ2VyKHRoaXMpO1xuICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIgPSBuZXcgQ2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIoXG4gICAgICBwcm9wcy5jb25maWd1cmF0aW9uLmdldFRocm93T25FcnJvcnMoKVxuICAgICk7XG4gICAgY29uc3QgaGVhZGVycyA9IFtcbiAgICAgIG5ldyBIZWFkZXIoJ0F1dGhvcml6YXRpb24nLCBwcm9wcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0QXV0aFRva2VuKCkpLFxuICAgICAgbmV3IEhlYWRlcignYWdlbnQnLCBgbm9kZWpzOndlYmhvb2s6JHt2ZXJzaW9ufWApLFxuICAgICAgbmV3IEhlYWRlcigncnVudGltZS12ZXJzaW9uJywgYG5vZGVqczoke3Byb2Nlc3MudmVyc2lvbnMubm9kZX1gKSxcbiAgICBdO1xuICAgIHRoaXMudW5hcnlJbnRlcmNlcHRvcnMgPSBbXG4gICAgICBIZWFkZXJJbnRlcmNlcHRvci5jcmVhdGVIZWFkZXJzSW50ZXJjZXB0b3IoaGVhZGVycyksXG4gICAgICBSZXRyeUludGVyY2VwdG9yLmNyZWF0ZVJldHJ5SW50ZXJjZXB0b3Ioe1xuICAgICAgICBjbGllbnROYW1lOiAnV2ViaG9va0NsaWVudCcsXG4gICAgICAgIGxvZ2dlckZhY3Rvcnk6IHByb3BzLmNvbmZpZ3VyYXRpb24uZ2V0TG9nZ2VyRmFjdG9yeSgpLFxuICAgICAgICBvdmVyYWxsUmVxdWVzdFRpbWVvdXRNczogV2ViaG9va0NsaWVudC5ERUZBVUxUX1JFUVVFU1RfVElNRU9VVF9NUyxcbiAgICAgIH0pLFxuICAgIF07XG4gICAgdGhpcy53ZWJob29rQ2xpZW50ID0gbmV3IHdlYmhvb2sud2ViaG9vay5XZWJob29rQ2xpZW50KFxuICAgICAgcHJvcHMuY3JlZGVudGlhbFByb3ZpZGVyLmdldENvbnRyb2xFbmRwb2ludCgpLFxuICAgICAgcHJvcHMuY3JlZGVudGlhbFByb3ZpZGVyLmlzQ29udHJvbEVuZHBvaW50U2VjdXJlKClcbiAgICAgICAgPyBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlU3NsKClcbiAgICAgICAgOiBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlSW5zZWN1cmUoKVxuICAgICk7XG4gIH1cblxuICBhc3luYyBkZWxldGVXZWJob29rKGlkOiBXZWJob29rSWQpOiBQcm9taXNlPERlbGV0ZVdlYmhvb2suUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVDYWNoZU5hbWUoaWQuY2FjaGVOYW1lKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IERlbGV0ZVdlYmhvb2suRXJyb3IoZXJyKVxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBncnBjV2ViaG9vay5fRGVsZXRlV2ViaG9va1JlcXVlc3Qoe1xuICAgICAgd2ViaG9va19pZDogbmV3IGdycGNXZWJob29rLl9XZWJob29rSWQoe1xuICAgICAgICBjYWNoZV9uYW1lOiBpZC5jYWNoZU5hbWUsXG4gICAgICAgIHdlYmhvb2tfbmFtZTogaWQud2ViaG9va05hbWUsXG4gICAgICB9KSxcbiAgICB9KTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnaXNzdWluZyBcIkRlbGV0ZVdlYmhvb2tcIiByZXF1ZXN0Jyk7XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8RGVsZXRlV2ViaG9vay5SZXNwb25zZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy53ZWJob29rQ2xpZW50LkRlbGV0ZVdlYmhvb2soXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHtpbnRlcmNlcHRvcnM6IHRoaXMudW5hcnlJbnRlcmNlcHRvcnN9LFxuICAgICAgICAoZXJyLCBfcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgRGVsZXRlV2ViaG9vay5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IERlbGV0ZVdlYmhvb2suU3VjY2VzcygpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBsaXN0V2ViaG9va3MoY2FjaGU6IHN0cmluZyk6IFByb21pc2U8TGlzdFdlYmhvb2tzLlJlc3BvbnNlPiB7XG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRlQ2FjaGVOYW1lKGNhY2hlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IExpc3RXZWJob29rcy5FcnJvcihlcnIpXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IGdycGNXZWJob29rLl9MaXN0V2ViaG9va1JlcXVlc3Qoe2NhY2hlX25hbWU6IGNhY2hlfSk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoJ2lzc3VpbmcgXCJMaXN0V2ViaG9va3NcIiByZXF1ZXN0Jyk7XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8TGlzdFdlYmhvb2tzLlJlc3BvbnNlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLndlYmhvb2tDbGllbnQuTGlzdFdlYmhvb2tzKFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICB7aW50ZXJjZXB0b3JzOiB0aGlzLnVuYXJ5SW50ZXJjZXB0b3JzfSxcbiAgICAgICAgKGVyciwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIgfHwgIXJlc3ApIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgTGlzdFdlYmhvb2tzLkVycm9yKGUpLFxuICAgICAgICAgICAgICByZXNvbHZlRm46IHJlc29sdmUsXG4gICAgICAgICAgICAgIHJlamVjdEZuOiByZWplY3QsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3Qgd2ViaG9va3MgPSByZXNwLndlYmhvb2subWFwKHdoID0+IHtcbiAgICAgICAgICAgICAgY29uc3Qgd2ViaG9vazogV2ViaG9vayA9IHtcbiAgICAgICAgICAgICAgICBpZDoge1xuICAgICAgICAgICAgICAgICAgY2FjaGVOYW1lOiB3aC53ZWJob29rX2lkLmNhY2hlX25hbWUsXG4gICAgICAgICAgICAgICAgICB3ZWJob29rTmFtZTogd2gud2ViaG9va19pZC53ZWJob29rX25hbWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB0b3BpY05hbWU6IHdoLnRvcGljX25hbWUsXG4gICAgICAgICAgICAgICAgZGVzdGluYXRpb246IG5ldyBQb3N0VXJsV2ViaG9va0Rlc3RpbmF0aW9uKFxuICAgICAgICAgICAgICAgICAgd2guZGVzdGluYXRpb24ucG9zdF91cmxcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICByZXR1cm4gd2ViaG9vaztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgTGlzdFdlYmhvb2tzLlN1Y2Nlc3Mod2ViaG9va3MpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBwdXRXZWJob29rKHdlYmhvb2s6IFdlYmhvb2spOiBQcm9taXNlPFB1dFdlYmhvb2suUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVDYWNoZU5hbWUod2ViaG9vay5pZC5jYWNoZU5hbWUpO1xuICAgICAgdmFsaWRhdGVUb3BpY05hbWUod2ViaG9vay50b3BpY05hbWUpO1xuICAgICAgdmFsaWRhdGVXZWJob29rTmFtZSh3ZWJob29rLmlkLndlYmhvb2tOYW1lKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLnJldHVybk9yVGhyb3dFcnJvcihcbiAgICAgICAgZXJyIGFzIEVycm9yLFxuICAgICAgICBlcnIgPT4gbmV3IFB1dFdlYmhvb2suRXJyb3IoZXJyKVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IGdycGNXZWJob29rLl9QdXRXZWJob29rUmVxdWVzdCh7XG4gICAgICB3ZWJob29rOiBuZXcgZ3JwY1dlYmhvb2suX1dlYmhvb2soe1xuICAgICAgICB3ZWJob29rX2lkOiBuZXcgZ3JwY1dlYmhvb2suX1dlYmhvb2tJZCh7XG4gICAgICAgICAgY2FjaGVfbmFtZTogd2ViaG9vay5pZC5jYWNoZU5hbWUsXG4gICAgICAgICAgd2ViaG9va19uYW1lOiB3ZWJob29rLmlkLndlYmhvb2tOYW1lLFxuICAgICAgICB9KSxcbiAgICAgICAgZGVzdGluYXRpb246IG5ldyBncnBjV2ViaG9vay5fV2ViaG9va0Rlc3RpbmF0aW9uKHtcbiAgICAgICAgICBwb3N0X3VybDogd2ViaG9vay5kZXN0aW5hdGlvbi51cmwoKSxcbiAgICAgICAgfSksXG4gICAgICAgIHRvcGljX25hbWU6IHdlYmhvb2sudG9waWNOYW1lLFxuICAgICAgfSksXG4gICAgfSk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoJ2lzc3VpbmcgXCJQdXRXZWJob29rXCIgcmVxdWVzdCcpO1xuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPFB1dFdlYmhvb2suUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMud2ViaG9va0NsaWVudC5QdXRXZWJob29rKFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICB7aW50ZXJjZXB0b3JzOiB0aGlzLnVuYXJ5SW50ZXJjZXB0b3JzfSxcbiAgICAgICAgKGVyciwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIgfHwgIXJlc3ApIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgUHV0V2ViaG9vay5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IFB1dFdlYmhvb2suU3VjY2VzcyhyZXNwLnNlY3JldF9zdHJpbmcpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXRXZWJob29rU2VjcmV0KGlkOiBXZWJob29rSWQpOiBQcm9taXNlPEdldFdlYmhvb2tTZWNyZXQuUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgdmFsaWRhdGVDYWNoZU5hbWUoaWQuY2FjaGVOYW1lKTtcbiAgICAgIHZhbGlkYXRlV2ViaG9va05hbWUoaWQud2ViaG9va05hbWUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmV0dXJuT3JUaHJvd0Vycm9yKFxuICAgICAgICBlcnIgYXMgRXJyb3IsXG4gICAgICAgIGVyciA9PiBuZXcgR2V0V2ViaG9va1NlY3JldC5FcnJvcihlcnIpXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY1dlYmhvb2suX0dldFdlYmhvb2tTZWNyZXRSZXF1ZXN0KHtcbiAgICAgIHdlYmhvb2tfbmFtZTogaWQud2ViaG9va05hbWUsXG4gICAgICBjYWNoZV9uYW1lOiBpZC5jYWNoZU5hbWUsXG4gICAgfSk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoJ2lzc3VpbmcgXCJHZXRXZWJob29rU2VjcmV0XCIgcmVxdWVzdCcpO1xuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPEdldFdlYmhvb2tTZWNyZXQuUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMud2ViaG9va0NsaWVudC5HZXRXZWJob29rU2VjcmV0KFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICB7aW50ZXJjZXB0b3JzOiB0aGlzLnVuYXJ5SW50ZXJjZXB0b3JzfSxcbiAgICAgICAgKGVyciwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIgfHwgIXJlc3ApIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgR2V0V2ViaG9va1NlY3JldC5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc29sdmUoXG4gICAgICAgICAgICAgIG5ldyBHZXRXZWJob29rU2VjcmV0LlN1Y2Nlc3Moe1xuICAgICAgICAgICAgICAgIHNlY3JldDogcmVzcC5zZWNyZXRfc3RyaW5nLFxuICAgICAgICAgICAgICAgIHdlYmhvb2tOYW1lOiByZXNwLndlYmhvb2tfbmFtZSxcbiAgICAgICAgICAgICAgICBjYWNoZU5hbWU6IHJlc3AuY2FjaGVfbmFtZSxcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgcm90YXRlV2ViaG9va1NlY3JldChcbiAgICBpZDogV2ViaG9va0lkXG4gICk6IFByb21pc2U8Um90YXRlV2ViaG9va1NlY3JldC5SZXNwb25zZT4ge1xuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZUNhY2hlTmFtZShpZC5jYWNoZU5hbWUpO1xuICAgICAgdmFsaWRhdGVXZWJob29rTmFtZShpZC53ZWJob29rTmFtZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXR1cm5PclRocm93RXJyb3IoXG4gICAgICAgIGVyciBhcyBFcnJvcixcbiAgICAgICAgZXJyID0+IG5ldyBSb3RhdGVXZWJob29rU2VjcmV0LkVycm9yKGVycilcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3Qgd2ViaG9va0lkID0gZ3JwY1dlYmhvb2suX1dlYmhvb2tJZC5mcm9tT2JqZWN0KHtcbiAgICAgIHdlYmhvb2tfbmFtZTogaWQud2ViaG9va05hbWUsXG4gICAgICBjYWNoZV9uYW1lOiBpZC5jYWNoZU5hbWUsXG4gICAgfSk7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBncnBjV2ViaG9vay5fUm90YXRlV2ViaG9va1NlY3JldFJlcXVlc3Qoe1xuICAgICAgd2ViaG9va19pZDogd2ViaG9va0lkLFxuICAgIH0pO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdpc3N1aW5nIFwiUm90YXRlV2ViaG9va1NlY3JldFwiIHJlcXVlc3QnKTtcblxuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZTxSb3RhdGVXZWJob29rU2VjcmV0LlJlc3BvbnNlPihcbiAgICAgIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdGhpcy53ZWJob29rQ2xpZW50LlJvdGF0ZVdlYmhvb2tTZWNyZXQoXG4gICAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgICB7aW50ZXJjZXB0b3JzOiB0aGlzLnVuYXJ5SW50ZXJjZXB0b3JzfSxcbiAgICAgICAgICAoZXJyLCByZXNwKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyIHx8ICFyZXNwKSB7XG4gICAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICAgIGVycjogZXJyLFxuICAgICAgICAgICAgICAgIGVycm9yUmVzcG9uc2VGYWN0b3J5Rm46IGUgPT4gbmV3IFJvdGF0ZVdlYmhvb2tTZWNyZXQuRXJyb3IoZSksXG4gICAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICAgIHJlamVjdEZuOiByZWplY3QsXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZShcbiAgICAgICAgICAgICAgICBuZXcgUm90YXRlV2ViaG9va1NlY3JldC5TdWNjZXNzKHtcbiAgICAgICAgICAgICAgICAgIHNlY3JldDogcmVzcC5zZWNyZXRfc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgd2ViaG9va05hbWU6IGlkLndlYmhvb2tOYW1lLFxuICAgICAgICAgICAgICAgICAgY2FjaGVOYW1lOiBpZC5jYWNoZU5hbWUsXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxufVxuIl19