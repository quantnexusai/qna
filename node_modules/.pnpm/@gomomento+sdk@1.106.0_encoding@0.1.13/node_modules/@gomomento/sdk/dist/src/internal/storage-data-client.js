"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.StorageDataClient = void 0;
const sdk_core_1 = require("@gomomento/sdk-core");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const store_1 = require("@gomomento/generated-types/dist/store");
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const grpc_js_1 = require("@grpc/grpc-js");
const package_json_1 = require("../../package.json");
const grpc_channel_options_1 = require("./grpc/grpc-channel-options");
const cache_1 = require("../config/transport/cache");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const retry_interceptor_1 = require("./grpc/retry-interceptor");
class StorageDataClient {
    /**
     * @param {StorageClientAllProps} props
     */
    constructor(props) {
        this.configuration = props.configuration;
        this.credentialProvider = props.credentialProvider;
        this.cacheServiceErrorMapper = new cache_service_error_mapper_1.CacheServiceErrorMapper(false);
        this.logger = this.configuration.getLoggerFactory().getLogger(this);
        this.requestTimeoutMs = this.configuration
            .getTransportStrategy()
            .getGrpcConfig()
            .getDeadlineMillis();
        this.validateRequestTimeout(this.requestTimeoutMs);
        this.logger.debug(`Creating storage client using endpoint: '${this.credentialProvider.getStorageEndpoint()}'`);
        // NOTE: This is hard-coded for now but we may want to expose it via StorageConfiguration in the
        // future, as we do with some of the other clients.
        const grpcConfig = new cache_1.StaticGrpcConfiguration({
            deadlineMillis: this.configuration
                .getTransportStrategy()
                .getGrpcConfig()
                .getDeadlineMillis(),
            maxSessionMemoryMb: StorageDataClient.DEFAULT_MAX_SESSION_MEMORY_MB,
        });
        const channelOptions = (0, grpc_channel_options_1.grpcChannelOptionsFromGrpcConfig)(grpcConfig);
        this.client = new store_1.store.StoreClient(this.credentialProvider.getStorageEndpoint(), this.credentialProvider.isStorageEndpointSecure()
            ? grpc_js_1.ChannelCredentials.createSsl()
            : grpc_js_1.ChannelCredentials.createInsecure(), channelOptions);
        this.interceptors = this.initializeInterceptors(this.configuration.getLoggerFactory());
    }
    close() {
        this.logger.debug('Closing storage data clients');
        this.client.close();
    }
    validateRequestTimeout(timeout) {
        this.logger.debug(`Request timeout ms: ${String(timeout)}`);
        if (timeout !== undefined && timeout <= 0) {
            throw new sdk_core_1.InvalidArgumentError('request timeout must be greater than zero.');
        }
    }
    validateStoreNameOrThrowError(storeName) {
        try {
            (0, utils_1.validateStoreName)(storeName);
            return;
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.StoragePut.Error(err));
        }
    }
    initializeInterceptors(_loggerFactory) {
        const headers = [
            new headers_interceptor_1.Header('Authorization', this.credentialProvider.getAuthToken()),
            new headers_interceptor_1.Header('agent', `nodejs:store:${package_json_1.version}`),
            new headers_interceptor_1.Header('runtime-version', `nodejs:${process.versions.node}`),
        ];
        return [
            headers_interceptor_1.HeaderInterceptor.createHeadersInterceptor(headers),
            retry_interceptor_1.RetryInterceptor.createRetryInterceptor({
                clientName: 'StorageDataClient',
                loggerFactory: this.configuration.getLoggerFactory(),
                retryStrategy: this.configuration.getRetryStrategy(),
                overallRequestTimeoutMs: this.requestTimeoutMs,
            }),
        ];
    }
    createMetadata(storeName) {
        const metadata = new grpc_js_1.Metadata();
        metadata.set('store', storeName);
        return metadata;
    }
    async get(storeName, key) {
        try {
            (0, utils_1.validateStoreName)(storeName);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.StorageGet.Error(err));
        }
        this.logger.trace(`Issuing 'get' request; store: ${storeName}, key: ${key}`);
        return await this.sendGet(storeName, key);
    }
    async sendGet(storeName, key) {
        const request = new store_1.store._StoreGetRequest({
            key: key,
        });
        const metadata = this.createMetadata(storeName);
        return await new Promise((resolve, reject) => {
            this.client.Get(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                var _a;
                const value = (_a = resp === null || resp === void 0 ? void 0 : resp.value) === null || _a === void 0 ? void 0 : _a.value;
                if (value) {
                    switch (value) {
                        case 'double_value': {
                            return resolve(sdk_core_1.StorageGet.Found.ofDouble(resp.value.double_value));
                        }
                        case 'string_value': {
                            return resolve(sdk_core_1.StorageGet.Found.ofString(resp.value.string_value));
                        }
                        case 'bytes_value': {
                            return resolve(sdk_core_1.StorageGet.Found.ofBytes(resp.value.bytes_value));
                        }
                        case 'integer_value': {
                            return resolve(sdk_core_1.StorageGet.Found.ofInt(resp.value.integer_value));
                        }
                        case 'none': {
                            return resolve(new sdk_core_1.StorageGet.Error(new sdk_core_1.UnknownError('StorageGet responded with an unknown result')));
                        }
                    }
                }
                else {
                    const sdkError = this.cacheServiceErrorMapper.convertError(err);
                    if (sdkError.errorCode() ===
                        sdk_core_1.MomentoErrorCode.STORE_ITEM_NOT_FOUND_ERROR) {
                        return resolve(new sdk_core_1.StorageGet.NotFound());
                    }
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.StorageGet.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async putInt(storeName, key, value) {
        this.validateStoreNameOrThrowError(storeName);
        this.logger.trace(`Issuing 'put' request; store: ${storeName}, key: ${key}`);
        const storeValue = new store_1.store._StoreValue({ integer_value: value });
        return await this.sendPut(storeName, key, storeValue);
    }
    async putDouble(storeName, key, value) {
        this.validateStoreNameOrThrowError(storeName);
        this.logger.trace(`Issuing 'put' request; store: ${storeName}, key: ${key}`);
        const storeValue = new store_1.store._StoreValue({ double_value: value });
        return await this.sendPut(storeName, key, storeValue);
    }
    async putString(storeName, key, value) {
        this.validateStoreNameOrThrowError(storeName);
        this.logger.trace(`Issuing 'put' request; store: ${storeName}, key: ${key}`);
        const storeValue = new store_1.store._StoreValue({ string_value: value });
        return await this.sendPut(storeName, key, storeValue);
    }
    async putBytes(storeName, key, value) {
        this.validateStoreNameOrThrowError(storeName);
        this.logger.trace(`Issuing 'put' request; store: ${storeName}, key: ${key}`);
        const storeValue = new store_1.store._StoreValue({ bytes_value: value });
        return await this.sendPut(storeName, key, storeValue);
    }
    async sendPut(storeName, key, storeValue) {
        const request = new store_1.store._StorePutRequest({
            key: key,
            value: storeValue,
        });
        const metadata = this.createMetadata(storeName);
        return await new Promise((resolve, reject) => {
            this.client.Put(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.StoragePut.Success());
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.StoragePut.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    async delete(storeName, key) {
        try {
            (0, utils_1.validateStoreName)(storeName);
        }
        catch (err) {
            return this.cacheServiceErrorMapper.returnOrThrowError(err, err => new sdk_core_1.StorageDelete.Error(err));
        }
        this.logger.trace(`Issuing 'delete' request; store: ${storeName}, key: ${key}`);
        return await this.sendDelete(storeName, key);
    }
    async sendDelete(storeName, key) {
        const request = new store_1.store._StoreDeleteRequest({
            key: key,
        });
        const metadata = this.createMetadata(storeName);
        return await new Promise((resolve, reject) => {
            this.client.Delete(request, metadata, {
                interceptors: this.interceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new sdk_core_1.StorageDelete.Success());
                }
                else {
                    this.cacheServiceErrorMapper.resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new sdk_core_1.StorageDelete.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
}
exports.StorageDataClient = StorageDataClient;
StorageDataClient.DEFAULT_MAX_SESSION_MEMORY_MB = 256;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS1kYXRhLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbnRlcm5hbC9zdG9yYWdlLWRhdGEtY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGtEQVU2QjtBQUM3Qix1RUFBOEU7QUFDOUUsaUVBQTREO0FBQzVELG9FQUFxRTtBQUNyRSwyQ0FLdUI7QUFDdkIscURBQTJDO0FBQzNDLHNFQUE2RTtBQUk3RSxxREFBa0U7QUFDbEUscUZBQTZFO0FBQzdFLGdFQUEwRDtBQUUxRCxNQUFhLGlCQUFpQjtJQVU1Qjs7T0FFRztJQUNILFlBQVksS0FBNEI7UUFDdEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUM7UUFDbkQsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksb0RBQXVCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbEUsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BFLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsYUFBYTthQUN2QyxvQkFBb0IsRUFBRTthQUN0QixhQUFhLEVBQUU7YUFDZixpQkFBaUIsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDZiw0Q0FBNEMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGtCQUFrQixFQUFFLEdBQUcsQ0FDNUYsQ0FBQztRQUVGLGdHQUFnRztRQUNoRyxtREFBbUQ7UUFDbkQsTUFBTSxVQUFVLEdBQUcsSUFBSSwrQkFBdUIsQ0FBQztZQUM3QyxjQUFjLEVBQUUsSUFBSSxDQUFD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LEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNoRCxPQUFPLE1BQU0sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDM0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQ2hCLE9BQU8sRUFDUCxRQUFRLEVBQ1I7Z0JBQ0UsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO2FBQ2hDLEVBQ0QsQ0FBQyxHQUF3QixFQUFFLElBQUksRUFBRSxFQUFFO2dCQUNqQyxJQUFJLElBQUksRUFBRTtvQkFDUixPQUFPLENBQUMsSUFBSSx3QkFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7aUJBQ3RDO3FCQUFNO29CQUNMLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxvQkFBb0IsQ0FBQzt3QkFDaEQsR0FBRyxFQUFFLEdBQUc7d0JBQ1Isc0JBQXNCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLHdCQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQzt3QkFDdkQsU0FBUyxFQUFFLE9BQU87d0JBQ2xCLFFBQVEsRUFBRSxNQUFNO3FCQUNqQixDQUFDLENBQUM7aUJBQ0o7WUFDSCxDQUFDLENBQ0YsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7QUFoVUgsOENBaVVDO0FBelR5QiwrQ0FBNkIsR0FBVyxHQUFHLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDcmVkZW50aWFsUHJvdmlkZXIsXG4gIEludmFsaWRBcmd1bWVudEVycm9yLFxuICBNb21lbnRvRXJyb3JDb2RlLFxuICBNb21lbnRvTG9nZ2VyLFxuICBNb21lbnRvTG9nZ2VyRmFjdG9yeSxcbiAgU3RvcmFnZURlbGV0ZSxcbiAgU3RvcmFnZUdldCxcbiAgU3RvcmFnZVB1dCxcbiAgVW5rbm93bkVycm9yLFxufSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlJztcbmltcG9ydCB7dmFsaWRhdGVTdG9yZU5hbWV9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHtzdG9yZX0gZnJvbSAnQGdvbW9tZW50by9nZW5lcmF0ZWQtdHlwZXMvZGlzdC9zdG9yZSc7XG5pbXBvcnQge0hlYWRlciwgSGVhZGVySW50ZXJjZXB0b3J9IGZyb20gJy4vZ3JwYy9oZWFkZXJzLWludGVyY2VwdG9yJztcbmltcG9ydCB7XG4gIENoYW5uZWxDcmVkZW50aWFscyxcbiAgSW50ZXJjZXB0b3IsXG4gIE1ldGFkYXRhLFxuICBTZXJ2aWNlRXJyb3IsXG59IGZyb20gJ0BncnBjL2dycGMtanMnO1xuaW1wb3J0IHt2ZXJzaW9ufSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nO1xuaW1wb3J0IHtncnBjQ2hhbm5lbE9wdGlvbnNGcm9tR3JwY0NvbmZpZ30gZnJvbSAnLi9ncnBjL2dycGMtY2hhbm5lbC1vcHRpb25zJztcbmltcG9ydCB7SVN0b3JhZ2VEYXRhQ2xpZW50fSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2ludGVybmFsL2NsaWVudHMnO1xuaW1wb3J0IHtTdG9yYWdlQ29uZmlndXJhdGlvbn0gZnJvbSAnLi4vY29uZmlnL3N0b3JhZ2UtY29uZmlndXJhdGlvbic7XG5pbXBvcnQge1N0b3JhZ2VDbGllbnRBbGxQcm9wc30gZnJvbSAnLi9zdG9yYWdlLWNsaWVudC1hbGwtcHJvcHMnO1xuaW1wb3J0IHtTdGF0aWNHcnBjQ29uZmlndXJhdGlvbn0gZnJvbSAnLi4vY29uZmlnL3RyYW5zcG9ydC9jYWNoZSc7XG5pbXBvcnQge0NhY2hlU2VydmljZUVycm9yTWFwcGVyfSBmcm9tICcuLi9lcnJvcnMvY2FjaGUtc2VydmljZS1lcnJvci1tYXBwZXInO1xuaW1wb3J0IHtSZXRyeUludGVyY2VwdG9yfSBmcm9tICcuL2dycGMvcmV0cnktaW50ZXJjZXB0b3InO1xuXG5leHBvcnQgY2xhc3MgU3RvcmFnZURhdGFDbGllbnQgaW1wbGVtZW50cyBJU3RvcmFnZURhdGFDbGllbnQge1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ3VyYXRpb246IFN0b3JhZ2VDb25maWd1cmF0aW9uO1xuICBwcml2YXRlIHJlYWRvbmx5IGNyZWRlbnRpYWxQcm92aWRlcjogQ3JlZGVudGlhbFByb3ZpZGVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGNhY2hlU2VydmljZUVycm9yTWFwcGVyOiBDYWNoZVNlcnZpY2VFcnJvck1hcHBlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVxdWVzdFRpbWVvdXRNczogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGNsaWVudDogc3RvcmUuU3RvcmVDbGllbnQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgaW50ZXJjZXB0b3JzOiBJbnRlcmNlcHRvcltdO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBERUZBVUxUX01BWF9TRVNTSU9OX01FTU9SWV9NQjogbnVtYmVyID0gMjU2O1xuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1N0b3JhZ2VDbGllbnRBbGxQcm9wc30gcHJvcHNcbiAgICovXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBTdG9yYWdlQ2xpZW50QWxsUHJvcHMpIHtcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb24gPSBwcm9wcy5jb25maWd1cmF0aW9uO1xuICAgIHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyID0gcHJvcHMuY3JlZGVudGlhbFByb3ZpZGVyO1xuICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIgPSBuZXcgQ2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIoZmFsc2UpO1xuICAgIHRoaXMubG9nZ2VyID0gdGhpcy5jb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKS5nZXRMb2dnZXIodGhpcyk7XG4gICAgdGhpcy5yZXF1ZXN0VGltZW91dE1zID0gdGhpcy5jb25maWd1cmF0aW9uXG4gICAgICAuZ2V0VHJhbnNwb3J0U3RyYXRlZ3koKVxuICAgICAgLmdldEdycGNDb25maWcoKVxuICAgICAgLmdldERlYWRsaW5lTWlsbGlzKCk7XG4gICAgdGhpcy52YWxpZGF0ZVJlcXVlc3RUaW1lb3V0KHRoaXMucmVxdWVzdFRpbWVvdXRNcyk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICBgQ3JlYXRpbmcgc3RvcmFnZSBjbGllbnQgdXNpbmcgZW5kcG9pbnQ6ICcke3RoaXMuY3JlZGVudGlhbFByb3ZpZGVyLmdldFN0b3JhZ2VFbmRwb2ludCgpfSdgXG4gICAgKTtcblxuICAgIC8vIE5PVEU6IFRoaXMgaXMgaGFyZC1jb2RlZCBmb3Igbm93IGJ1dCB3ZSBtYXkgd2FudCB0byBleHBvc2UgaXQgdmlhIFN0b3JhZ2VDb25maWd1cmF0aW9uIGluIHRoZVxuICAgIC8vIGZ1dHVyZSwgYXMgd2UgZG8gd2l0aCBzb21lIG9mIHRoZSBvdGhlciBjbGllbnRzLlxuICAgIGNvbnN0IGdycGNDb25maWcgPSBuZXcgU3RhdGljR3JwY0NvbmZpZ3VyYXRpb24oe1xuICAgICAgZGVhZGxpbmVNaWxsaXM6IHRoaXMuY29uZmlndXJhdGlvblxuICAgICAgICAuZ2V0VHJhbnNwb3J0U3RyYXRlZ3koKVxuICAgICAgICAuZ2V0R3JwY0NvbmZpZygpXG4gICAgICAgIC5nZXREZWFkbGluZU1pbGxpcygpLFxuICAgICAgbWF4U2Vzc2lvbk1lbW9yeU1iOiBTdG9yYWdlRGF0YUNsaWVudC5ERUZBVUxUX01BWF9TRVNTSU9OX01FTU9SWV9NQixcbiAgICB9KTtcbiAgICBjb25zdCBjaGFubmVsT3B0aW9ucyA9IGdycGNDaGFubmVsT3B0aW9uc0Zyb21HcnBjQ29uZmlnKGdycGNDb25maWcpO1xuXG4gICAgdGhpcy5jbGllbnQgPSBuZXcgc3RvcmUuU3RvcmVDbGllbnQoXG4gICAgICB0aGlzLmNyZWRlbnRpYWxQcm92aWRlci5nZXRTdG9yYWdlRW5kcG9pbnQoKSxcbiAgICAgIHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyLmlzU3RvcmFnZUVuZHBvaW50U2VjdXJlKClcbiAgICAgICAgPyBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlU3NsKClcbiAgICAgICAgOiBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlSW5zZWN1cmUoKSxcbiAgICAgIGNoYW5uZWxPcHRpb25zXG4gICAgKTtcbiAgICB0aGlzLmludGVyY2VwdG9ycyA9IHRoaXMuaW5pdGlhbGl6ZUludGVyY2VwdG9ycyhcbiAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5nZXRMb2dnZXJGYWN0b3J5KClcbiAgICApO1xuICB9XG5cbiAgY2xvc2UoKSB7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoJ0Nsb3Npbmcgc3RvcmFnZSBkYXRhIGNsaWVudHMnKTtcbiAgICB0aGlzLmNsaWVudC5jbG9zZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVJlcXVlc3RUaW1lb3V0KHRpbWVvdXQ/OiBudW1iZXIpIHtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgUmVxdWVzdCB0aW1lb3V0IG1zOiAke1N0cmluZyh0aW1lb3V0KX1gKTtcbiAgICBpZiAodGltZW91dCAhPT0gdW5kZWZpbmVkICYmIHRpbWVvdXQgPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudEVycm9yKFxuICAgICAgICAncmVxdWVzdCB0aW1lb3V0IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uJ1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlU3RvcmVOYW1lT3JUaHJvd0Vycm9yKHN0b3JlTmFtZTogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRlU3RvcmVOYW1lKHN0b3JlTmFtZSk7XG4gICAgICByZXR1cm47XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXR1cm5PclRocm93RXJyb3IoXG4gICAgICAgIGVyciBhcyBFcnJvcixcbiAgICAgICAgZXJyID0+IG5ldyBTdG9yYWdlUHV0LkVycm9yKGVycilcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWFsaXplSW50ZXJjZXB0b3JzKFxuICAgIF9sb2dnZXJGYWN0b3J5OiBNb21lbnRvTG9nZ2VyRmFjdG9yeVxuICApOiBJbnRlcmNlcHRvcltdIHtcbiAgICBjb25zdCBoZWFkZXJzID0gW1xuICAgICAgbmV3IEhlYWRlcignQXV0aG9yaXphdGlvbicsIHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyLmdldEF1dGhUb2tlbigpKSxcbiAgICAgIG5ldyBIZWFkZXIoJ2FnZW50JywgYG5vZGVqczpzdG9yZToke3ZlcnNpb259YCksXG4gICAgICBuZXcgSGVhZGVyKCdydW50aW1lLXZlcnNpb24nLCBgbm9kZWpzOiR7cHJvY2Vzcy52ZXJzaW9ucy5ub2RlfWApLFxuICAgIF07XG4gICAgcmV0dXJuIFtcbiAgICAgIEhlYWRlckludGVyY2VwdG9yLmNyZWF0ZUhlYWRlcnNJbnRlcmNlcHRvcihoZWFkZXJzKSxcbiAgICAgIFJldHJ5SW50ZXJjZXB0b3IuY3JlYXRlUmV0cnlJbnRlcmNlcHRvcih7XG4gICAgICAgIGNsaWVudE5hbWU6ICdTdG9yYWdlRGF0YUNsaWVudCcsXG4gICAgICAgIGxvZ2dlckZhY3Rvcnk6IHRoaXMuY29uZmlndXJhdGlvbi5nZXRMb2dnZXJGYWN0b3J5KCksXG4gICAgICAgIHJldHJ5U3RyYXRlZ3k6IHRoaXMuY29uZmlndXJhdGlvbi5nZXRSZXRyeVN0cmF0ZWd5KCksXG4gICAgICAgIG92ZXJhbGxSZXF1ZXN0VGltZW91dE1zOiB0aGlzLnJlcXVlc3RUaW1lb3V0TXMsXG4gICAgICB9KSxcbiAgICBdO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVNZXRhZGF0YShzdG9yZU5hbWU6IHN0cmluZyk6IE1ldGFkYXRhIHtcbiAgICBjb25zdCBtZXRhZGF0YSA9IG5ldyBNZXRhZGF0YSgpO1xuICAgIG1ldGFkYXRhLnNldCgnc3RvcmUnLCBzdG9yZU5hbWUpO1xuICAgIHJldHVybiBtZXRhZGF0YTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXQoXG4gICAgc3RvcmVOYW1lOiBzdHJpbmcsXG4gICAga2V5OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxTdG9yYWdlR2V0LlJlc3BvbnNlPiB7XG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRlU3RvcmVOYW1lKHN0b3JlTmFtZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXR1cm5PclRocm93RXJyb3IoXG4gICAgICAgIGVyciBhcyBFcnJvcixcbiAgICAgICAgZXJyID0+IG5ldyBTdG9yYWdlR2V0LkVycm9yKGVycilcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMubG9nZ2VyLnRyYWNlKFxuICAgICAgYElzc3VpbmcgJ2dldCcgcmVxdWVzdDsgc3RvcmU6ICR7c3RvcmVOYW1lfSwga2V5OiAke2tleX1gXG4gICAgKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kR2V0KHN0b3JlTmFtZSwga2V5KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZEdldChcbiAgICBzdG9yZU5hbWU6IHN0cmluZyxcbiAgICBrZXk6IHN0cmluZ1xuICApOiBQcm9taXNlPFN0b3JhZ2VHZXQuUmVzcG9uc2U+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IHN0b3JlLl9TdG9yZUdldFJlcXVlc3Qoe1xuICAgICAga2V5OiBrZXksXG4gICAgfSk7XG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmNyZWF0ZU1ldGFkYXRhKHN0b3JlTmFtZSk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuY2xpZW50LkdldChcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgbWV0YWRhdGEsXG4gICAgICAgIHtcbiAgICAgICAgICBpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzLFxuICAgICAgICB9LFxuICAgICAgICAoZXJyOiBTZXJ2aWNlRXJyb3IgfCBudWxsLCByZXNwKSA9PiB7XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSByZXNwPy52YWx1ZT8udmFsdWU7XG4gICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICBzd2l0Y2ggKHZhbHVlKSB7XG4gICAgICAgICAgICAgIGNhc2UgJ2RvdWJsZV92YWx1ZSc6IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShcbiAgICAgICAgICAgICAgICAgIFN0b3JhZ2VHZXQuRm91bmQub2ZEb3VibGUocmVzcC52YWx1ZS5kb3VibGVfdmFsdWUpXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjYXNlICdzdHJpbmdfdmFsdWUnOiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoXG4gICAgICAgICAgICAgICAgICBTdG9yYWdlR2V0LkZvdW5kLm9mU3RyaW5nKHJlc3AudmFsdWUuc3RyaW5nX3ZhbHVlKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgY2FzZSAnYnl0ZXNfdmFsdWUnOiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoXG4gICAgICAgICAgICAgICAgICBTdG9yYWdlR2V0LkZvdW5kLm9mQnl0ZXMocmVzcC52YWx1ZS5ieXRlc192YWx1ZSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGNhc2UgJ2ludGVnZXJfdmFsdWUnOiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoXG4gICAgICAgICAgICAgICAgICBTdG9yYWdlR2V0LkZvdW5kLm9mSW50KHJlc3AudmFsdWUuaW50ZWdlcl92YWx1ZSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGNhc2UgJ25vbmUnOiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoXG4gICAgICAgICAgICAgICAgICBuZXcgU3RvcmFnZUdldC5FcnJvcihcbiAgICAgICAgICAgICAgICAgICAgbmV3IFVua25vd25FcnJvcihcbiAgICAgICAgICAgICAgICAgICAgICAnU3RvcmFnZUdldCByZXNwb25kZWQgd2l0aCBhbiB1bmtub3duIHJlc3VsdCdcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3Qgc2RrRXJyb3IgPSB0aGlzLmNhY2hlU2VydmljZUVycm9yTWFwcGVyLmNvbnZlcnRFcnJvcihlcnIpO1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICBzZGtFcnJvci5lcnJvckNvZGUoKSA9PT1cbiAgICAgICAgICAgICAgTW9tZW50b0Vycm9yQ29kZS5TVE9SRV9JVEVNX05PVF9GT1VORF9FUlJPUlxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKG5ldyBTdG9yYWdlR2V0Lk5vdEZvdW5kKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXNvbHZlT3JSZWplY3RFcnJvcih7XG4gICAgICAgICAgICAgIGVycjogZXJyLFxuICAgICAgICAgICAgICBlcnJvclJlc3BvbnNlRmFjdG9yeUZuOiBlID0+IG5ldyBTdG9yYWdlR2V0LkVycm9yKGUpLFxuICAgICAgICAgICAgICByZXNvbHZlRm46IHJlc29sdmUsXG4gICAgICAgICAgICAgIHJlamVjdEZuOiByZWplY3QsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcHV0SW50KFxuICAgIHN0b3JlTmFtZTogc3RyaW5nLFxuICAgIGtleTogc3RyaW5nLFxuICAgIHZhbHVlOiBudW1iZXJcbiAgKTogUHJvbWlzZTxTdG9yYWdlUHV0LlJlc3BvbnNlPiB7XG4gICAgdGhpcy52YWxpZGF0ZVN0b3JlTmFtZU9yVGhyb3dFcnJvcihzdG9yZU5hbWUpO1xuICAgIHRoaXMubG9nZ2VyLnRyYWNlKFxuICAgICAgYElzc3VpbmcgJ3B1dCcgcmVxdWVzdDsgc3RvcmU6ICR7c3RvcmVOYW1lfSwga2V5OiAke2tleX1gXG4gICAgKTtcbiAgICBjb25zdCBzdG9yZVZhbHVlID0gbmV3IHN0b3JlLl9TdG9yZVZhbHVlKHtpbnRlZ2VyX3ZhbHVlOiB2YWx1ZX0pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRQdXQoc3RvcmVOYW1lLCBrZXksIHN0b3JlVmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHB1dERvdWJsZShcbiAgICBzdG9yZU5hbWU6IHN0cmluZyxcbiAgICBrZXk6IHN0cmluZyxcbiAgICB2YWx1ZTogbnVtYmVyXG4gICk6IFByb21pc2U8U3RvcmFnZVB1dC5SZXNwb25zZT4ge1xuICAgIHRoaXMudmFsaWRhdGVTdG9yZU5hbWVPclRocm93RXJyb3Ioc3RvcmVOYW1lKTtcbiAgICB0aGlzLmxvZ2dlci50cmFjZShcbiAgICAgIGBJc3N1aW5nICdwdXQnIHJlcXVlc3Q7IHN0b3JlOiAke3N0b3JlTmFtZX0sIGtleTogJHtrZXl9YFxuICAgICk7XG4gICAgY29uc3Qgc3RvcmVWYWx1ZSA9IG5ldyBzdG9yZS5fU3RvcmVWYWx1ZSh7ZG91YmxlX3ZhbHVlOiB2YWx1ZX0pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRQdXQoc3RvcmVOYW1lLCBrZXksIHN0b3JlVmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHB1dFN0cmluZyhcbiAgICBzdG9yZU5hbWU6IHN0cmluZyxcbiAgICBrZXk6IHN0cmluZyxcbiAgICB2YWx1ZTogc3RyaW5nXG4gICk6IFByb21pc2U8U3RvcmFnZVB1dC5SZXNwb25zZT4ge1xuICAgIHRoaXMudmFsaWRhdGVTdG9yZU5hbWVPclRocm93RXJyb3Ioc3RvcmVOYW1lKTtcbiAgICB0aGlzLmxvZ2dlci50cmFjZShcbiAgICAgIGBJc3N1aW5nICdwdXQnIHJlcXVlc3Q7IHN0b3JlOiAke3N0b3JlTmFtZX0sIGtleTogJHtrZXl9YFxuICAgICk7XG4gICAgY29uc3Qgc3RvcmVWYWx1ZSA9IG5ldyBzdG9yZS5fU3RvcmVWYWx1ZSh7c3RyaW5nX3ZhbHVlOiB2YWx1ZX0pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRQdXQoc3RvcmVOYW1lLCBrZXksIHN0b3JlVmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHB1dEJ5dGVzKFxuICAgIHN0b3JlTmFtZTogc3RyaW5nLFxuICAgIGtleTogc3RyaW5nLFxuICAgIHZhbHVlOiBVaW50OEFycmF5XG4gICk6IFByb21pc2U8U3RvcmFnZVB1dC5SZXNwb25zZT4ge1xuICAgIHRoaXMudmFsaWRhdGVTdG9yZU5hbWVPclRocm93RXJyb3Ioc3RvcmVOYW1lKTtcbiAgICB0aGlzLmxvZ2dlci50cmFjZShcbiAgICAgIGBJc3N1aW5nICdwdXQnIHJlcXVlc3Q7IHN0b3JlOiAke3N0b3JlTmFtZX0sIGtleTogJHtrZXl9YFxuICAgICk7XG4gICAgY29uc3Qgc3RvcmVWYWx1ZSA9IG5ldyBzdG9yZS5fU3RvcmVWYWx1ZSh7Ynl0ZXNfdmFsdWU6IHZhbHVlfSk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZFB1dChzdG9yZU5hbWUsIGtleSwgc3RvcmVWYWx1ZSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmRQdXQoXG4gICAgc3RvcmVOYW1lOiBzdHJpbmcsXG4gICAga2V5OiBzdHJpbmcsXG4gICAgc3RvcmVWYWx1ZTogc3RvcmUuX1N0b3JlVmFsdWVcbiAgKTogUHJvbWlzZTxTdG9yYWdlUHV0LlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBzdG9yZS5fU3RvcmVQdXRSZXF1ZXN0KHtcbiAgICAgIGtleToga2V5LFxuICAgICAgdmFsdWU6IHN0b3JlVmFsdWUsXG4gICAgfSk7XG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmNyZWF0ZU1ldGFkYXRhKHN0b3JlTmFtZSk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuY2xpZW50LlB1dChcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgbWV0YWRhdGEsXG4gICAgICAgIHtcbiAgICAgICAgICBpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzLFxuICAgICAgICB9LFxuICAgICAgICAoZXJyOiBTZXJ2aWNlRXJyb3IgfCBudWxsLCByZXNwKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3ApIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IFN0b3JhZ2VQdXQuU3VjY2VzcygpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jYWNoZVNlcnZpY2VFcnJvck1hcHBlci5yZXNvbHZlT3JSZWplY3RFcnJvcih7XG4gICAgICAgICAgICAgIGVycjogZXJyLFxuICAgICAgICAgICAgICBlcnJvclJlc3BvbnNlRmFjdG9yeUZuOiBlID0+IG5ldyBTdG9yYWdlUHV0LkVycm9yKGUpLFxuICAgICAgICAgICAgICByZXNvbHZlRm46IHJlc29sdmUsXG4gICAgICAgICAgICAgIHJlamVjdEZuOiByZWplY3QsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlKFxuICAgIHN0b3JlTmFtZTogc3RyaW5nLFxuICAgIGtleTogc3RyaW5nXG4gICk6IFByb21pc2U8U3RvcmFnZURlbGV0ZS5SZXNwb25zZT4ge1xuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZVN0b3JlTmFtZShzdG9yZU5hbWUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmV0dXJuT3JUaHJvd0Vycm9yKFxuICAgICAgICBlcnIgYXMgRXJyb3IsXG4gICAgICAgIGVyciA9PiBuZXcgU3RvcmFnZURlbGV0ZS5FcnJvcihlcnIpXG4gICAgICApO1xuICAgIH1cbiAgICB0aGlzLmxvZ2dlci50cmFjZShcbiAgICAgIGBJc3N1aW5nICdkZWxldGUnIHJlcXVlc3Q7IHN0b3JlOiAke3N0b3JlTmFtZX0sIGtleTogJHtrZXl9YFxuICAgICk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZERlbGV0ZShzdG9yZU5hbWUsIGtleSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmREZWxldGUoXG4gICAgc3RvcmVOYW1lOiBzdHJpbmcsXG4gICAga2V5OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxTdG9yYWdlRGVsZXRlLlJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBzdG9yZS5fU3RvcmVEZWxldGVSZXF1ZXN0KHtcbiAgICAgIGtleToga2V5LFxuICAgIH0pO1xuICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5jcmVhdGVNZXRhZGF0YShzdG9yZU5hbWUpO1xuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmNsaWVudC5EZWxldGUoXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIG1ldGFkYXRhLFxuICAgICAgICB7XG4gICAgICAgICAgaW50ZXJjZXB0b3JzOiB0aGlzLmludGVyY2VwdG9ycyxcbiAgICAgICAgfSxcbiAgICAgICAgKGVycjogU2VydmljZUVycm9yIHwgbnVsbCwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChyZXNwKSB7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBTdG9yYWdlRGVsZXRlLlN1Y2Nlc3MoKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgU3RvcmFnZURlbGV0ZS5FcnJvcihlKSxcbiAgICAgICAgICAgICAgcmVzb2x2ZUZuOiByZXNvbHZlLFxuICAgICAgICAgICAgICByZWplY3RGbjogcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG59XG4iXX0=