"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "DefaultContextGenerator", {
    enumerable: true,
    get: function() {
        return DefaultContextGenerator;
    }
});
const _Prompt = require("../../Prompt.js");
const _index = require("../../prompts/index.js");
const _utils = require("../../synthesizers/utils.js");
class DefaultContextGenerator extends _index.PromptMixin {
    retriever;
    contextSystemPrompt;
    nodePostprocessors;
    contextRole;
    constructor(init){
        super();
        this.retriever = init.retriever;
        this.contextSystemPrompt = init?.contextSystemPrompt ?? _Prompt.defaultContextSystemPrompt;
        this.nodePostprocessors = init.nodePostprocessors || [];
        this.contextRole = init.contextRole ?? "system";
    }
    _getPrompts() {
        return {
            contextSystemPrompt: this.contextSystemPrompt
        };
    }
    _updatePrompts(promptsDict) {
        if (promptsDict.contextSystemPrompt) {
            this.contextSystemPrompt = promptsDict.contextSystemPrompt;
        }
    }
    async applyNodePostprocessors(nodes, query) {
        let nodesWithScore = nodes;
        for (const postprocessor of this.nodePostprocessors){
            nodesWithScore = await postprocessor.postprocessNodes(nodesWithScore, query);
        }
        return nodesWithScore;
    }
    async generate(message) {
        const sourceNodesWithScore = await this.retriever.retrieve({
            query: message
        });
        const nodes = await this.applyNodePostprocessors(sourceNodesWithScore, message);
        const content = await (0, _utils.createMessageContent)(this.contextSystemPrompt, nodes.map((r)=>r.node));
        return {
            message: {
                content,
                role: this.contextRole
            },
            nodes
        };
    }
}
