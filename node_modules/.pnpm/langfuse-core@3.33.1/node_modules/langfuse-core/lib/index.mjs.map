{"version":3,"file":"index.mjs","sources":["../src/eventemitter.ts","../src/prompts/promptCache.ts","../src/prompts/promptClients.ts","../src/utils.ts","../src/release-env.ts","../src/types.ts","../src/media/LangfuseMedia.ts","../src/storage-memory.ts","../src/index.ts"],"sourcesContent":["export class SimpleEventEmitter {\n  events: { [key: string]: ((...args: any[]) => void)[] } = {};\n\n  constructor() {\n    this.events = {};\n  }\n\n  on(event: string, listener: (...args: any[]) => void): () => void {\n    if (!this.events[event]) {\n      this.events[event] = [];\n    }\n    this.events[event].push(listener);\n\n    return () => {\n      this.events[event] = this.events[event].filter((x) => x !== listener);\n    };\n  }\n\n  emit(event: string, payload: any): void {\n    for (const listener of this.events[event] || []) {\n      listener(payload);\n    }\n    for (const listener of this.events[\"*\"] || []) {\n      listener(event, payload);\n    }\n  }\n}\n","import type { LangfusePromptClient } from \"./promptClients\";\n\nexport const DEFAULT_PROMPT_CACHE_TTL_SECONDS = 60;\n\nclass LangfusePromptCacheItem {\n  private _expiry: number;\n\n  constructor(\n    public value: LangfusePromptClient,\n    ttlSeconds: number\n  ) {\n    this._expiry = Date.now() + ttlSeconds * 1000;\n  }\n\n  get isExpired(): boolean {\n    return Date.now() > this._expiry;\n  }\n}\nexport class LangfusePromptCache {\n  private _cache: Map<string, LangfusePromptCacheItem>;\n  private _defaultTtlSeconds: number;\n  private _refreshingKeys: Map<string, Promise<void>>;\n\n  constructor() {\n    this._cache = new Map<string, LangfusePromptCacheItem>();\n    this._defaultTtlSeconds = DEFAULT_PROMPT_CACHE_TTL_SECONDS;\n    this._refreshingKeys = new Map<string, Promise<void>>();\n  }\n\n  public getIncludingExpired(key: string): LangfusePromptCacheItem | null {\n    return this._cache.get(key) ?? null;\n  }\n\n  public set(key: string, value: LangfusePromptClient, ttlSeconds?: number): void {\n    const effectiveTtlSeconds = ttlSeconds ?? this._defaultTtlSeconds;\n    this._cache.set(key, new LangfusePromptCacheItem(value, effectiveTtlSeconds));\n  }\n\n  public addRefreshingPromise(key: string, promise: Promise<any>): void {\n    this._refreshingKeys.set(key, promise);\n    promise\n      .then(() => {\n        this._refreshingKeys.delete(key);\n      })\n      .catch(() => {\n        this._refreshingKeys.delete(key);\n      });\n  }\n\n  public isRefreshing(key: string): boolean {\n    return this._refreshingKeys.has(key);\n  }\n\n  public invalidate(promptName: string): void {\n    console.log(\"invalidating\", promptName, this._cache.keys());\n    for (const key of this._cache.keys()) {\n      if (key.startsWith(promptName)) {\n        this._cache.delete(key);\n      }\n    }\n  }\n}\n","import mustache from \"mustache\";\n\nimport type { ChatMessage, ChatPrompt, CreateLangfusePromptResponse, TextPrompt } from \"../types\";\n\nmustache.escape = function (text) {\n  return text;\n};\n\nabstract class BasePromptClient {\n  public readonly name: string;\n  public readonly version: number;\n  public readonly config: unknown;\n  public readonly labels: string[];\n  public readonly tags: string[];\n  public readonly isFallback: boolean;\n  public readonly type: \"text\" | \"chat\";\n  public readonly prompt: string | ChatMessage[];\n\n  constructor(prompt: CreateLangfusePromptResponse, isFallback = false, type: \"text\" | \"chat\") {\n    this.name = prompt.name;\n    this.version = prompt.version;\n    this.config = prompt.config;\n    this.labels = prompt.labels;\n    this.tags = prompt.tags;\n    this.isFallback = isFallback;\n    this.type = type;\n    this.prompt = prompt.prompt;\n  }\n\n  abstract compile(variables?: Record<string, string>): string | ChatMessage[];\n\n  public abstract getLangchainPrompt(): string | ChatMessage[];\n\n  protected _transformToLangchainVariables(content: string): string {\n    return content.replace(/\\{\\{(.*?)\\}\\}/g, \"{$1}\");\n  }\n\n  public toJSON(): string {\n    return JSON.stringify({\n      name: this.name,\n      prompt: this.prompt,\n      version: this.version,\n      isFallback: this.isFallback,\n      tags: this.tags,\n      labels: this.labels,\n      type: this.type,\n      config: this.config,\n    });\n  }\n}\n\nexport class TextPromptClient extends BasePromptClient {\n  public readonly promptResponse: TextPrompt;\n  public readonly prompt: string;\n\n  constructor(prompt: TextPrompt, isFallback = false) {\n    super(prompt, isFallback, \"text\");\n    this.promptResponse = prompt;\n    this.prompt = prompt.prompt;\n  }\n\n  compile(variables?: Record<string, string>): string {\n    return mustache.render(this.promptResponse.prompt, variables ?? {});\n  }\n\n  public getLangchainPrompt(): string {\n    /**\n     * Converts Langfuse prompt into string compatible with Langchain PromptTemplate.\n     *\n     * It specifically adapts the mustache-style double curly braces {{variable}} used in Langfuse\n     * to the single curly brace {variable} format expected by Langchain.\n     *\n     * @returns {string} The string that can be plugged into Langchain's PromptTemplate.\n     */\n    return this._transformToLangchainVariables(this.prompt);\n  }\n}\n\nexport class ChatPromptClient extends BasePromptClient {\n  public readonly promptResponse: ChatPrompt;\n  public readonly prompt: ChatMessage[];\n\n  constructor(prompt: ChatPrompt, isFallback = false) {\n    super(prompt, isFallback, \"chat\");\n    this.promptResponse = prompt;\n    this.prompt = prompt.prompt;\n  }\n\n  compile(variables?: Record<string, string>): ChatMessage[] {\n    return this.prompt.map<ChatMessage>((chatMessage) => ({\n      ...chatMessage,\n      content: mustache.render(chatMessage.content, variables ?? {}),\n    }));\n  }\n\n  public getLangchainPrompt(): ChatMessage[] {\n    /**\n     * Converts Langfuse prompt into string compatible with Langchain PromptTemplate.\n     *\n     * It specifically adapts the mustache-style double curly braces {{variable}} used in Langfuse\n     * to the single curly brace {variable} format expected by Langchain.\n     * Example usage:\n     *\n     * ```\n     * import { ChatPromptTemplate } from \"@langchain/core/prompts\";\n     *\n     * const langchainChatPrompt = ChatPromptTemplate.fromMessages(\n     *    langfuseChatPrompt.getLangchainPrompt().map((m) => [m.role, m.content])\n     *  );\n     *\n     * const formattedPrompt = await langchainPrompt.format(values);\n     *\n     * ```\n     * @returns {ChatMessage[]} Chat messages with variables that can be plugged into Langchain's ChatPromptTemplate.\n     */\n    return this.prompt.map((chatMessage) => ({\n      ...chatMessage,\n      content: this._transformToLangchainVariables(chatMessage.content),\n    }));\n  }\n}\n\nexport type LangfusePromptClient = TextPromptClient | ChatPromptClient;\n","import { type LangfuseCoreOptions } from \"./types\";\n\nexport function assert(truthyValue: any, message: string): void {\n  if (!truthyValue) {\n    throw new Error(message);\n  }\n}\n\nexport function removeTrailingSlash(url: string): string {\n  return url?.replace(/\\/+$/, \"\");\n}\n\nexport interface RetriableOptions {\n  retryCount?: number;\n  retryDelay?: number;\n  retryCheck?: (err: any) => boolean;\n}\n\nexport async function retriable<T>(\n  fn: () => Promise<T>,\n  props: RetriableOptions = {},\n  log: (msg: string) => void\n): Promise<T> {\n  const { retryCount = 3, retryDelay = 5000, retryCheck = () => true } = props;\n  let lastError = null;\n\n  for (let i = 0; i < retryCount + 1; i++) {\n    if (i > 0) {\n      // don't wait when it's the first try\n      await new Promise((resolve) => setTimeout(resolve, retryDelay));\n      log(`Retrying ${i + 1} of ${retryCount + 1}`);\n    }\n\n    try {\n      const res = await fn();\n      return res;\n    } catch (e) {\n      lastError = e;\n      if (!retryCheck(e)) {\n        throw e;\n      }\n      log(`Retriable error: ${JSON.stringify(e)}`);\n    }\n  }\n\n  throw lastError;\n}\n\n// https://stackoverflow.com/a/8809472\nexport function generateUUID(globalThis?: any): string {\n  // Public Domain/MIT\n  let d = new Date().getTime(); //Timestamp\n  let d2 =\n    (globalThis && globalThis.performance && globalThis.performance.now && globalThis.performance.now() * 1000) || 0; //Time in microseconds since page-load or 0 if unsupported\n  return \"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\".replace(/[xy]/g, function (c) {\n    let r = Math.random() * 16; //random number between 0 and 16\n    if (d > 0) {\n      //Use timestamp until depleted\n      r = (d + r) % 16 | 0;\n      d = Math.floor(d / 16);\n    } else {\n      //Use microseconds since page-load if supported\n      r = (d2 + r) % 16 | 0;\n      d2 = Math.floor(d2 / 16);\n    }\n    return (c === \"x\" ? r : (r & 0x3) | 0x8).toString(16);\n  });\n}\n\nexport function currentTimestamp(): number {\n  return new Date().getTime();\n}\n\nexport function currentISOTime(): string {\n  return new Date().toISOString();\n}\n\nexport function safeSetTimeout(fn: () => void, timeout: number): any {\n  // NOTE: we use this so rarely that it is totally fine to do `safeSetTimeout(fn, 0)``\n  // rather than setImmediate.\n  const t = setTimeout(fn, timeout) as any;\n  // We unref if available to prevent Node.js hanging on exit\n  t?.unref && t?.unref();\n  return t;\n}\n\nexport function getEnv<T = string>(key: string): T | undefined {\n  if (typeof process !== \"undefined\" && process.env[key]) {\n    return process.env[key] as T;\n  } else if (typeof globalThis !== \"undefined\") {\n    return (globalThis as any)[key];\n  }\n  return;\n}\n\nexport function configLangfuseSDK(params?: LangfuseCoreOptions, secretRequired: boolean = true): LangfuseCoreOptions {\n  const { publicKey, secretKey, ...coreOptions } = params ?? {};\n\n  // check environment variables if values not provided\n  const finalPublicKey = publicKey ?? getEnv(\"LANGFUSE_PUBLIC_KEY\");\n  const finalSecretKey = secretRequired ? secretKey ?? getEnv(\"LANGFUSE_SECRET_KEY\") : undefined;\n  const finalBaseUrl = coreOptions.baseUrl ?? getEnv(\"LANGFUSE_BASEURL\");\n\n  const finalCoreOptions = {\n    ...coreOptions,\n    baseUrl: finalBaseUrl,\n  };\n\n  return {\n    publicKey: finalPublicKey,\n    ...(secretRequired ? { secretKey: finalSecretKey } : undefined),\n    ...finalCoreOptions,\n  };\n}\n\nexport const encodeQueryParams = (params?: { [key: string]: any }): string => {\n  const queryParams = new URLSearchParams();\n  Object.entries(params ?? {}).forEach(([key, value]) => {\n    if (value !== undefined && value !== null) {\n      // check for date\n      if (value instanceof Date) {\n        queryParams.append(key, value.toISOString());\n      } else {\n        queryParams.append(key, value.toString());\n      }\n    }\n  });\n  return queryParams.toString();\n};\n","import { getEnv } from \"./utils\";\n\nconst common_release_envs = [\n  // Vercel\n  \"VERCEL_GIT_COMMIT_SHA\",\n  \"NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA\",\n  // Netlify\n  \"COMMIT_REF\",\n  // Render\n  \"RENDER_GIT_COMMIT\",\n  // GitLab CI\n  \"CI_COMMIT_SHA\",\n  // CicleCI\n  \"CIRCLE_SHA1\",\n  // Cloudflare pages\n  \"CF_PAGES_COMMIT_SHA\",\n  // AWS Amplify\n  \"REACT_APP_GIT_SHA\",\n  // Heroku\n  \"SOURCE_VERSION\",\n  // Trigger.dev\n  \"TRIGGER_DEPLOYMENT_ID\",\n] as const;\n\nexport function getCommonReleaseEnvs(): string | undefined {\n  for (const key of common_release_envs) {\n    const value = getEnv(key);\n    if (value) {\n      return value;\n    }\n  }\n  return undefined;\n}\n","import { type LangfuseObjectClient } from \"./index\";\nimport { type LangfusePromptClient } from \"./prompts/promptClients\";\nimport { type components, type paths } from \"./openapi/server\";\n\nexport type LangfuseCoreOptions = {\n  // Langfuse API publicKey obtained from the Langfuse UI project settings\n  publicKey?: string;\n  // Langfuse API secretKey obtained from the Langfuse UI project settings\n  secretKey?: string;\n  // Langfuse API baseUrl (https://cloud.langfuse.com by default)\n  baseUrl?: string;\n  // Additional HTTP headers to send with each request\n  additionalHeaders?: Record<string, string>;\n  // The number of events to queue before sending to Langfuse (flushing)\n  flushAt?: number;\n  // The interval in milliseconds between periodic flushes\n  flushInterval?: number;\n  // How many times we will retry HTTP requests\n  fetchRetryCount?: number;\n  // The delay between HTTP request retries\n  fetchRetryDelay?: number;\n  // Timeout in milliseconds for any calls. Defaults to 10 seconds.\n  requestTimeout?: number;\n  // release (version) of the application, defaults to env LANGFUSE_RELEASE\n  release?: string;\n  // integration type of the SDK.\n  sdkIntegration?: string; // DEFAULT, LANGCHAIN, or any other custom value\n  // Enabled switch for the SDK. If disabled, no observability data will be sent to Langfuse. Defaults to true.\n  enabled?: boolean;\n  // Mask function to mask data in the event body\n  mask?: MaskFunction;\n  // Project ID to use for the SDK in admin mode. This should never be set by users.\n  _projectId?: string;\n  // Whether to enable local event export. Defaults to false.\n  _isLocalEventExportEnabled?: boolean;\n};\n\nexport enum LangfusePersistedProperty {\n  Props = \"props\",\n  Queue = \"queue\",\n  OptedOut = \"opted_out\",\n}\n\nexport type LangfuseFetchOptions = {\n  method: \"GET\" | \"POST\" | \"PUT\" | \"PATCH\";\n  headers: { [key: string]: string };\n  body?: string | Buffer;\n  signal?: AbortSignal;\n};\n\nexport type LangfuseFetchResponse<T = any> = {\n  status: number;\n  text: () => Promise<string>;\n  json: () => Promise<T>;\n  arrayBuffer: () => Promise<ArrayBuffer>;\n};\n\nexport type LangfuseObject = SingleIngestionEvent[\"type\"];\n\nexport type LangfuseQueueItem = SingleIngestionEvent & {\n  callback?: (err: any) => void;\n};\n\nexport type SingleIngestionEvent =\n  paths[\"/api/public/ingestion\"][\"post\"][\"requestBody\"][\"content\"][\"application/json\"][\"batch\"][number];\n\n// return type of ingestion endpoint defined on 200 status error in fern as 207 is not possible\nexport type IngestionReturnType =\n  paths[\"/api/public/ingestion\"][\"post\"][\"responses\"][207][\"content\"][\"application/json\"];\n\nexport type LangfuseEventProperties = {\n  [key: string]: any;\n};\n\nexport type LangfuseMetadataProperties = {\n  [key: string]: any;\n};\n\n// ASYNC\nexport type CreateLangfuseTraceBody = FixTypes<components[\"schemas\"][\"TraceBody\"]>;\n\nexport type CreateLangfuseEventBody = FixTypes<components[\"schemas\"][\"CreateEventBody\"]>;\n\nexport type CreateLangfuseSpanBody = FixTypes<components[\"schemas\"][\"CreateSpanBody\"]>;\nexport type UpdateLangfuseSpanBody = FixTypes<components[\"schemas\"][\"UpdateSpanBody\"]>;\nexport type EventBody =\n  | CreateLangfuseTraceBody\n  | CreateLangfuseEventBody\n  | CreateLangfuseSpanBody\n  | CreateLangfuseGenerationBody\n  | CreateLangfuseScoreBody\n  | UpdateLangfuseSpanBody\n  | UpdateLangfuseGenerationBody;\n\nexport type Usage = FixTypes<components[\"schemas\"][\"IngestionUsage\"]>;\nexport type UsageDetails = FixTypes<components[\"schemas\"][\"UsageDetails\"]>;\nexport type CreateLangfuseGenerationBody = FixTypes<components[\"schemas\"][\"CreateGenerationBody\"]>;\nexport type UpdateLangfuseGenerationBody = FixTypes<components[\"schemas\"][\"UpdateGenerationBody\"]>;\n\nexport type CreateLangfuseScoreBody = FixTypes<components[\"schemas\"][\"ScoreBody\"]>;\n\n// SYNC\nexport type GetLangfuseTracesQuery = FixTypes<paths[\"/api/public/traces\"][\"get\"][\"parameters\"][\"query\"]>;\nexport type GetLangfuseTracesResponse = FixTypes<\n  paths[\"/api/public/traces\"][\"get\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type GetLangfuseTraceResponse = FixTypes<\n  paths[\"/api/public/traces/{traceId}\"][\"get\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type GetLangfuseObservationsQuery = FixTypes<paths[\"/api/public/observations\"][\"get\"][\"parameters\"][\"query\"]>;\nexport type GetLangfuseObservationsResponse = FixTypes<\n  paths[\"/api/public/observations\"][\"get\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type GetLangfuseObservationResponse = FixTypes<\n  paths[\"/api/public/observations/{observationId}\"][\"get\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type GetLangfuseSessionsQuery = FixTypes<paths[\"/api/public/sessions\"][\"get\"][\"parameters\"][\"query\"]>;\nexport type GetLangfuseSessionsResponse = FixTypes<\n  paths[\"/api/public/sessions\"][\"get\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type GetLangfuseDatasetParams = FixTypes<\n  paths[\"/api/public/v2/datasets/{datasetName}\"][\"get\"][\"parameters\"][\"path\"]\n>;\nexport type GetLangfuseDatasetResponse = FixTypes<\n  paths[\"/api/public/v2/datasets/{datasetName}\"][\"get\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type GetLangfuseDatasetItemsQuery = paths[\"/api/public/dataset-items\"][\"get\"][\"parameters\"][\"query\"];\nexport type GetLangfuseDatasetItemsResponse = FixTypes<\n  paths[\"/api/public/dataset-items\"][\"get\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type CreateLangfuseDatasetRunItemBody = FixTypes<\n  paths[\"/api/public/dataset-run-items\"][\"post\"][\"requestBody\"][\"content\"][\"application/json\"]\n>;\nexport type CreateLangfuseDatasetRunItemResponse = FixTypes<\n  paths[\"/api/public/dataset-run-items\"][\"post\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type CreateLangfuseDatasetBody =\n  paths[\"/api/public/v2/datasets\"][\"post\"][\"requestBody\"][\"content\"][\"application/json\"];\nexport type CreateLangfuseDatasetResponse = FixTypes<\n  paths[\"/api/public/v2/datasets\"][\"post\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type CreateLangfuseDatasetItemBody = FixTypes<\n  paths[\"/api/public/dataset-items\"][\"post\"][\"requestBody\"][\"content\"][\"application/json\"]\n>;\nexport type CreateLangfuseDatasetItemResponse = FixTypes<\n  paths[\"/api/public/dataset-items\"][\"post\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type GetLangfuseDatasetRunParams = FixTypes<\n  paths[\"/api/public/datasets/{datasetName}/runs/{runName}\"][\"get\"][\"parameters\"][\"path\"]\n>;\nexport type GetLangfuseDatasetRunResponse = FixTypes<\n  paths[\"/api/public/datasets/{datasetName}/runs/{runName}\"][\"get\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type GetLangfuseDatasetRunsQuery =\n  paths[\"/api/public/datasets/{datasetName}/runs\"][\"get\"][\"parameters\"][\"query\"];\nexport type GetLangfuseDatasetRunsPath = paths[\"/api/public/datasets/{datasetName}/runs\"][\"get\"][\"parameters\"][\"path\"];\n\nexport type GetLangfuseDatasetRunsResponse = FixTypes<\n  paths[\"/api/public/datasets/{datasetName}/runs\"][\"get\"][\"responses\"][\"200\"][\"content\"][\"application/json\"]\n>;\nexport type CreateLangfusePromptBody = FixTypes<\n  paths[\"/api/public/v2/prompts\"][\"post\"][\"requestBody\"][\"content\"][\"application/json\"]\n>;\nexport type UpdatePromptBody = FixTypes<\n  paths[\"/api/public/v2/prompts/{name}/versions/{version}\"][\"patch\"][\"requestBody\"][\"content\"][\"application/json\"]\n>;\nexport type CreateLangfusePromptResponse =\n  paths[\"/api/public/v2/prompts\"][\"post\"][\"responses\"][\"200\"][\"content\"][\"application/json\"];\n\nexport type GetLangfusePromptSuccessData =\n  paths[\"/api/public/v2/prompts/{promptName}\"][\"get\"][\"responses\"][\"200\"][\"content\"][\"application/json\"];\n\nexport type GetLangfusePromptFailureData = { message?: string };\nexport type GetLangfusePromptResponse =\n  | {\n      fetchResult: \"success\";\n      data: GetLangfusePromptSuccessData;\n    }\n  | { fetchResult: \"failure\"; data: GetLangfusePromptFailureData };\n\nexport type ChatMessage = FixTypes<components[\"schemas\"][\"ChatMessage\"]>;\nexport type ChatPrompt = FixTypes<components[\"schemas\"][\"ChatPrompt\"]> & { type: \"chat\" };\nexport type TextPrompt = FixTypes<components[\"schemas\"][\"TextPrompt\"]> & { type: \"text\" };\n\n// Media\nexport type GetMediaUploadUrlRequest = FixTypes<components[\"schemas\"][\"GetMediaUploadUrlRequest\"]>;\nexport type GetMediaUploadUrlResponse = FixTypes<components[\"schemas\"][\"GetMediaUploadUrlResponse\"]>;\nexport type MediaContentType = components[\"schemas\"][\"MediaContentType\"];\nexport type PatchMediaBody = FixTypes<components[\"schemas\"][\"PatchMediaBody\"]>;\nexport type GetMediaResponse = FixTypes<components[\"schemas\"][\"GetMediaResponse\"]>;\n\ntype CreateTextPromptRequest = FixTypes<components[\"schemas\"][\"CreateTextPromptRequest\"]>;\ntype CreateChatPromptRequest = FixTypes<components[\"schemas\"][\"CreateChatPromptRequest\"]>;\nexport type CreateTextPromptBody = { type?: \"text\" } & Omit<CreateTextPromptRequest, \"type\"> & { isActive?: boolean }; // isActive is optional for backward compatibility\nexport type CreateChatPromptBody = { type: \"chat\" } & Omit<CreateChatPromptRequest, \"type\"> & { isActive?: boolean }; // isActive is optional for backward compatibility\n\nexport type CreatePromptBody = CreateTextPromptBody | CreateChatPromptBody;\n\nexport type PromptInput = {\n  prompt?: LangfusePromptRecord | LangfusePromptClient;\n};\n\nexport type JsonType = string | number | boolean | null | { [key: string]: JsonType } | Array<JsonType>;\n\ntype OptionalTypes<T> = T extends null | undefined ? T : never;\n\ntype FixTypes<T> = T extends undefined\n  ? undefined\n  : Omit<\n      {\n        [P in keyof T]: P extends\n          | \"startTime\"\n          | \"endTime\"\n          | \"timestamp\"\n          | \"completionStartTime\"\n          | \"createdAt\"\n          | \"updatedAt\"\n          | \"fromTimestamp\"\n          | \"toTimestamp\"\n          | \"fromStartTime\"\n          | \"toStartTime\"\n          ? // Dates instead of strings\n            Date | OptionalTypes<T[P]>\n          : P extends \"metadata\" | \"input\" | \"output\" | \"completion\" | \"expectedOutput\"\n            ? // JSON instead of strings\n              any | OptionalTypes<T[P]>\n            : T[P];\n      },\n      \"externalId\" | \"traceIdType\"\n    >;\n\nexport type DeferRuntime = {\n  langfuseTraces: (\n    traces: {\n      id: string;\n      name: string;\n      url: string;\n    }[]\n  ) => void;\n};\n\n// Datasets\nexport type DatasetItemData = GetLangfuseDatasetItemsResponse[\"data\"][number];\nexport type LinkDatasetItem = (\n  obj: LangfuseObjectClient,\n  runName: string,\n  runArgs?: {\n    description?: string;\n    metadata?: any;\n  }\n) => Promise<{ id: string }>;\nexport type DatasetItem = DatasetItemData & { link: LinkDatasetItem };\n\nexport type MaskFunction = (params: { data: any }) => any;\n\nexport type LangfusePromptRecord = (TextPrompt | ChatPrompt) & { isFallback: boolean };\n","import { type LangfuseCore } from \"../index\";\n\nlet fs: any = null;\nlet cryptoModule: any = null;\n\n// Use wrapper to prevent bundlers from trying to resolve the dynamic import\n// Otherwise, the import will be incorrectly resolved as a static import even though it's dynamic\n// Test for browser environment would fail because the import will be incorrectly resolved as a static import and fs and crypto will be unavailable\nconst dynamicImport = (module: string): Promise<any> => {\n  return import(/* webpackIgnore: true */ module);\n};\n\nif (typeof (globalThis as any).Deno !== \"undefined\") {\n  // Deno\n  Promise.all([dynamicImport(\"node:fs\"), dynamicImport(\"node:crypto\")])\n    .then(([importedFs, importedCrypto]) => {\n      fs = importedFs;\n      cryptoModule = importedCrypto;\n    })\n    .catch(); // Errors are handled on runtime\n} else if (typeof process !== \"undefined\" && process.versions?.node) {\n  // Node\n  Promise.all([dynamicImport(\"fs\"), dynamicImport(\"crypto\")])\n    .then(([importedFs, importedCrypto]) => {\n      fs = importedFs;\n      cryptoModule = importedCrypto;\n    })\n    .catch(); // Errors are handled on runtime\n} else if (typeof crypto !== \"undefined\") {\n  // Edge runtime (Cloudflare Workers, Vercel Cloud Function)\n  cryptoModule = crypto;\n}\n\nimport { type MediaContentType } from \"../types\";\n\ninterface ParsedMediaReference {\n  mediaId: string;\n  source: string;\n  contentType: MediaContentType;\n}\n\nexport type LangfuseMediaResolveMediaReferencesParams<T> = {\n  obj: T;\n  langfuseClient: LangfuseCore;\n  resolveWith: \"base64DataUri\";\n  maxDepth?: number;\n};\n\n/**\n * A class for wrapping media objects for upload to Langfuse.\n *\n * This class handles the preparation and formatting of media content for Langfuse,\n * supporting both base64 data URIs and raw content bytes.\n */\nclass LangfuseMedia {\n  obj?: object;\n\n  _contentBytes?: Buffer;\n  _contentType?: MediaContentType;\n  _source?: string;\n  _mediaId?: string;\n\n  constructor(params: {\n    obj?: object;\n    base64DataUri?: string;\n    contentType?: MediaContentType;\n    contentBytes?: Buffer;\n    filePath?: string;\n  }) {\n    const { obj, base64DataUri, contentType, contentBytes, filePath } = params;\n\n    this.obj = obj;\n    this._mediaId = undefined;\n\n    if (base64DataUri) {\n      const [contentBytesParsed, contentTypeParsed] = this.parseBase64DataUri(base64DataUri);\n      this._contentBytes = contentBytesParsed;\n      this._contentType = contentTypeParsed;\n      this._source = \"base64_data_uri\";\n    } else if (contentBytes && contentType) {\n      this._contentBytes = contentBytes;\n      this._contentType = contentType;\n      this._source = \"bytes\";\n    } else if (filePath && contentType) {\n      if (!fs) {\n        throw new Error(\"File system support is not available in this environment\");\n      }\n\n      if (!fs.existsSync(filePath)) {\n        throw new Error(`File at path ${filePath} does not exist`);\n      }\n\n      this._contentBytes = this.readFile(filePath);\n      this._contentType = this._contentBytes ? contentType : undefined;\n      this._source = this._contentBytes ? \"file\" : undefined;\n    } else {\n      console.error(\"base64DataUri, or contentBytes and contentType, or filePath must be provided to LangfuseMedia\");\n    }\n  }\n\n  private readFile(filePath: string): Buffer | undefined {\n    try {\n      if (!fs) {\n        throw new Error(\"File system support is not available in this environment\");\n      }\n\n      return fs.readFileSync(filePath);\n    } catch (error) {\n      console.error(`Error reading file at path ${filePath}`, error);\n      return undefined;\n    }\n  }\n\n  private parseBase64DataUri(data: string): [Buffer | undefined, MediaContentType | undefined] {\n    try {\n      if (!data || typeof data !== \"string\") {\n        throw new Error(\"Data URI is not a string\");\n      }\n\n      if (!data.startsWith(\"data:\")) {\n        throw new Error(\"Data URI does not start with 'data:'\");\n      }\n\n      const [header, actualData] = data.slice(5).split(\",\", 2);\n      if (!header || !actualData) {\n        throw new Error(\"Invalid URI\");\n      }\n\n      const headerParts = header.split(\";\");\n      if (!headerParts.includes(\"base64\")) {\n        throw new Error(\"Data is not base64 encoded\");\n      }\n\n      const contentType = headerParts[0];\n      if (!contentType) {\n        throw new Error(\"Content type is empty\");\n      }\n\n      return [Buffer.from(actualData, \"base64\"), contentType as MediaContentType];\n    } catch (error) {\n      console.error(\"Error parsing base64 data URI\", error);\n      return [undefined, undefined];\n    }\n  }\n\n  get contentLength(): number | undefined {\n    return this._contentBytes?.length;\n  }\n\n  get contentSha256Hash(): string | undefined {\n    if (!this._contentBytes) {\n      return undefined;\n    }\n\n    if (!cryptoModule) {\n      console.error(\"Crypto support is not available in this environment\");\n      return undefined;\n    }\n\n    const sha256Hash = cryptoModule.createHash(\"sha256\").update(this._contentBytes).digest(\"base64\");\n    return sha256Hash;\n  }\n\n  toJSON(): string | undefined {\n    if (!this._contentType || !this._source || !this._mediaId) {\n      return `<Upload handling failed for LangfuseMedia of type ${this._contentType}>`;\n    }\n\n    return `@@@langfuseMedia:type=${this._contentType}|id=${this._mediaId}|source=${this._source}@@@`;\n  }\n\n  /**\n   * Parses a media reference string into a ParsedMediaReference.\n   *\n   * Example reference string:\n   *     \"@@@langfuseMedia:type=image/jpeg|id=some-uuid|source=base64DataUri@@@\"\n   *\n   * @param referenceString - The reference string to parse.\n   * @returns An object with the mediaId, source, and contentType.\n   *\n   * @throws Error if the reference string is invalid or missing required fields.\n   */\n  public static parseReferenceString(referenceString: string): ParsedMediaReference {\n    const prefix = \"@@@langfuseMedia:\";\n    const suffix = \"@@@\";\n\n    if (!referenceString.startsWith(prefix)) {\n      throw new Error(\"Reference string does not start with '@@@langfuseMedia:type='\");\n    }\n\n    if (!referenceString.endsWith(suffix)) {\n      throw new Error(\"Reference string does not end with '@@@'\");\n    }\n\n    const content = referenceString.slice(prefix.length, -suffix.length);\n\n    const pairs = content.split(\"|\");\n    const parsedData: { [key: string]: string } = {};\n\n    for (const pair of pairs) {\n      const [key, value] = pair.split(\"=\", 2);\n      parsedData[key] = value;\n    }\n\n    if (!(\"type\" in parsedData && \"id\" in parsedData && \"source\" in parsedData)) {\n      throw new Error(\"Missing required fields in reference string\");\n    }\n\n    return {\n      mediaId: parsedData[\"id\"],\n      source: parsedData[\"source\"],\n      contentType: parsedData[\"type\"] as MediaContentType,\n    };\n  }\n\n  /**\n   * Replaces the media reference strings in an object with base64 data URIs for the media content.\n   *\n   * This method recursively traverses an object (up to a maximum depth of 10) looking for media reference strings\n   * in the format \"@@@langfuseMedia:...@@@\". When found, it fetches the actual media content using the provided\n   * Langfuse client and replaces the reference string with a base64 data URI.\n   *\n   * If fetching media content fails for a reference string, a warning is logged and the reference string is left unchanged.\n   *\n   * @param params - Configuration object\n   * @param params.obj - The object to process. Can be a primitive value, array, or nested object\n   * @param params.langfuseClient - Langfuse client instance used to fetch media content\n   * @param params.resolveWith - The representation of the media content to replace the media reference string with. Currently only \"base64DataUri\" is supported.\n   * @param params.maxDepth - Optional. Default is 10. The maximum depth to traverse the object.\n   *\n   * @returns A deep copy of the input object with all media references replaced with base64 data URIs where possible\n   *\n   * @example\n   * ```typescript\n   * const obj = {\n   *   image: \"@@@langfuseMedia:type=image/jpeg|id=123|source=bytes@@@\",\n   *   nested: {\n   *     pdf: \"@@@langfuseMedia:type=application/pdf|id=456|source=bytes@@@\"\n   *   }\n   * };\n   *\n   * const result = await LangfuseMedia.resolveMediaReferences({\n   *   obj,\n   *   langfuseClient\n   * });\n   *\n   * // Result:\n   * // {\n   * //   image: \"data:image/jpeg;base64,/9j/4AAQSkZJRg...\",\n   * //   nested: {\n   * //     pdf: \"data:application/pdf;base64,JVBERi0xLjcK...\"\n   * //   }\n   * // }\n   * ```\n   */\n  public static async resolveMediaReferences<T>(params: LangfuseMediaResolveMediaReferencesParams<T>): Promise<T> {\n    const { obj, langfuseClient, maxDepth = 10 } = params;\n\n    async function traverse<T>(obj: T, depth: number): Promise<T> {\n      if (depth > maxDepth) {\n        return obj;\n      }\n\n      // Handle string with potential media references\n      if (typeof obj === \"string\") {\n        const regex = /@@@langfuseMedia:.+?@@@/g;\n        const referenceStringMatches = obj.match(regex);\n        if (!referenceStringMatches) {\n          return obj;\n        }\n\n        let result = obj;\n        const referenceStringToMediaContentMap = new Map<string, string>();\n\n        await Promise.all(\n          referenceStringMatches.map(async (referenceString) => {\n            try {\n              const parsedMediaReference = LangfuseMedia.parseReferenceString(referenceString);\n              const mediaData = await langfuseClient.fetchMedia(parsedMediaReference.mediaId);\n              const mediaContent = await langfuseClient.fetch(mediaData.url, { method: \"GET\", headers: {} });\n              if (mediaContent.status !== 200) {\n                throw new Error(\"Failed to fetch media content\");\n              }\n\n              const base64MediaContent = Buffer.from(await mediaContent.arrayBuffer()).toString(\"base64\");\n              const base64DataUri = `data:${mediaData.contentType};base64,${base64MediaContent}`;\n\n              referenceStringToMediaContentMap.set(referenceString, base64DataUri);\n            } catch (error) {\n              console.warn(\"Error fetching media content for reference string\", referenceString, error);\n              // Do not replace the reference string if there's an error\n            }\n          })\n        );\n\n        for (const [referenceString, base64MediaContent] of referenceStringToMediaContentMap.entries()) {\n          result = result.replaceAll(referenceString, base64MediaContent) as T & string;\n        }\n\n        return result;\n      }\n\n      // Handle arrays\n      if (Array.isArray(obj)) {\n        return Promise.all(obj.map(async (item) => await traverse(item, depth + 1))) as Promise<T>;\n      }\n\n      // Handle objects\n      if (typeof obj === \"object\" && obj !== null) {\n        return Object.fromEntries(\n          await Promise.all(Object.entries(obj).map(async ([key, value]) => [key, await traverse(value, depth + 1)]))\n        );\n      }\n\n      return obj;\n    }\n\n    return traverse(obj, 0);\n  }\n}\n\nexport { LangfuseMedia, type MediaContentType, type ParsedMediaReference };\n","import { type LangfusePersistedProperty } from \"./types\";\n\nexport class LangfuseMemoryStorage {\n  private _memoryStorage: { [key: string]: any | undefined } = {};\n\n  getProperty(key: LangfusePersistedProperty): any | undefined {\n    return this._memoryStorage[key];\n  }\n\n  setProperty(key: LangfusePersistedProperty, value: any | null): void {\n    this._memoryStorage[key] = value !== null ? value : undefined;\n  }\n}\n","import { SimpleEventEmitter } from \"./eventemitter\";\nimport { LangfusePromptCache } from \"./prompts/promptCache\";\nimport { ChatPromptClient, TextPromptClient, type LangfusePromptClient } from \"./prompts/promptClients\";\nimport { getCommonReleaseEnvs } from \"./release-env\";\nimport {\n  LangfusePersistedProperty,\n  type ChatMessage,\n  type CreateChatPromptBody,\n  type CreateLangfuseDatasetBody,\n  type CreateLangfuseDatasetItemBody,\n  type CreateLangfuseDatasetItemResponse,\n  type CreateLangfuseDatasetResponse,\n  type CreateLangfuseDatasetRunItemBody,\n  type CreateLangfuseDatasetRunItemResponse,\n  type CreateLangfuseEventBody,\n  type CreateLangfuseGenerationBody,\n  type CreateLangfusePromptBody,\n  type CreateLangfusePromptResponse,\n  type GetMediaUploadUrlRequest,\n  type GetMediaUploadUrlResponse,\n  type PatchMediaBody,\n  type CreateLangfuseScoreBody,\n  type CreateLangfuseSpanBody,\n  type CreateLangfuseTraceBody,\n  type CreatePromptBody,\n  type CreateTextPromptBody,\n  type DatasetItem,\n  type DeferRuntime,\n  type EventBody,\n  type GetLangfuseDatasetItemsQuery,\n  type GetLangfuseDatasetItemsResponse,\n  type GetLangfuseDatasetParams,\n  type GetLangfuseDatasetResponse,\n  type GetLangfuseDatasetRunParams,\n  type GetLangfuseDatasetRunResponse,\n  type GetLangfuseDatasetRunsQuery,\n  type GetLangfuseDatasetRunsResponse,\n  type GetLangfuseObservationResponse,\n  type GetLangfuseObservationsQuery,\n  type GetLangfuseObservationsResponse,\n  type GetLangfusePromptResponse,\n  type GetLangfuseSessionsQuery,\n  type GetLangfuseSessionsResponse,\n  type GetLangfuseTraceResponse,\n  type GetLangfuseTracesQuery,\n  type GetLangfuseTracesResponse,\n  type IngestionReturnType,\n  type LangfuseCoreOptions,\n  type LangfuseFetchOptions,\n  type LangfuseFetchResponse,\n  type LangfuseObject,\n  type LangfuseQueueItem,\n  type MaskFunction,\n  type PromptInput,\n  type SingleIngestionEvent,\n  type UpdateLangfuseGenerationBody,\n  type UpdateLangfuseSpanBody,\n  type GetMediaResponse,\n  UpdatePromptBody,\n} from \"./types\";\nimport { LangfuseMedia, type LangfuseMediaResolveMediaReferencesParams } from \"./media/LangfuseMedia\";\nimport {\n  currentISOTime,\n  encodeQueryParams,\n  generateUUID,\n  getEnv,\n  removeTrailingSlash,\n  retriable,\n  safeSetTimeout,\n  type RetriableOptions,\n} from \"./utils\";\n\nexport * from \"./prompts/promptClients\";\nexport * from \"./media/LangfuseMedia\";\nexport { LangfuseMemoryStorage } from \"./storage-memory\";\nexport type { LangfusePromptRecord } from \"./types\";\nexport * as utils from \"./utils\";\nexport type IngestionBody = SingleIngestionEvent[\"body\"];\n\nconst MAX_EVENT_SIZE = 1_000_000;\n\nclass LangfuseFetchHttpError extends Error {\n  name = \"LangfuseFetchHttpError\";\n  body: string | undefined;\n\n  constructor(\n    public response: LangfuseFetchResponse,\n    body: string\n  ) {\n    super(\"HTTP error while fetching Langfuse: \" + response.status + \" and body: \" + body);\n  }\n}\n\nclass LangfuseFetchNetworkError extends Error {\n  name = \"LangfuseFetchNetworkError\";\n\n  constructor(public error: unknown) {\n    super(\"Network error while fetching Langfuse\", error instanceof Error ? { cause: error } : {});\n  }\n}\n\nfunction isLangfuseFetchHttpError(error: any): error is LangfuseFetchHttpError {\n  return typeof error === \"object\" && error.name === \"LangfuseFetchHttpError\";\n}\n\nfunction isLangfuseFetchNetworkError(error: any): error is LangfuseFetchNetworkError {\n  return typeof error === \"object\" && error.name === \"LangfuseFetchNetworkError\";\n}\n\nfunction isLangfuseFetchError(err: any): boolean {\n  return isLangfuseFetchHttpError(err) || isLangfuseFetchNetworkError(err);\n}\n\n// Constants for URLs\nconst SUPPORT_URL = \"https://langfuse.com/support\";\nconst API_DOCS_URL = \"https://api.reference.langfuse.com\";\nconst RBAC_DOCS_URL = \"https://langfuse.com/docs/rbac\";\nconst INSTALLATION_DOCS_URL = \"https://langfuse.com/docs/sdk/typescript/guide\";\nconst RATE_LIMITS_URL = \"https://langfuse.com/faq/all/api-limits\";\nconst NPM_PACKAGE_URL = \"https://www.npmjs.com/package/langfuse\";\n\n// Error messages\nconst updatePromptResponse = `Make sure to keep your SDK updated, refer to ${NPM_PACKAGE_URL} for details.`;\nconst defaultServerErrorPrompt = `This is an unusual occurrence and we are monitoring it closely. For help, please contact support: ${SUPPORT_URL}.`;\nconst defaultErrorResponse = `Unexpected error occurred. Please check your request and contact support: ${SUPPORT_URL}.`;\n\n// Error response map\nconst errorResponseByCode = new Map<number, string>([\n  // Internal error category: 5xx errors, 404 error\n  [500, `Internal server error occurred. For help, please contact support: ${SUPPORT_URL}`],\n  [501, `Not implemented. Please check your request and contact support for help: ${SUPPORT_URL}.`],\n  [502, `Bad gateway. ${defaultServerErrorPrompt}`],\n  [503, `Service unavailable. ${defaultServerErrorPrompt}`],\n  [504, `Gateway timeout. ${defaultServerErrorPrompt}`],\n  [404, `Internal error occurred. ${defaultServerErrorPrompt}`],\n\n  // Client error category: 4xx errors, excluding 404\n  [\n    400,\n    `Bad request. Please check your request for any missing or incorrect parameters. Refer to our API docs: ${API_DOCS_URL} for details.`,\n  ],\n  [\n    401,\n    `Unauthorized. Please check your public/private host settings. Refer to our installation and setup guide: ${INSTALLATION_DOCS_URL} for details on SDK configuration.`,\n  ],\n  [403, `Forbidden. Please check your access control settings. Refer to our RBAC docs: ${RBAC_DOCS_URL} for details.`],\n  [429, `Rate limit exceeded. For more information on rate limits please see: ${RATE_LIMITS_URL}`],\n]);\n\n// Returns a user-friendly error message based on the HTTP status code\nfunction getErrorResponseByCode(code: number | undefined): string {\n  if (!code) {\n    return `${defaultErrorResponse} ${updatePromptResponse}`;\n  }\n\n  const errorResponse = errorResponseByCode.get(code) || defaultErrorResponse;\n  return `${code}: ${errorResponse} ${updatePromptResponse}`;\n}\n\nfunction logIngestionError(error: any): void {\n  if (isLangfuseFetchHttpError(error)) {\n    const code = error.response.status;\n    const errorResponse = getErrorResponseByCode(code);\n    console.error(\"[Langfuse SDK]\", errorResponse, `Error details: ${error}`);\n  } else if (isLangfuseFetchNetworkError(error)) {\n    console.error(\"[Langfuse SDK] Network error: \", error);\n  } else {\n    console.error(\"[Langfuse SDK] Unknown error:\", error);\n  }\n}\n\nabstract class LangfuseCoreStateless {\n  // options\n  private secretKey: string | undefined;\n  private publicKey: string;\n  baseUrl: string;\n  additionalHeaders: Record<string, string> = {};\n  private flushAt: number;\n  private flushInterval: number;\n  private requestTimeout: number;\n  private removeDebugCallback?: () => void;\n  private debugMode: boolean = false;\n  private pendingEventProcessingPromises: Record<string, Promise<any>> = {};\n  private pendingIngestionPromises: Record<string, Promise<any>> = {};\n  private release: string | undefined;\n  private sdkIntegration: string;\n  private enabled: boolean;\n  protected isLocalEventExportEnabled: boolean;\n  private localEventExportMap: Map<string, SingleIngestionEvent[]> = new Map();\n  private projectId: string | undefined;\n  private mask: MaskFunction | undefined;\n\n  // internal\n  protected _events = new SimpleEventEmitter();\n  protected _flushTimer?: any;\n  protected _retryOptions: RetriableOptions;\n\n  // Abstract methods to be overridden by implementations\n  abstract fetch(url: string, options: LangfuseFetchOptions): Promise<LangfuseFetchResponse>;\n  abstract getLibraryId(): string;\n  abstract getLibraryVersion(): string;\n\n  // This is our abstracted storage. Each implementation should handle its own\n  abstract getPersistedProperty<T>(key: LangfusePersistedProperty): T | undefined;\n  abstract setPersistedProperty<T>(key: LangfusePersistedProperty, value: T | null): void;\n\n  constructor(params: LangfuseCoreOptions) {\n    const { publicKey, secretKey, enabled, _projectId, _isLocalEventExportEnabled, ...options } = params;\n\n    this.enabled = enabled === false ? false : true;\n    this.publicKey = publicKey ?? \"\";\n    this.secretKey = secretKey;\n    this.baseUrl = removeTrailingSlash(options?.baseUrl || \"https://cloud.langfuse.com\");\n    this.additionalHeaders = options?.additionalHeaders || {};\n    this.flushAt = options?.flushAt ? Math.max(options?.flushAt, 1) : 15;\n    this.flushInterval = options?.flushInterval ?? 10000;\n    this.release = options?.release ?? getEnv(\"LANGFUSE_RELEASE\") ?? getCommonReleaseEnvs() ?? undefined;\n    this.mask = options?.mask;\n\n    this._retryOptions = {\n      retryCount: options?.fetchRetryCount ?? 3,\n      retryDelay: options?.fetchRetryDelay ?? 3000,\n      retryCheck: isLangfuseFetchError,\n    };\n    this.requestTimeout = options?.requestTimeout ?? 10000; // 10 seconds\n\n    this.sdkIntegration = options?.sdkIntegration ?? \"DEFAULT\";\n\n    this.isLocalEventExportEnabled = _isLocalEventExportEnabled ?? false;\n\n    if (this.isLocalEventExportEnabled && !_projectId) {\n      this._events.emit(\n        \"error\",\n        \"Local event export is enabled, but no project ID was provided. Disabling local export.\"\n      );\n      this.isLocalEventExportEnabled = false;\n      return;\n    } else if (!this.isLocalEventExportEnabled && _projectId) {\n      this._events.emit(\n        \"error\",\n        \"Local event export is disabled, but a project ID was provided. Disabling local export.\"\n      );\n      this.isLocalEventExportEnabled = false;\n      return;\n    } else {\n      this.projectId = _projectId;\n    }\n  }\n\n  getSdkIntegration(): string {\n    return this.sdkIntegration;\n  }\n\n  protected getCommonEventProperties(): any {\n    return {\n      $lib: this.getLibraryId(),\n      $lib_version: this.getLibraryVersion(),\n    };\n  }\n\n  on(event: string, cb: (...args: any[]) => void): () => void {\n    return this._events.on(event, cb);\n  }\n\n  debug(enabled: boolean = true): void {\n    this.removeDebugCallback?.();\n\n    this.debugMode = enabled;\n\n    if (enabled) {\n      this.removeDebugCallback = this.on(\"*\", (event, payload) =>\n        console.log(\"Langfuse Debug\", event, JSON.stringify(payload))\n      );\n    }\n  }\n\n  /***\n   *** Handlers for each object type\n   ***/\n  protected traceStateless(body: CreateLangfuseTraceBody): string {\n    const { id: bodyId, timestamp: bodyTimestamp, release: bodyRelease, ...rest } = body;\n\n    const id = bodyId ?? generateUUID();\n    const release = bodyRelease ?? this.release;\n\n    const parsedBody: CreateLangfuseTraceBody = {\n      id,\n      release,\n      timestamp: bodyTimestamp ?? new Date(),\n      ...rest,\n    };\n    this.enqueue(\"trace-create\", parsedBody);\n    return id;\n  }\n\n  protected eventStateless(body: CreateLangfuseEventBody): string {\n    const { id: bodyId, startTime: bodyStartTime, ...rest } = body;\n\n    const id = bodyId ?? generateUUID();\n\n    const parsedBody: CreateLangfuseEventBody = {\n      id,\n      startTime: bodyStartTime ?? new Date(),\n      ...rest,\n    };\n    this.enqueue(\"event-create\", parsedBody);\n    return id;\n  }\n\n  protected spanStateless(body: CreateLangfuseSpanBody): string {\n    const { id: bodyId, startTime: bodyStartTime, ...rest } = body;\n\n    const id = bodyId || generateUUID();\n\n    const parsedBody: CreateLangfuseSpanBody = {\n      id,\n      startTime: bodyStartTime ?? new Date(),\n      ...rest,\n    };\n    this.enqueue(\"span-create\", parsedBody);\n    return id;\n  }\n\n  protected generationStateless(\n    body: Omit<CreateLangfuseGenerationBody, \"promptName\" | \"promptVersion\"> & PromptInput\n  ): string {\n    const { id: bodyId, startTime: bodyStartTime, prompt, ...rest } = body;\n    const promptDetails =\n      prompt && !prompt.isFallback ? { promptName: prompt.name, promptVersion: prompt.version } : {};\n\n    const id = bodyId || generateUUID();\n\n    const parsedBody: CreateLangfuseGenerationBody = {\n      id,\n      startTime: bodyStartTime ?? new Date(),\n      ...promptDetails,\n      ...rest,\n    };\n\n    this.enqueue(\"generation-create\", parsedBody);\n    return id;\n  }\n\n  protected scoreStateless(body: CreateLangfuseScoreBody): string {\n    const { id: bodyId, ...rest } = body;\n\n    const id = bodyId || generateUUID();\n\n    const parsedBody: CreateLangfuseScoreBody = {\n      id,\n      ...rest,\n    };\n    this.enqueue(\"score-create\", parsedBody);\n    return id;\n  }\n\n  protected updateSpanStateless(body: UpdateLangfuseSpanBody): string {\n    this.enqueue(\"span-update\", body);\n    return body.id;\n  }\n\n  protected updateGenerationStateless(\n    body: Omit<UpdateLangfuseGenerationBody, \"promptName\" | \"promptVersion\"> & PromptInput\n  ): string {\n    const { prompt, ...rest } = body;\n    const promptDetails =\n      prompt && !prompt.isFallback ? { promptName: prompt.name, promptVersion: prompt.version } : {};\n\n    const parsedBody: UpdateLangfuseGenerationBody = {\n      ...promptDetails,\n      ...rest,\n    };\n    this.enqueue(\"generation-update\", parsedBody);\n    return body.id;\n  }\n\n  protected async _getDataset(name: GetLangfuseDatasetParams[\"datasetName\"]): Promise<GetLangfuseDatasetResponse> {\n    const encodedName = encodeURIComponent(name);\n    return this.fetchAndLogErrors(\n      `${this.baseUrl}/api/public/v2/datasets/${encodedName}`,\n      this._getFetchOptions({ method: \"GET\" })\n    );\n  }\n\n  protected async _getDatasetItems(query: GetLangfuseDatasetItemsQuery): Promise<GetLangfuseDatasetItemsResponse> {\n    const params = new URLSearchParams();\n    Object.entries(query ?? {}).forEach(([key, value]) => {\n      if (value !== undefined && value !== null) {\n        params.append(key, value.toString());\n      }\n    });\n\n    return this.fetchAndLogErrors(\n      `${this.baseUrl}/api/public/dataset-items?${params}`,\n      this._getFetchOptions({ method: \"GET\" })\n    );\n  }\n\n  protected async _fetchMedia(id: string): Promise<GetMediaResponse> {\n    return this.fetchAndLogErrors(`${this.baseUrl}/api/public/media/${id}`, this._getFetchOptions({ method: \"GET\" }));\n  }\n\n  async fetchTraces(query?: GetLangfuseTracesQuery): Promise<GetLangfuseTracesResponse> {\n    // destructure the response into data and meta to be explicit about the shape of the response and add type-warnings in case the API changes\n    const { data, meta } = await this.fetchAndLogErrors<GetLangfuseTracesResponse>(\n      `${this.baseUrl}/api/public/traces?${encodeQueryParams(query)}`,\n      this._getFetchOptions({ method: \"GET\" })\n    );\n    return { data, meta };\n  }\n\n  async fetchTrace(traceId: string): Promise<{ data: GetLangfuseTraceResponse }> {\n    const res = await this.fetchAndLogErrors<GetLangfuseTraceResponse>(\n      `${this.baseUrl}/api/public/traces/${traceId}`,\n      this._getFetchOptions({ method: \"GET\" })\n    );\n    return { data: res };\n  }\n\n  async fetchObservations(query?: GetLangfuseObservationsQuery): Promise<GetLangfuseObservationsResponse> {\n    // destructure the response into data and meta to be explicit about the shape of the response and add type-warnings in case the API changes\n    const { data, meta } = await this.fetchAndLogErrors<GetLangfuseObservationsResponse>(\n      `${this.baseUrl}/api/public/observations?${encodeQueryParams(query)}`,\n      this._getFetchOptions({ method: \"GET\" })\n    );\n\n    return { data, meta };\n  }\n\n  async fetchObservation(observationId: string): Promise<{ data: GetLangfuseObservationResponse }> {\n    const res = await this.fetchAndLogErrors<GetLangfuseObservationResponse>(\n      `${this.baseUrl}/api/public/observations/${observationId}`,\n      this._getFetchOptions({ method: \"GET\" })\n    );\n\n    return { data: res };\n  }\n\n  async fetchSessions(query?: GetLangfuseSessionsQuery): Promise<GetLangfuseSessionsResponse> {\n    // destructure the response into data and meta to be explicit about the shape of the response and add type-warnings in case the API changes\n    const { data, meta } = await this.fetchAndLogErrors<GetLangfuseSessionsResponse>(\n      `${this.baseUrl}/api/public/sessions?${encodeQueryParams(query)}`,\n      this._getFetchOptions({ method: \"GET\" })\n    );\n\n    return { data, meta };\n  }\n\n  async getDatasetRun(params: GetLangfuseDatasetRunParams): Promise<GetLangfuseDatasetRunResponse> {\n    const encodedDatasetName = encodeURIComponent(params.datasetName);\n    const encodedRunName = encodeURIComponent(params.runName);\n    return this.fetchAndLogErrors(\n      `${this.baseUrl}/api/public/datasets/${encodedDatasetName}/runs/${encodedRunName}`,\n      this._getFetchOptions({ method: \"GET\" })\n    );\n  }\n\n  async getDatasetRuns(\n    datasetName: string,\n    query?: GetLangfuseDatasetRunsQuery\n  ): Promise<GetLangfuseDatasetRunsResponse> {\n    return this.fetchAndLogErrors(\n      `${this.baseUrl}/api/public/datasets/${encodeURIComponent(datasetName)}/runs?${encodeQueryParams(query)}`,\n      this._getFetchOptions({ method: \"GET\" })\n    );\n  }\n\n  async createDatasetRunItem(body: CreateLangfuseDatasetRunItemBody): Promise<CreateLangfuseDatasetRunItemResponse> {\n    return this.fetchAndLogErrors(\n      `${this.baseUrl}/api/public/dataset-run-items`,\n      this._getFetchOptions({ method: \"POST\", body: JSON.stringify(body) })\n    );\n  }\n\n  /**\n   * Creates a dataset. Upserts the dataset if it already exists.\n   *\n   * @param dataset Can be either a string (name) or an object with name, description and metadata\n   * @returns A promise that resolves to the response of the create operation.\n   */\n  async createDataset(\n    dataset:\n      | string // name\n      | {\n          name: string;\n          description?: string;\n          metadata?: any;\n        }\n  ): Promise<CreateLangfuseDatasetResponse> {\n    const body: CreateLangfuseDatasetBody = typeof dataset === \"string\" ? { name: dataset } : dataset;\n    return this.fetchAndLogErrors(\n      `${this.baseUrl}/api/public/datasets`,\n      this._getFetchOptions({ method: \"POST\", body: JSON.stringify(body) })\n    );\n  }\n\n  /**\n   * Creates a dataset item. Upserts the item if it already exists.\n   * @param body The body of the dataset item to be created.\n   * @returns A promise that resolves to the response of the create operation.\n   */\n  async createDatasetItem(body: CreateLangfuseDatasetItemBody): Promise<CreateLangfuseDatasetItemResponse> {\n    return this.fetchAndLogErrors(\n      `${this.baseUrl}/api/public/dataset-items`,\n      this._getFetchOptions({ method: \"POST\", body: JSON.stringify(body) })\n    );\n  }\n\n  async getDatasetItem(id: string): Promise<CreateLangfuseDatasetItemResponse> {\n    return this.fetchAndLogErrors(\n      `${this.baseUrl}/api/public/dataset-items/${id}`,\n      this._getFetchOptions({ method: \"GET\" })\n    );\n  }\n\n  protected _parsePayload(response: any): any {\n    try {\n      return JSON.parse(response);\n    } catch {\n      return response;\n    }\n  }\n\n  async createPromptStateless(body: CreateLangfusePromptBody): Promise<CreateLangfusePromptResponse> {\n    return this.fetchAndLogErrors(\n      `${this.baseUrl}/api/public/v2/prompts`,\n      this._getFetchOptions({ method: \"POST\", body: JSON.stringify(body) })\n    );\n  }\n\n  async updatePromptStateless(\n    body: UpdatePromptBody & { name: string; version: number }\n  ): Promise<LangfusePromptClient> {\n    return this.fetchAndLogErrors(\n      `${this.baseUrl}/api/public/v2/prompts/${encodeURIComponent(body.name)}/versions/${encodeURIComponent(body.version)}`,\n      this._getFetchOptions({ method: \"PATCH\", body: JSON.stringify(body) })\n    );\n  }\n\n  async getPromptStateless(\n    name: string,\n    version?: number,\n    label?: string,\n    maxRetries?: number,\n    requestTimeout?: number // this will override the default requestTimeout for fetching prompts. Together with maxRetries, it can be used to fetch prompts fast when the first fetch is slow.\n  ): Promise<GetLangfusePromptResponse> {\n    const encodedName = encodeURIComponent(name);\n    const params = new URLSearchParams();\n\n    // Add parameters only if they are provided\n    if (version && label) {\n      throw new Error(\"Provide either version or label, not both.\");\n    }\n\n    if (version) {\n      params.append(\"version\", version.toString());\n    }\n\n    if (label) {\n      params.append(\"label\", label);\n    }\n\n    const url = `${this.baseUrl}/api/public/v2/prompts/${encodedName}${params.size ? \"?\" + params : \"\"}`;\n\n    const boundedMaxRetries = this._getBoundedMaxRetries({ maxRetries, defaultMaxRetries: 2, maxRetriesUpperBound: 4 });\n    const retryOptions = { ...this._retryOptions, retryCount: boundedMaxRetries, retryDelay: 500 };\n    const retryLogger = (string: string): void =>\n      this._events.emit(\"retry\", string + \", \" + url + \", \" + JSON.stringify(retryOptions));\n\n    return retriable(\n      async () => {\n        const res = await this.fetch(url, this._getFetchOptions({ method: \"GET\", fetchTimeout: requestTimeout })).catch(\n          (e) => {\n            if (e.name === \"AbortError\") {\n              throw new LangfuseFetchNetworkError(\"Fetch request timed out\");\n            }\n            throw new LangfuseFetchNetworkError(e);\n          }\n        );\n\n        const data = await res.json();\n\n        if (res.status >= 500) {\n          throw new LangfuseFetchHttpError(res, JSON.stringify(data));\n        }\n\n        return { fetchResult: res.status === 200 ? \"success\" : \"failure\", data };\n      },\n      retryOptions,\n      retryLogger\n    );\n  }\n\n  private _getBoundedMaxRetries(params: {\n    maxRetries?: number;\n    defaultMaxRetries?: number;\n    maxRetriesUpperBound?: number;\n  }): number {\n    const defaultMaxRetries = Math.max(params.defaultMaxRetries ?? 2, 0);\n    const maxRetriesUpperBound = Math.max(params.maxRetriesUpperBound ?? 4, 0);\n\n    if (params.maxRetries === undefined) {\n      return defaultMaxRetries;\n    }\n\n    return Math.min(Math.max(params.maxRetries, 0), maxRetriesUpperBound);\n  }\n\n  /***\n   *** QUEUEING AND FLUSHING\n   ***/\n  protected enqueue(type: LangfuseObject, body: EventBody): void {\n    if (!this.enabled) {\n      return;\n    }\n\n    const promise = this.processEnqueueEvent(type, body);\n    const promiseId = generateUUID();\n    this.pendingEventProcessingPromises[promiseId] = promise;\n\n    promise\n      .catch((e) => {\n        this._events.emit(\"error\", e);\n      })\n      .finally(() => {\n        delete this.pendingEventProcessingPromises[promiseId];\n      });\n  }\n\n  protected async processEnqueueEvent(type: LangfuseObject, body: EventBody): Promise<void> {\n    this.maskEventBodyInPlace(body);\n    await this.processMediaInEvent(type, body);\n    const finalEventBody = this.truncateEventBody(body, MAX_EVENT_SIZE);\n\n    try {\n      JSON.stringify(finalEventBody);\n    } catch (e) {\n      this._events.emit(\"error\", `[Langfuse SDK] Event Body for ${type} is not JSON-serializable: ${e}`);\n      return;\n    }\n\n    const queue = this.getPersistedProperty<LangfuseQueueItem[]>(LangfusePersistedProperty.Queue) || [];\n\n    queue.push({\n      id: generateUUID(),\n      type,\n      timestamp: currentISOTime(),\n      body: finalEventBody as any, // TODO: fix typecast. EventBody is not correctly narrowed to the correct type dictated by the 'type' property. This should be part of a larger type cleanup.\n      metadata: undefined,\n    });\n    this.setPersistedProperty<LangfuseQueueItem[]>(LangfusePersistedProperty.Queue, queue);\n\n    this._events.emit(type, finalEventBody);\n\n    // Flush queued events if we meet the flushAt length\n    if (queue.length >= this.flushAt) {\n      this.flush();\n    }\n\n    if (this.flushInterval && !this._flushTimer) {\n      this._flushTimer = safeSetTimeout(() => this.flush(), this.flushInterval);\n    }\n  }\n\n  private maskEventBodyInPlace(body: EventBody): void {\n    if (!this.mask) {\n      return;\n    }\n\n    const maskableKeys = [\"input\", \"output\"] as const;\n\n    for (const key of maskableKeys) {\n      if (key in body) {\n        try {\n          body[key as keyof EventBody] = this.mask({ data: body[key as keyof EventBody] });\n        } catch (e) {\n          this._events.emit(\"error\", `Error masking ${key}: ${e}`);\n          body[key as keyof EventBody] = \"<fully masked due to failed mask function>\";\n        }\n      }\n    }\n  }\n\n  /**\n   * Truncates the event body if its byte size exceeds the specified maximum byte size.\n   * Emits a warning event if truncation occurs.\n   * The fields that may be truncated are: \"input\", \"output\", and \"metadata\".\n   * The fields are truncated in the order of their size, from largest to smallest until the total byte size is within the limit.\n   */\n  protected truncateEventBody(body: EventBody, maxByteSize: number): EventBody {\n    const bodySize = this.getByteSize(body);\n\n    if (bodySize <= maxByteSize) {\n      return body;\n    }\n\n    this._events.emit(\"warning\", `Event Body is too large (${bodySize} bytes) and will be truncated`);\n\n    // Sort keys by size and truncate the largest keys first\n    const keysToCheck = [\"input\", \"output\", \"metadata\"] as const;\n    const keySizes = keysToCheck\n      .map((key) => ({ key, size: key in body ? this.getByteSize(body[key as keyof typeof body]) : 0 }))\n      .sort((a, b) => b.size - a.size);\n\n    let result = { ...body };\n    let currentSize = bodySize;\n\n    for (const { key, size } of keySizes) {\n      if (currentSize > maxByteSize && Object.prototype.hasOwnProperty.call(result, key)) {\n        result = { ...result, [key]: \"<truncated due to size exceeding limit>\" };\n\n        this._events.emit(\"warning\", `Truncated ${key} due to total size exceeding limit`);\n\n        currentSize -= size;\n      }\n    }\n\n    return result;\n  }\n\n  private getByteSize(obj: any): number {\n    const serialized = JSON.stringify(obj);\n\n    // Use TextEncoder if available, otherwise fallback to encodeURIComponent\n    if (typeof TextEncoder !== \"undefined\") {\n      return new TextEncoder().encode(serialized).length;\n    } else {\n      return encodeURIComponent(serialized).replace(/%[A-F\\d]{2}/g, \"U\").length;\n    }\n  }\n\n  protected async processMediaInEvent(type: LangfuseObject, body: EventBody): Promise<void> {\n    if (!body) {\n      return;\n    }\n\n    const traceId = \"traceId\" in body ? body.traceId : type.includes(\"trace\") ? body.id : undefined;\n\n    if (!traceId) {\n      this._events.emit(\"warning\", \"traceId is required for media upload\");\n      return;\n    }\n\n    const observationId = (type.includes(\"generation\") || type.includes(\"span\")) && body.id ? body.id : undefined;\n\n    await Promise.all(\n      ([\"input\", \"output\", \"metadata\"] as const).map(async (field) => {\n        if (body[field as keyof EventBody]) {\n          body[field as keyof EventBody] =\n            (await this.findAndProcessMedia({\n              data: body[field as keyof EventBody],\n              traceId,\n              observationId,\n              field,\n            }).catch((e) => {\n              this._events.emit(\"error\", `Error processing multimodal event: ${e}`);\n            })) ?? body[field as keyof EventBody];\n        }\n      })\n    );\n  }\n\n  protected async findAndProcessMedia({\n    data,\n    traceId,\n    observationId,\n    field,\n  }: {\n    data: any;\n    traceId: string;\n    observationId?: string;\n    field: \"input\" | \"output\" | \"metadata\";\n  }): Promise<any> {\n    const seenObjects = new WeakMap();\n    const maxLevels = 10;\n\n    const processRecursively = async (data: any, level: number): Promise<any> => {\n      if (typeof data === \"string\" && data.startsWith(\"data:\")) {\n        const media = new LangfuseMedia({ base64DataUri: data });\n        await this.processMediaItem({ media, traceId, observationId, field });\n\n        return media;\n      }\n      if (typeof data !== \"object\" || data === null) {\n        return data;\n      }\n\n      // Use WeakMap to detect cycles\n      if (seenObjects.has(data) || level > maxLevels) {\n        return data;\n      }\n\n      seenObjects.set(data, true);\n\n      if (data instanceof LangfuseMedia || Object.prototype.toString.call(data) === \"[object LangfuseMedia]\") {\n        await this.processMediaItem({ media: data, traceId, observationId, field });\n\n        return data;\n      }\n\n      if (Array.isArray(data)) {\n        return await Promise.all(data.map((item) => processRecursively(item, level + 1)));\n      }\n\n      // Parse OpenAI input audio data which is passed as base64 string NOT in the data uri format\n      if (typeof data === \"object\" && data !== null) {\n        if (\"input_audio\" in data && typeof data[\"input_audio\"] === \"object\" && \"data\" in data.input_audio) {\n          const media = new LangfuseMedia({\n            base64DataUri: `data:audio/${data.input_audio[\"format\"] || \"wav\"};base64,${data.input_audio.data}`,\n          });\n\n          await this.processMediaItem({ media, traceId, observationId, field });\n\n          return {\n            ...data,\n            input_audio: {\n              ...data.input_audio,\n              data: media,\n            },\n          };\n        }\n\n        // OpenAI output audio data is passed as base64 string NOT in the data uri format\n        if (\"audio\" in data && typeof data[\"audio\"] === \"object\" && \"data\" in data.audio) {\n          const media = new LangfuseMedia({\n            base64DataUri: `data:audio/${data.audio[\"format\"] || \"wav\"};base64,${data.audio.data}`,\n          });\n\n          await this.processMediaItem({ media, traceId, observationId, field });\n\n          return {\n            ...data,\n            audio: {\n              ...data.audio,\n              data: media,\n            },\n          };\n        }\n\n        // Recursively process nested objects\n        return Object.fromEntries(\n          await Promise.all(\n            Object.entries(data).map(async ([key, value]) => [key, await processRecursively(value, level + 1)])\n          )\n        );\n      }\n\n      return data;\n    };\n\n    return await processRecursively(data, 1);\n  }\n\n  private async processMediaItem({\n    media,\n    traceId,\n    observationId,\n    field,\n  }: {\n    media: LangfuseMedia;\n    traceId: string;\n    observationId?: string;\n    field: string;\n  }): Promise<void> {\n    try {\n      if (!media.contentLength || !media._contentType || !media.contentSha256Hash || !media._contentBytes) {\n        return;\n      }\n\n      const getUploadUrlBody: GetMediaUploadUrlRequest = {\n        contentLength: media.contentLength,\n        traceId,\n        observationId,\n        field,\n        contentType: media._contentType,\n        sha256Hash: media.contentSha256Hash,\n      };\n\n      const fetchResponse = await this.fetch(\n        `${this.baseUrl}/api/public/media`,\n        this._getFetchOptions({\n          method: \"POST\",\n          body: JSON.stringify(getUploadUrlBody),\n        })\n      );\n\n      const uploadUrlResponse = (await fetchResponse.json()) as GetMediaUploadUrlResponse;\n\n      const { uploadUrl, mediaId } = uploadUrlResponse;\n      media._mediaId = mediaId;\n\n      if (uploadUrl) {\n        this._events.emit(\"debug\", `Uploading media ${mediaId}`);\n        const startTime = Date.now();\n        const uploadResponse = await this.fetch(uploadUrl, {\n          method: \"PUT\",\n          body: media._contentBytes,\n          headers: {\n            \"Content-Type\": media._contentType,\n            \"x-amz-checksum-sha256\": media.contentSha256Hash,\n            \"x-ms-blob-type\": \"BlockBlob\",\n          },\n        });\n\n        const patchMediaBody: PatchMediaBody = {\n          uploadedAt: new Date().toISOString(),\n          uploadHttpStatus: uploadResponse.status,\n          uploadHttpError: await uploadResponse.text(),\n          uploadTimeMs: Date.now() - startTime,\n        };\n\n        await this.fetch(\n          `${this.baseUrl}/api/public/media/${mediaId}`,\n          this._getFetchOptions({ method: \"PATCH\", body: JSON.stringify(patchMediaBody) })\n        );\n        this._events.emit(\"debug\", `Media upload status reported for ${mediaId}`);\n      } else {\n        this._events.emit(\"debug\", `Media ${mediaId} already uploaded`);\n      }\n    } catch (err) {\n      this._events.emit(\"error\", `Error processing media item: ${err}`);\n    }\n  }\n\n  /**\n   * Asynchronously flushes all events that are not yet sent to the server.\n   * This function always resolves, even if there were errors when flushing.\n   * Errors are emitted as \"error\" events and the promise resolves.\n   *\n   * @returns {Promise<void>} A promise that resolves when the flushing is completed.\n   */\n  async flushAsync(): Promise<void> {\n    await Promise.all(Object.values(this.pendingEventProcessingPromises)).catch((e) => {\n      logIngestionError(e);\n    });\n\n    return new Promise((resolve, _reject) => {\n      try {\n        this.flush((err, data) => {\n          if (err) {\n            logIngestionError(err);\n            resolve();\n          } else {\n            resolve(data);\n          }\n        });\n        // safeguard against unexpected synchronous errors\n      } catch (e) {\n        console.error(\"[Langfuse SDK] Error while flushing Langfuse\", e);\n      }\n    });\n  }\n\n  // Flushes all events that are not yet sent to the server\n  flush(callback?: (err?: any, data?: any) => void): void {\n    if (this._flushTimer) {\n      clearTimeout(this._flushTimer);\n      this._flushTimer = null;\n    }\n\n    const queue = this.getPersistedProperty<LangfuseQueueItem[]>(LangfusePersistedProperty.Queue) || [];\n\n    if (!queue.length) {\n      return callback?.();\n    }\n\n    const items = queue.splice(0, this.flushAt);\n\n    const MAX_MSG_SIZE = 1_000_000;\n    const BATCH_SIZE_LIMIT = 2_500_000;\n\n    const { processedItems, remainingItems } = this.processQueueItems(items, MAX_MSG_SIZE, BATCH_SIZE_LIMIT);\n\n    this.setPersistedProperty<LangfuseQueueItem[]>(LangfusePersistedProperty.Queue, [...remainingItems, ...queue]);\n\n    const promiseUUID = generateUUID();\n\n    const done = (err?: any): void => {\n      if (err) {\n        this._events.emit(\"error\", err);\n      }\n      callback?.(err, items);\n      this._events.emit(\"flush\", items);\n    };\n\n    // If local event export is enabled, we don't send the events to the server, but instead store them in the localEventExportMap\n    if (this.isLocalEventExportEnabled && this.projectId) {\n      if (!this.localEventExportMap.has(this.projectId)) {\n        this.localEventExportMap.set(this.projectId, [...items]);\n      } else {\n        this.localEventExportMap.get(this.projectId)?.push(...items);\n      }\n\n      done();\n      return;\n    }\n\n    const payload = JSON.stringify({\n      batch: processedItems,\n      metadata: {\n        batch_size: processedItems.length,\n        sdk_integration: this.sdkIntegration,\n        sdk_version: this.getLibraryVersion(),\n        sdk_variant: this.getLibraryId(),\n        public_key: this.publicKey,\n        sdk_name: \"langfuse-js\",\n      },\n    }); // implicit conversion also of dates to strings\n\n    const url = `${this.baseUrl}/api/public/ingestion`;\n\n    const fetchOptions = this._getFetchOptions({\n      method: \"POST\",\n      body: payload,\n    });\n\n    const requestPromise = this.fetchWithRetry(url, fetchOptions)\n      .then(() => done())\n      .catch((err) => {\n        done(err);\n      });\n    this.pendingIngestionPromises[promiseUUID] = requestPromise;\n    requestPromise.finally(() => {\n      delete this.pendingIngestionPromises[promiseUUID];\n    });\n  }\n\n  public processQueueItems(\n    queue: LangfuseQueueItem[],\n    MAX_MSG_SIZE: number,\n    BATCH_SIZE_LIMIT: number\n  ): { processedItems: LangfuseQueueItem[]; remainingItems: LangfuseQueueItem[] } {\n    let totalSize = 0;\n    const processedItems: LangfuseQueueItem[] = [];\n    const remainingItems: LangfuseQueueItem[] = [];\n\n    for (let i = 0; i < queue.length; i++) {\n      try {\n        const itemSize = new Blob([JSON.stringify(queue[i])]).size;\n\n        // discard item if it exceeds the maximum size per event\n        if (itemSize > MAX_MSG_SIZE) {\n          console.warn(`Item exceeds size limit (size: ${itemSize}), dropping item.`);\n          continue;\n        }\n\n        // if adding the next item would exceed the batch size limit, stop processing\n        if (totalSize + itemSize >= BATCH_SIZE_LIMIT) {\n          console.debug(`hit batch size limit (size: ${totalSize + itemSize})`);\n          remainingItems.push(...queue.slice(i));\n          console.log(`Remaining items: ${remainingItems.length}`);\n          console.log(`processes items: ${processedItems.length}`);\n          break;\n        }\n\n        // only add the item if it passes both requirements\n        totalSize += itemSize;\n        processedItems.push(queue[i]);\n      } catch (error) {\n        console.error(`[Langfuse SDK] ${error}`);\n        remainingItems.push(...queue.slice(i));\n        break;\n      }\n    }\n\n    return { processedItems, remainingItems };\n  }\n\n  _getFetchOptions(p: {\n    method: LangfuseFetchOptions[\"method\"];\n    body?: LangfuseFetchOptions[\"body\"];\n    fetchTimeout?: number;\n  }): LangfuseFetchOptions {\n    const fetchOptions: LangfuseFetchOptions = {\n      method: p.method,\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"X-Langfuse-Sdk-Name\": \"langfuse-js\",\n        \"X-Langfuse-Sdk-Version\": this.getLibraryVersion(),\n        \"X-Langfuse-Sdk-Variant\": this.getLibraryId(),\n        \"X-Langfuse-Sdk-Integration\": this.sdkIntegration,\n        \"X-Langfuse-Public-Key\": this.publicKey,\n        ...this.additionalHeaders,\n        ...this.constructAuthorizationHeader(this.publicKey, this.secretKey),\n      },\n      body: p.body,\n      ...(p.fetchTimeout !== undefined ? { signal: AbortSignal.timeout(p.fetchTimeout) } : {}),\n    };\n\n    return fetchOptions;\n  }\n\n  private constructAuthorizationHeader(\n    publicKey: string,\n    secretKey?: string\n  ): {\n    Authorization: string;\n  } {\n    if (secretKey === undefined) {\n      return { Authorization: \"Bearer \" + publicKey };\n    } else {\n      const encodedCredentials =\n        typeof btoa === \"function\"\n          ? // btoa() is available, the code is running in a browser or edge environment\n            btoa(publicKey + \":\" + secretKey)\n          : // btoa() is not available, the code is running in Node.js\n            Buffer.from(publicKey + \":\" + secretKey).toString(\"base64\");\n\n      return { Authorization: \"Basic \" + encodedCredentials };\n    }\n  }\n\n  private async fetchWithRetry(\n    url: string,\n    options: LangfuseFetchOptions,\n    retryOptions?: RetriableOptions\n  ): Promise<LangfuseFetchResponse> {\n    (AbortSignal as any).timeout ??= function timeout(ms: number) {\n      const ctrl = new AbortController();\n      setTimeout(() => ctrl.abort(), ms);\n      return ctrl.signal;\n    };\n\n    return await retriable(\n      async () => {\n        let res: LangfuseFetchResponse<IngestionReturnType> | null = null;\n        try {\n          res = await this.fetch(url, {\n            signal: AbortSignal.timeout(this.requestTimeout),\n            ...options,\n          });\n        } catch (e) {\n          // fetch will only throw on network errors or on timeouts\n          throw new LangfuseFetchNetworkError(e);\n        }\n\n        if (res.status < 200 || res.status >= 400) {\n          const body = await res.json();\n          throw new LangfuseFetchHttpError(res, JSON.stringify(body));\n        }\n        const returnBody = await res.json();\n        if (res.status === 207 && returnBody.errors.length > 0) {\n          throw new LangfuseFetchHttpError(res, JSON.stringify(returnBody.errors));\n        }\n\n        return res;\n      },\n      { ...this._retryOptions, ...retryOptions },\n      (string) => this._events.emit(\"retry\", string + \", \" + url + \", \" + JSON.stringify(options))\n    );\n  }\n\n  private async fetchAndLogErrors<T>(url: string, options: LangfuseFetchOptions): Promise<T> {\n    const res = await this.fetch(url, options);\n    const data = await res.json();\n\n    if (res.status < 200 || res.status >= 400) {\n      logIngestionError(new LangfuseFetchHttpError(res, JSON.stringify(data)));\n    }\n\n    return data;\n  }\n\n  async shutdownAsync(): Promise<void> {\n    clearTimeout(this._flushTimer);\n    try {\n      await this.flushAsync();\n      await Promise.all(\n        Object.values(this.pendingIngestionPromises).map((x) =>\n          x.catch(() => {\n            // ignore errors as we are shutting down and can't deal with them anyways.\n          })\n        )\n      );\n      // flush again in case there are new events that were added while we were waiting for the pending promises to resolve\n      await this.flushAsync();\n    } catch (e) {\n      console.error(\"[Langfuse SDK] Error while shutting down Langfuse\", e);\n    }\n  }\n\n  async _exportLocalEvents(projectId: string): Promise<SingleIngestionEvent[]> {\n    if (this.isLocalEventExportEnabled) {\n      clearTimeout(this._flushTimer);\n      await this.flushAsync();\n\n      const events = this.localEventExportMap.get(projectId) ?? [];\n      this.localEventExportMap.delete(projectId);\n\n      return events;\n    } else {\n      this._events.emit(\"error\", \"Local event exports are disabled, but _exportLocalEvents() was called.\");\n      return [];\n    }\n  }\n\n  shutdown(): void {\n    console.warn(\n      \"shutdown() is deprecated. It does not wait for all events to be processed. Please use shutdownAsync() instead.\"\n    );\n    void this.shutdownAsync();\n  }\n\n  protected async awaitAllQueuedAndPendingRequests(): Promise<void> {\n    clearTimeout(this._flushTimer);\n    await this.flushAsync();\n    await Promise.all(Object.values(this.pendingIngestionPromises));\n  }\n}\n\nexport abstract class LangfuseWebStateless extends LangfuseCoreStateless {\n  constructor(params: Omit<LangfuseCoreOptions, \"secretKey\">) {\n    const { flushAt, flushInterval, publicKey, enabled, ...rest } = params;\n    let isObservabilityEnabled = enabled === false ? false : true;\n\n    if (isObservabilityEnabled && !publicKey) {\n      isObservabilityEnabled = false;\n      console.warn(\n        \"Langfuse public key not passed to constructor and not set as 'LANGFUSE_PUBLIC_KEY' environment variable. No observability data will be sent to Langfuse.\"\n      );\n    }\n\n    super({\n      ...rest,\n      publicKey,\n      flushAt: flushAt ?? 1,\n      flushInterval: flushInterval ?? 0,\n      enabled: isObservabilityEnabled,\n    });\n  }\n\n  async score(body: CreateLangfuseScoreBody): Promise<this> {\n    this.scoreStateless(body);\n    await this.awaitAllQueuedAndPendingRequests();\n    return this;\n  }\n}\n\nexport abstract class LangfuseCore extends LangfuseCoreStateless {\n  private _promptCache: LangfusePromptCache;\n\n  constructor(params: LangfuseCoreOptions) {\n    const { publicKey, secretKey, enabled, _isLocalEventExportEnabled } = params;\n    let isObservabilityEnabled = enabled === false ? false : true;\n\n    if (_isLocalEventExportEnabled) {\n      isObservabilityEnabled = true;\n    } else if (!isObservabilityEnabled) {\n      console.warn(\"Langfuse is disabled. No observability data will be sent to Langfuse.\");\n    } else if (!secretKey) {\n      isObservabilityEnabled = false;\n      console.warn(\n        \"Langfuse secret key was not passed to constructor or not set as 'LANGFUSE_SECRET_KEY' environment variable. No observability data will be sent to Langfuse.\"\n      );\n    } else if (!publicKey) {\n      isObservabilityEnabled = false;\n      console.warn(\n        \"Langfuse public key was not passed to constructor or not set as 'LANGFUSE_PUBLIC_KEY' environment variable. No observability data will be sent to Langfuse.\"\n      );\n    }\n\n    super({ ...params, enabled: isObservabilityEnabled });\n    this._promptCache = new LangfusePromptCache();\n  }\n\n  trace(body?: CreateLangfuseTraceBody): LangfuseTraceClient {\n    const id = this.traceStateless(body ?? {});\n    const t = new LangfuseTraceClient(this, id);\n    if (getEnv(\"DEFER\") && body) {\n      try {\n        const deferRuntime = getEnv<DeferRuntime>(\"__deferRuntime\");\n        if (deferRuntime) {\n          deferRuntime.langfuseTraces([\n            {\n              id: id,\n              name: body.name || \"\",\n              url: t.getTraceUrl(),\n            },\n          ]);\n        }\n      } catch {}\n    }\n    return t;\n  }\n\n  span(body: CreateLangfuseSpanBody): LangfuseSpanClient {\n    const traceId = body.traceId || this.traceStateless({ name: body.name });\n    const id = this.spanStateless({ ...body, traceId });\n    return new LangfuseSpanClient(this, id, traceId);\n  }\n\n  generation(\n    body: Omit<CreateLangfuseGenerationBody, \"promptName\" | \"promptVersion\"> & PromptInput\n  ): LangfuseGenerationClient {\n    const traceId = body.traceId || this.traceStateless({ name: body.name });\n    const id = this.generationStateless({ ...body, traceId });\n    return new LangfuseGenerationClient(this, id, traceId);\n  }\n\n  event(body: CreateLangfuseEventBody): LangfuseEventClient {\n    const traceId = body.traceId || this.traceStateless({ name: body.name });\n    const id = this.eventStateless({ ...body, traceId });\n    return new LangfuseEventClient(this, id, traceId);\n  }\n\n  score(body: CreateLangfuseScoreBody): this {\n    this.scoreStateless(body);\n    return this;\n  }\n\n  async getDataset(\n    name: string,\n    options?: {\n      fetchItemsPageSize: number;\n    }\n  ): Promise<{\n    id: string;\n    name: string;\n    description?: string;\n    metadata?: any;\n    projectId: string;\n    items: DatasetItem[];\n  }> {\n    const dataset = await this._getDataset(name);\n    const items: GetLangfuseDatasetItemsResponse[\"data\"] = [];\n\n    let page = 1;\n    while (true) {\n      const itemsResponse = await this._getDatasetItems({\n        datasetName: name,\n        limit: options?.fetchItemsPageSize ?? 50,\n        page,\n      });\n      items.push(...itemsResponse.data);\n      if (itemsResponse.meta.totalPages <= page) {\n        break;\n      }\n      page++;\n    }\n\n    const returnDataset = {\n      ...dataset,\n      description: dataset.description ?? undefined,\n      metadata: dataset.metadata ?? undefined,\n      items: items.map((item) => ({\n        ...item,\n        link: async (\n          obj: LangfuseObjectClient,\n          runName: string,\n          runArgs?: {\n            description?: string;\n            metadata?: any;\n          }\n        ) => {\n          await this.awaitAllQueuedAndPendingRequests();\n          const data = await this.createDatasetRunItem({\n            runName,\n            datasetItemId: item.id,\n            observationId: obj.observationId,\n            traceId: obj.traceId,\n            runDescription: runArgs?.description,\n            metadata: runArgs?.metadata,\n          });\n          return data;\n        },\n      })),\n    };\n\n    return returnDataset;\n  }\n\n  async createPrompt(body: CreateChatPromptBody): Promise<ChatPromptClient>;\n  async createPrompt(body: CreateTextPromptBody): Promise<TextPromptClient>;\n  async createPrompt(body: CreatePromptBody): Promise<LangfusePromptClient> {\n    const labels = body.labels ?? [];\n\n    const promptResponse =\n      body.type === \"chat\" // necessary to get types right here\n        ? await this.createPromptStateless({\n            ...body,\n            labels: body.isActive ? [...new Set([...labels, \"production\"])] : labels, // backward compatibility for isActive\n          })\n        : await this.createPromptStateless({\n            ...body,\n            type: body.type ?? \"text\",\n            labels: body.isActive ? [...new Set([...labels, \"production\"])] : labels, // backward compatibility for isActive\n          });\n\n    if (promptResponse.type === \"chat\") {\n      return new ChatPromptClient(promptResponse);\n    }\n\n    return new TextPromptClient(promptResponse);\n  }\n\n  async updatePrompt(body: { name: string; version: number; newLabels: string[] }): Promise<LangfusePromptClient> {\n    const newPrompt = await this.updatePromptStateless(body);\n    this._promptCache.invalidate(body.name);\n    return newPrompt;\n  }\n\n  async getPrompt(\n    name: string,\n    version?: number,\n    options?: {\n      label?: string;\n      cacheTtlSeconds?: number;\n      fallback?: string;\n      maxRetries?: number;\n      type?: \"text\";\n      fetchTimeoutMs?: number;\n    }\n  ): Promise<TextPromptClient>;\n  async getPrompt(\n    name: string,\n    version?: number,\n    options?: {\n      label?: string;\n      cacheTtlSeconds?: number;\n      fallback?: ChatMessage[];\n      maxRetries?: number;\n      type: \"chat\";\n      fetchTimeoutMs?: number;\n    }\n  ): Promise<ChatPromptClient>;\n  async getPrompt(\n    name: string,\n    version?: number,\n    options?: {\n      label?: string;\n      cacheTtlSeconds?: number;\n      fallback?: ChatMessage[] | string;\n      maxRetries?: number;\n      type?: \"chat\" | \"text\";\n      fetchTimeoutMs?: number;\n    }\n  ): Promise<LangfusePromptClient> {\n    const cacheKey = this._getPromptCacheKey({ name, version, label: options?.label });\n    const cachedPrompt = this._promptCache.getIncludingExpired(cacheKey);\n    if (!cachedPrompt || options?.cacheTtlSeconds === 0) {\n      try {\n        return await this._fetchPromptAndUpdateCache({\n          name,\n          version,\n          label: options?.label,\n          cacheTtlSeconds: options?.cacheTtlSeconds,\n          maxRetries: options?.maxRetries,\n          fetchTimeout: options?.fetchTimeoutMs,\n        });\n      } catch (err) {\n        if (options?.fallback) {\n          const sharedFallbackParams = {\n            name,\n            version: version ?? 0,\n            labels: options.label ? [options.label] : [],\n            cacheTtlSeconds: options?.cacheTtlSeconds,\n            config: {},\n            tags: [],\n          };\n\n          if (options.type === \"chat\") {\n            return new ChatPromptClient(\n              {\n                ...sharedFallbackParams,\n                type: \"chat\",\n                prompt: options.fallback as ChatMessage[],\n              },\n              true\n            );\n          } else {\n            return new TextPromptClient(\n              {\n                ...sharedFallbackParams,\n                type: \"text\",\n                prompt: options.fallback as string,\n              },\n              true\n            );\n          }\n        }\n\n        throw err;\n      }\n    }\n\n    if (cachedPrompt.isExpired) {\n      // If the cache is not currently being refreshed, start refreshing it and register the promise in the cache\n      if (!this._promptCache.isRefreshing(cacheKey)) {\n        const refreshPromptPromise = this._fetchPromptAndUpdateCache({\n          name,\n          version,\n          label: options?.label,\n          cacheTtlSeconds: options?.cacheTtlSeconds,\n          maxRetries: options?.maxRetries,\n          fetchTimeout: options?.fetchTimeoutMs,\n        }).catch(() => {\n          console.warn(\n            `Failed to refresh prompt cache '${cacheKey}', stale cache will be used until next refresh succeeds.`\n          );\n        });\n        this._promptCache.addRefreshingPromise(cacheKey, refreshPromptPromise);\n      }\n\n      return cachedPrompt.value;\n    }\n\n    return cachedPrompt.value;\n  }\n\n  private _getPromptCacheKey(params: { name: string; version?: number; label?: string }): string {\n    const { name, version, label } = params;\n    const parts = [name];\n\n    if (version !== undefined) {\n      parts.push(\"version:\" + version.toString());\n    } else if (label !== undefined) {\n      parts.push(\"label:\" + label);\n    } else {\n      parts.push(\"label:production\");\n    }\n\n    return parts.join(\"-\");\n  }\n\n  private async _fetchPromptAndUpdateCache(params: {\n    name: string;\n    version?: number;\n    cacheTtlSeconds?: number;\n    label?: string;\n    maxRetries?: number;\n    fetchTimeout?: number;\n  }): Promise<LangfusePromptClient> {\n    const cacheKey = this._getPromptCacheKey(params);\n\n    try {\n      const { name, version, cacheTtlSeconds, label, maxRetries, fetchTimeout } = params;\n\n      const { data, fetchResult } = await this.getPromptStateless(name, version, label, maxRetries, fetchTimeout);\n      if (fetchResult === \"failure\") {\n        throw Error(data.message ?? \"Internal error while fetching prompt\");\n      }\n\n      let prompt: LangfusePromptClient;\n      if (data.type === \"chat\") {\n        prompt = new ChatPromptClient(data);\n      } else {\n        prompt = new TextPromptClient(data);\n      }\n\n      this._promptCache.set(cacheKey, prompt, cacheTtlSeconds);\n\n      return prompt;\n    } catch (error) {\n      console.error(`[Langfuse SDK] Error while fetching prompt '${cacheKey}':`, error);\n\n      throw error;\n    }\n  }\n\n  public async fetchMedia(id: string): Promise<GetMediaResponse> {\n    return await this._fetchMedia(id);\n  }\n\n  /**\n   * Replaces the media reference strings in an object with base64 data URIs for the media content.\n   *\n   * This method recursively traverses an object (up to a maximum depth of 10) looking for media reference strings\n   * in the format \"@@@langfuseMedia:...@@@\". When found, it fetches the actual media content using the provided\n   * Langfuse client and replaces the reference string with a base64 data URI.\n   *\n   * If fetching media content fails for a reference string, a warning is logged and the reference string is left unchanged.\n   *\n   * @param params - Configuration object\n   * @param params.obj - The object to process. Can be a primitive value, array, or nested object\n   * @param params.langfuseClient - Langfuse client instance used to fetch media content\n   * @param params.resolveWith - The representation of the media content to replace the media reference string with. Currently only \"base64DataUri\" is supported.\n   * @param params.maxDepth - Optional. Default is 10. The maximum depth to traverse the object.\n   *\n   * @returns A deep copy of the input object with all media references replaced with base64 data URIs where possible\n   *\n   * @example\n   * ```typescript\n   * const obj = {\n   *   image: \"@@@langfuseMedia:type=image/jpeg|id=123|source=bytes@@@\",\n   *   nested: {\n   *     pdf: \"@@@langfuseMedia:type=application/pdf|id=456|source=bytes@@@\"\n   *   }\n   * };\n   *\n   * const result = await LangfuseMedia.resolveMediaReferences({\n   *   obj,\n   *   langfuseClient\n   * });\n   *\n   * // Result:\n   * // {\n   * //   image: \"data:image/jpeg;base64,/9j/4AAQSkZJRg...\",\n   * //   nested: {\n   * //     pdf: \"data:application/pdf;base64,JVBERi0xLjcK...\"\n   * //   }\n   * // }\n   * ```\n   */\n  public async resolveMediaReferences<T>(\n    params: Omit<LangfuseMediaResolveMediaReferencesParams<T>, \"langfuseClient\">\n  ): Promise<T> {\n    const { obj, ...rest } = params;\n\n    return LangfuseMedia.resolveMediaReferences<T>({ ...rest, langfuseClient: this, obj });\n  }\n  _updateSpan(body: UpdateLangfuseSpanBody): this {\n    this.updateSpanStateless(body);\n    return this;\n  }\n\n  _updateGeneration(body: UpdateLangfuseGenerationBody): this {\n    this.updateGenerationStateless(body);\n    return this;\n  }\n}\n\nexport abstract class LangfuseObjectClient {\n  public readonly client: LangfuseCore;\n  public readonly id: string; // id of item itself\n  public readonly traceId: string; // id of trace, if traceClient this is the same as id\n  public readonly observationId: string | null; // id of observation, if observationClient this is the same as id, if traceClient this is null\n\n  constructor({\n    client,\n    id,\n    traceId,\n    observationId,\n  }: {\n    client: LangfuseCore;\n    id: string;\n    traceId: string;\n    observationId: string | null;\n  }) {\n    this.client = client;\n    this.id = id;\n    this.traceId = traceId;\n    this.observationId = observationId;\n  }\n\n  event(body: Omit<CreateLangfuseEventBody, \"traceId\" | \"parentObservationId\">): LangfuseEventClient {\n    return this.client.event({\n      ...body,\n      traceId: this.traceId,\n      parentObservationId: this.observationId,\n    });\n  }\n\n  span(body: Omit<CreateLangfuseSpanBody, \"traceId\" | \"parentObservationId\">): LangfuseSpanClient {\n    return this.client.span({\n      ...body,\n      traceId: this.traceId,\n      parentObservationId: this.observationId,\n    });\n  }\n\n  generation(\n    body: Omit<CreateLangfuseGenerationBody, \"traceId\" | \"parentObservationId\" | \"promptName\" | \"promptVersion\"> &\n      PromptInput\n  ): LangfuseGenerationClient {\n    return this.client.generation({\n      ...body,\n      traceId: this.traceId,\n      parentObservationId: this.observationId,\n    });\n  }\n\n  score(body: Omit<CreateLangfuseScoreBody, \"traceId\" | \"parentObservationId\">): this {\n    this.client.score({\n      ...body,\n      traceId: this.traceId,\n      observationId: this.observationId,\n    });\n    return this;\n  }\n\n  getTraceUrl(): string {\n    return `${this.client.baseUrl}/trace/${this.traceId}`;\n  }\n}\n\nexport class LangfuseTraceClient extends LangfuseObjectClient {\n  constructor(client: LangfuseCore, traceId: string) {\n    super({ client, id: traceId, traceId, observationId: null });\n  }\n\n  update(body: Omit<CreateLangfuseTraceBody, \"id\">): this {\n    this.client.trace({\n      ...body,\n      id: this.id,\n    });\n    return this;\n  }\n}\n\nabstract class LangfuseObservationClient extends LangfuseObjectClient {\n  constructor(client: LangfuseCore, id: string, traceId: string) {\n    super({ client, id, traceId, observationId: id });\n  }\n}\n\nexport class LangfuseSpanClient extends LangfuseObservationClient {\n  constructor(client: LangfuseCore, id: string, traceId: string) {\n    super(client, id, traceId);\n  }\n\n  update(body: Omit<UpdateLangfuseSpanBody, \"id\" | \"traceId\">): this {\n    this.client._updateSpan({\n      ...body,\n      id: this.id,\n      traceId: this.traceId,\n    });\n    return this;\n  }\n\n  end(body?: Omit<UpdateLangfuseSpanBody, \"id\" | \"endTime\" | \"traceId\">): this {\n    this.client._updateSpan({\n      ...body,\n      id: this.id,\n      traceId: this.traceId,\n      endTime: new Date(),\n    });\n    return this;\n  }\n}\n\nexport class LangfuseGenerationClient extends LangfuseObservationClient {\n  constructor(client: LangfuseCore, id: string, traceId: string) {\n    super(client, id, traceId);\n  }\n\n  update(\n    body: Omit<UpdateLangfuseGenerationBody, \"id\" | \"traceId\" | \"promptName\" | \"promptVersion\"> & PromptInput\n  ): this {\n    this.client._updateGeneration({\n      ...body,\n      id: this.id,\n      traceId: this.traceId,\n    });\n    return this;\n  }\n\n  end(\n    body?: Omit<UpdateLangfuseGenerationBody, \"id\" | \"traceId\" | \"endTime\" | \"promptName\" | \"promptVersion\"> &\n      PromptInput\n  ): this {\n    this.client._updateGeneration({\n      ...body,\n      id: this.id,\n      traceId: this.traceId,\n      endTime: new Date(),\n    });\n    return this;\n  }\n}\n\nexport class LangfuseEventClient extends LangfuseObservationClient {\n  constructor(client: LangfuseCore, id: string, traceId: string) {\n    super(client, id, traceId);\n  }\n}\n\nexport * from \"./types\";\nexport * from \"./openapi/server\";\n"],"names":["SimpleEventEmitter","constructor","events","on","event","listener","push","filter","x","emit","payload","DEFAULT_PROMPT_CACHE_TTL_SECONDS","LangfusePromptCacheItem","value","ttlSeconds","_expiry","Date","now","isExpired","LangfusePromptCache","_cache","Map","_defaultTtlSeconds","_refreshingKeys","getIncludingExpired","key","get","set","effectiveTtlSeconds","addRefreshingPromise","promise","then","delete","catch","isRefreshing","has","invalidate","promptName","console","log","keys","startsWith","mustache","escape","text","BasePromptClient","prompt","isFallback","type","name","version","config","labels","tags","_transformToLangchainVariables","content","replace","toJSON","JSON","stringify","TextPromptClient","promptResponse","compile","variables","render","getLangchainPrompt","ChatPromptClient","map","chatMessage","assert","truthyValue","message","Error","removeTrailingSlash","url","retriable","fn","props","retryCount","retryDelay","retryCheck","lastError","i","Promise","resolve","setTimeout","res","e","generateUUID","globalThis","d","getTime","d2","performance","c","r","Math","random","floor","toString","currentTimestamp","currentISOTime","toISOString","safeSetTimeout","timeout","t","unref","getEnv","process","env","configLangfuseSDK","params","secretRequired","publicKey","secretKey","coreOptions","finalPublicKey","finalSecretKey","undefined","finalBaseUrl","baseUrl","finalCoreOptions","encodeQueryParams","queryParams","URLSearchParams","Object","entries","forEach","append","common_release_envs","getCommonReleaseEnvs","LangfusePersistedProperty","fs","cryptoModule","dynamicImport","module","Deno","all","importedFs","importedCrypto","versions","node","crypto","LangfuseMedia","obj","base64DataUri","contentType","contentBytes","filePath","_mediaId","contentBytesParsed","contentTypeParsed","parseBase64DataUri","_contentBytes","_contentType","_source","existsSync","readFile","error","readFileSync","data","header","actualData","slice","split","headerParts","includes","Buffer","from","contentLength","length","contentSha256Hash","sha256Hash","createHash","update","digest","parseReferenceString","referenceString","prefix","suffix","endsWith","pairs","parsedData","pair","mediaId","source","resolveMediaReferences","langfuseClient","maxDepth","traverse","depth","regex","referenceStringMatches","match","result","referenceStringToMediaContentMap","parsedMediaReference","mediaData","fetchMedia","mediaContent","fetch","method","headers","status","base64MediaContent","arrayBuffer","warn","replaceAll","Array","isArray","item","fromEntries","LangfuseMemoryStorage","_memoryStorage","getProperty","setProperty","MAX_EVENT_SIZE","LangfuseFetchHttpError","response","body","LangfuseFetchNetworkError","cause","isLangfuseFetchHttpError","isLangfuseFetchNetworkError","isLangfuseFetchError","err","SUPPORT_URL","API_DOCS_URL","RBAC_DOCS_URL","INSTALLATION_DOCS_URL","RATE_LIMITS_URL","NPM_PACKAGE_URL","updatePromptResponse","defaultServerErrorPrompt","defaultErrorResponse","errorResponseByCode","getErrorResponseByCode","code","errorResponse","logIngestionError","LangfuseCoreStateless","additionalHeaders","debugMode","pendingEventProcessingPromises","pendingIngestionPromises","localEventExportMap","_events","enabled","_projectId","_isLocalEventExportEnabled","options","flushAt","max","flushInterval","release","mask","_retryOptions","fetchRetryCount","fetchRetryDelay","requestTimeout","sdkIntegration","isLocalEventExportEnabled","projectId","getSdkIntegration","getCommonEventProperties","$lib","getLibraryId","$lib_version","getLibraryVersion","cb","debug","removeDebugCallback","traceStateless","id","bodyId","timestamp","bodyTimestamp","bodyRelease","rest","parsedBody","enqueue","eventStateless","startTime","bodyStartTime","spanStateless","generationStateless","promptDetails","promptVersion","scoreStateless","updateSpanStateless","updateGenerationStateless","_getDataset","encodedName","encodeURIComponent","fetchAndLogErrors","_getFetchOptions","_getDatasetItems","query","_fetchMedia","fetchTraces","meta","fetchTrace","traceId","fetchObservations","fetchObservation","observationId","fetchSessions","getDatasetRun","encodedDatasetName","datasetName","encodedRunName","runName","getDatasetRuns","createDatasetRunItem","createDataset","dataset","createDatasetItem","getDatasetItem","_parsePayload","parse","createPromptStateless","updatePromptStateless","getPromptStateless","label","maxRetries","size","boundedMaxRetries","_getBoundedMaxRetries","defaultMaxRetries","maxRetriesUpperBound","retryOptions","retryLogger","string","fetchTimeout","json","fetchResult","min","processEnqueueEvent","promiseId","finally","maskEventBodyInPlace","processMediaInEvent","finalEventBody","truncateEventBody","queue","getPersistedProperty","Queue","metadata","setPersistedProperty","flush","_flushTimer","maskableKeys","maxByteSize","bodySize","getByteSize","keysToCheck","keySizes","sort","a","b","currentSize","prototype","hasOwnProperty","call","serialized","TextEncoder","encode","field","findAndProcessMedia","seenObjects","WeakMap","maxLevels","processRecursively","level","media","processMediaItem","input_audio","audio","getUploadUrlBody","fetchResponse","uploadUrlResponse","uploadUrl","uploadResponse","patchMediaBody","uploadedAt","uploadHttpStatus","uploadHttpError","uploadTimeMs","flushAsync","values","_reject","callback","clearTimeout","items","splice","MAX_MSG_SIZE","BATCH_SIZE_LIMIT","processedItems","remainingItems","processQueueItems","promiseUUID","done","batch","batch_size","sdk_integration","sdk_version","sdk_variant","public_key","sdk_name","fetchOptions","requestPromise","fetchWithRetry","totalSize","itemSize","Blob","p","constructAuthorizationHeader","signal","AbortSignal","Authorization","encodedCredentials","btoa","ms","ctrl","AbortController","abort","returnBody","errors","shutdownAsync","_exportLocalEvents","shutdown","awaitAllQueuedAndPendingRequests","LangfuseWebStateless","isObservabilityEnabled","score","LangfuseCore","_promptCache","trace","LangfuseTraceClient","deferRuntime","langfuseTraces","getTraceUrl","span","LangfuseSpanClient","generation","LangfuseGenerationClient","LangfuseEventClient","getDataset","page","itemsResponse","limit","fetchItemsPageSize","totalPages","returnDataset","description","link","runArgs","datasetItemId","runDescription","createPrompt","isActive","Set","updatePrompt","newPrompt","getPrompt","cacheKey","_getPromptCacheKey","cachedPrompt","cacheTtlSeconds","_fetchPromptAndUpdateCache","fetchTimeoutMs","fallback","sharedFallbackParams","refreshPromptPromise","parts","join","_updateSpan","_updateGeneration","LangfuseObjectClient","client","parentObservationId","LangfuseObservationClient","end","endTime"],"mappings":"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"}