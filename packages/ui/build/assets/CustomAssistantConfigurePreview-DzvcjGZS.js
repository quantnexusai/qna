import{a3 as J,P as U,r,x as Ge,y as Fe,j as e,D as Bt,q as _t,t as Rt,w,v as Et,A as $t,I as B,K as qe,L as Ve,u as Nt,a as Lt,R as Re,b as W,ac as Ht,c as be,ad as Ee,M as zt,S as z,B as b,ae as Gt,T as $,h as te,af as ae,ag as Ft,ah as I,ai as oe}from"./index-ChaGAcYI.js";import{i as qt}from"./index-BB2M58Id.js";import{u as Vt,C as Wt}from"./ConfirmDialog-UiX2DWMF.js";import{B as Ut}from"./BackdropLoader-Bk819Nkp.js";import{D as $e}from"./DocStoreInputHandler-BMB7Pkpl.js";import{D as Ne}from"./Dropdown-CAgC4_Zg.js";import{S as Jt}from"./StyledFab-cwi8e6Ef.js";import{E as Kt}from"./ErrorBoundary-CHfNOSqb.js";import{a as we}from"./TooltipWithParser-BlaLodP6.js";import{M as Yt}from"./MultiDropdown-CVP0hAYx.js";import{I as We,A as Xt,S as Qt,V as Zt,a as ea,C as ta}from"./index-D_fiKHt2.js";import{S as aa}from"./StyledButton-8-5Nm6DU.js";import{a as N}from"./assistants-Cf66v-4_.js";import{O as ne}from"./OutlinedInput-CAVpSyYT.js";import{L as oa,E as sa}from"./ManageScrapedLinksDialog-D3mQCFNI.js";import{I as Ue}from"./IconArrowLeft-Db9vzZ6o.js";import{I as na}from"./IconLanguage-Ck-NidEz.js";import{c as se}from"./chatflows-BxHmJ8YJ.js";import{n as Le}from"./nodes-CUAgL10n.js";import{d as ra}from"./documentstore-CAsbbKXX.js";import{G as Ce}from"./Grid-DFqYxbJF.js";import{I as ia}from"./IconDeviceFloppy-BlS5L8Do.js";import{I as He}from"./IconTrash-BdsDnRZh.js";import{I as ve}from"./IconSearch-BD2fMQi-.js";import{I as la}from"./CredentialListDialog-B9g1KDco.js";import"./CircularProgress-Cz104Ocn.js";import"./CredentialInputHandler-CJNRLMLX.js";import"./TextField-CLvwMhB0.js";import"./FormControl-BLGDakJE.js";import"./Menu-CVBFicbZ.js";import"./Popover-DmQCuS9U.js";import"./Input-CaaPJDv5.js";import"./File-CvlqKb-z.js";import"./CodeEditor-DWi0nNjN.js";import"./IconCopy-Si0QIoMO.js";import"./CodeBlock-CD5vwQYW.js";import"./toPropertyKey-BMrx9eIY.js";import"./ExpandMore-DMM7gXG5.js";import"./Tabs-CXvjk-qM.js";import"./DataGrid-D9ByEn2k.js";import"./Delete-B3djbOl0.js";import"./IconPlus-DXcgeM4H.js";import"./apikey-B4w3JFmX.js";import"./variables-BI8XUdeL.js";import"./Table-BsVIwlFv.js";import"./IconBulb-B48kIpPx.js";import"./main-ByC2YqwJ.js";import"./StatsCard-Bz-yfMnY.js";import"./SpeechToText-RiMip2cs.js";import"./IconTemplate-D92INwWa.js";/**
 * @license @tabler/icons-react v3.29.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var ca=J("outline","mail","IconMail",[["path",{d:"M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z",key:"svg-0"}],["path",{d:"M3 7l9 6l9 -6",key:"svg-1"}]]);/**
 * @license @tabler/icons-react v3.29.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var da=J("outline","notebook","IconNotebook",[["path",{d:"M6 4h11a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-11a1 1 0 0 1 -1 -1v-14a1 1 0 0 1 1 -1m3 0v18",key:"svg-0"}],["path",{d:"M13 8l2 0",key:"svg-1"}],["path",{d:"M13 12l2 0",key:"svg-2"}]]);/**
 * @license @tabler/icons-react v3.29.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var pa=J("outline","report","IconReport",[["path",{d:"M8 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h5.697",key:"svg-0"}],["path",{d:"M18 14v4h4",key:"svg-1"}],["path",{d:"M18 11v-4a2 2 0 0 0 -2 -2h-2",key:"svg-2"}],["path",{d:"M8 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z",key:"svg-3"}],["path",{d:"M18 18m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0",key:"svg-4"}],["path",{d:"M8 11h4",key:"svg-5"}],["path",{d:"M8 15h3",key:"svg-6"}]]);/**
 * @license @tabler/icons-react v3.29.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var je=J("outline","wand","IconWand",[["path",{d:"M6 21l15 -15l-3 -3l-15 15l3 3",key:"svg-0"}],["path",{d:"M15 6l3 3",key:"svg-1"}],["path",{d:"M9 3a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2",key:"svg-2"}],["path",{d:"M19 13a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2",key:"svg-3"}]]);/**
 * @license @tabler/icons-react v3.29.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var ua=J("outline","world","IconWorld",[["path",{d:"M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0",key:"svg-0"}],["path",{d:"M3.6 9h16.8",key:"svg-1"}],["path",{d:"M3.6 15h16.8",key:"svg-2"}],["path",{d:"M11.5 3a17 17 0 0 0 0 18",key:"svg-3"}],["path",{d:"M12.5 3a17 17 0 0 1 0 18",key:"svg-4"}]]);const ma=[{text:"Summarize a document",img:e.jsx(da,{})},{text:"Translate the language",img:e.jsx(na,{})},{text:"Write me an email",img:e.jsx(ca,{})},{text:"Convert the code to another language",img:e.jsx(We,{})},{text:"Research and generate a report",img:e.jsx(pa,{})},{text:"Plan a trip",img:e.jsx(ua,{})}],Je=({show:A,dialogProps:l,onCancel:G,onConfirm:P})=>{const K=document.getElementById("portal"),[S,v]=r.useState(""),[f,M]=r.useState(""),[k,D]=r.useState(!1),Y=Ge();Fe();const ie=(...u)=>Y(qe(...u)),le=(...u)=>Y(Ve(...u)),ce=async()=>{try{D(!0);const u={name:l.data.selectedChatModel.name,inputs:l.data.selectedChatModel.inputs},x=await N.generateAssistantInstruction({selectedChatModel:u,task:S});x.data&&(D(!1),x.data.content&&M(x.data.content))}catch(u){D(!1),ie({message:typeof u.response.data=="object"?u.response.data.message:u.response.data,options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!0,action:x=>e.jsx(w,{style:{color:"white"},onClick:()=>le(x),children:e.jsx(B,{})})}})}};r.useEffect(()=>{A||(v(""),M(""))},[A]);const c=A?e.jsx(e.Fragment,{children:e.jsxs(Bt,{fullWidth:!0,maxWidth:"md",open:A,onClose:G,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[e.jsx(_t,{sx:{fontSize:"1rem"},id:"alert-dialog-title",children:l.title}),e.jsxs(Rt,{children:[e.jsx("span",{children:l.description}),e.jsx("div",{style:{display:"block",flexDirection:"row",width:"100%",marginTop:"15px"},children:ma.map((u,x)=>e.jsx(w,{size:"small",sx:{textTransform:"none",mr:1,mb:1,borderRadius:"16px"},variant:"outlined",color:"inherit",onClick:()=>{v(u.text),M("")},startIcon:u.img,children:u.text},x))}),!f&&e.jsx(ne,{sx:{mt:2,width:"100%"},type:"text",multiline:!0,rows:12,disabled:k,value:S,placeholder:"Describe your task here",onChange:u=>v(u.target.value)}),f&&e.jsx(ne,{sx:{mt:2,width:"100%"},type:"text",multiline:!0,rows:12,value:f,onChange:u=>M(u.target.value)})]}),e.jsxs(Et,{sx:{pb:3,pr:3},children:[!f&&e.jsx(oa,{loading:k,variant:"contained",onClick:()=>{ce()},startIcon:e.jsx(je,{size:20}),children:"Generate"}),f&&e.jsx(w,{variant:"outlined",startIcon:e.jsx(Ue,{size:20}),onClick:()=>{M("")},children:"Back"}),f&&e.jsx(aa,{variant:"contained",onClick:()=>P(f),children:"Apply"})]})]})}):null;return $t.createPortal(c,K)};Je.propTypes={show:U.bool,dialogProps:U.object,onConfirm:U.func,onCancel:U.func};const ze={nodes:[{id:"bufferMemory_0",data:{id:"bufferMemory_0",label:"Buffer Memory",version:2,name:"bufferMemory",type:"BufferMemory",baseClasses:["BufferMemory","BaseChatMemory","BaseMemory"],category:"Memory",description:"Retrieve chat messages stored in database",inputParams:[{label:"Session Id",name:"sessionId",type:"string",description:'If not specified, a random id will be used. Learn <a target="_blank" href="https://docs.flowiseai.com/memory#ui-and-embedded-chat">more</a>',default:"",additionalParams:!0,optional:!0,id:"bufferMemory_0-input-sessionId-string"},{label:"Memory Key",name:"memoryKey",type:"string",default:"chat_history",additionalParams:!0,id:"bufferMemory_0-input-memoryKey-string"}],inputAnchors:[],inputs:{sessionId:"",memoryKey:"chat_history"},outputAnchors:[{id:"bufferMemory_0-output-bufferMemory-BufferMemory|BaseChatMemory|BaseMemory",name:"bufferMemory",label:"BufferMemory",description:"Retrieve chat messages stored in database",type:"BufferMemory | BaseChatMemory | BaseMemory"}],outputs:{}}},{id:"chatOpenAI_0",data:{id:"chatOpenAI_0",label:"ChatOpenAI",version:8,name:"chatOpenAI",type:"ChatOpenAI",baseClasses:["ChatOpenAI","BaseChatModel","BaseLanguageModel","Runnable"],category:"Chat Models",description:"Wrapper around OpenAI large language models that use the Chat endpoint",inputParams:[{label:"Connect Credential",name:"credential",type:"credential",credentialNames:["openAIApi"],id:"chatOpenAI_0-input-credential-credential"},{label:"Model Name",name:"modelName",type:"asyncOptions",loadMethod:"listModels",default:"gpt-4o-mini",id:"chatOpenAI_0-input-modelName-asyncOptions"},{label:"Temperature",name:"temperature",type:"number",step:.1,default:.9,optional:!0,id:"chatOpenAI_0-input-temperature-number"},{label:"Streaming",name:"streaming",type:"boolean",default:!0,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-streaming-boolean"},{label:"Max Tokens",name:"maxTokens",type:"number",step:1,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-maxTokens-number"},{label:"Top Probability",name:"topP",type:"number",step:.1,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-topP-number"},{label:"Frequency Penalty",name:"frequencyPenalty",type:"number",step:.1,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-frequencyPenalty-number"},{label:"Presence Penalty",name:"presencePenalty",type:"number",step:.1,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-presencePenalty-number"},{label:"Timeout",name:"timeout",type:"number",step:1,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-timeout-number"},{label:"BasePath",name:"basepath",type:"string",optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-basepath-string"},{label:"Proxy Url",name:"proxyUrl",type:"string",optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-proxyUrl-string"},{label:"Stop Sequence",name:"stopSequence",type:"string",rows:4,optional:!0,description:"List of stop words to use when generating. Use comma to separate multiple stop words.",additionalParams:!0,id:"chatOpenAI_0-input-stopSequence-string"},{label:"BaseOptions",name:"baseOptions",type:"json",optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-baseOptions-json"},{label:"Allow Image Uploads",name:"allowImageUploads",type:"boolean",description:'Allow image input. Refer to the <a href="https://docs.flowiseai.com/using-flowise/uploads#image" target="_blank">docs</a> for more details.',default:!1,optional:!0,id:"chatOpenAI_0-input-allowImageUploads-boolean"},{label:"Image Resolution",description:"This parameter controls the resolution in which the model views the image.",name:"imageResolution",type:"options",options:[{label:"Low",name:"low"},{label:"High",name:"high"},{label:"Auto",name:"auto"}],default:"low",optional:!1,additionalParams:!0,id:"chatOpenAI_0-input-imageResolution-options"}],inputAnchors:[{label:"Cache",name:"cache",type:"BaseCache",optional:!0,id:"chatOpenAI_0-input-cache-BaseCache"}],inputs:{cache:"",modelName:"gpt-4o-mini",temperature:.9,streaming:!0,maxTokens:"",topP:"",frequencyPenalty:"",presencePenalty:"",timeout:"",basepath:"",proxyUrl:"",stopSequence:"",baseOptions:"",allowImageUploads:"",imageResolution:"low"},outputAnchors:[{id:"chatOpenAI_0-output-chatOpenAI-ChatOpenAI|BaseChatModel|BaseLanguageModel|Runnable",name:"chatOpenAI",label:"ChatOpenAI",description:"Wrapper around OpenAI large language models that use the Chat endpoint",type:"ChatOpenAI | BaseChatModel | BaseLanguageModel | Runnable"}],outputs:{}}},{id:"toolAgent_0",data:{id:"toolAgent_0",label:"Tool Agent",version:2,name:"toolAgent",type:"AgentExecutor",baseClasses:["AgentExecutor","BaseChain","Runnable"],category:"Agents",description:"Agent that uses Function Calling to pick the tools and args to call",inputParams:[{label:"System Message",name:"systemMessage",type:"string",default:"You are a helpful AI assistant.",description:"If Chat Prompt Template is provided, this will be ignored",rows:4,optional:!0,additionalParams:!0,id:"toolAgent_0-input-systemMessage-string"},{label:"Max Iterations",name:"maxIterations",type:"number",optional:!0,additionalParams:!0,id:"toolAgent_0-input-maxIterations-number"}],inputAnchors:[{label:"Tools",name:"tools",type:"Tool",list:!0,id:"toolAgent_0-input-tools-Tool"},{label:"Memory",name:"memory",type:"BaseChatMemory",id:"toolAgent_0-input-memory-BaseChatMemory"},{label:"Tool Calling Chat Model",name:"model",type:"BaseChatModel",description:"Only compatible with models that are capable of function calling: ChatOpenAI, ChatMistral, ChatAnthropic, ChatGoogleGenerativeAI, ChatVertexAI, GroqChat",id:"toolAgent_0-input-model-BaseChatModel"},{label:"Chat Prompt Template",name:"chatPromptTemplate",type:"ChatPromptTemplate",description:"Override existing prompt with Chat Prompt Template. Human Message must includes {input} variable",optional:!0,id:"toolAgent_0-input-chatPromptTemplate-ChatPromptTemplate"},{label:"Input Moderation",description:"Detect text that could generate harmful output and prevent it from being sent to the language model",name:"inputModeration",type:"Moderation",optional:!0,list:!0,id:"toolAgent_0-input-inputModeration-Moderation"}],inputs:{tools:[],memory:"{{bufferMemory_0.data.instance}}",model:"{{chatOpenAI_0.data.instance}}",chatPromptTemplate:"",systemMessage:"You are helpful assistant",inputModeration:"",maxIterations:""},outputAnchors:[{id:"toolAgent_0-output-toolAgent-AgentExecutor|BaseChain|Runnable",name:"toolAgent",label:"AgentExecutor",description:"Agent that uses Function Calling to pick the tools and args to call",type:"AgentExecutor | BaseChain | Runnable"}],outputs:{}}}],edges:[{source:"bufferMemory_0",sourceHandle:"bufferMemory_0-output-bufferMemory-BufferMemory|BaseChatMemory|BaseMemory",target:"toolAgent_0",targetHandle:"toolAgent_0-input-memory-BaseChatMemory",type:"buttonedge",id:"bufferMemory_0-bufferMemory_0-output-bufferMemory-BufferMemory|BaseChatMemory|BaseMemory-toolAgent_0-toolAgent_0-input-memory-BaseChatMemory"},{source:"chatOpenAI_0",sourceHandle:"chatOpenAI_0-output-chatOpenAI-ChatOpenAI|BaseChatModel|BaseLanguageModel|Runnable",target:"toolAgent_0",targetHandle:"toolAgent_0-input-model-BaseChatModel",type:"buttonedge",id:"chatOpenAI_0-chatOpenAI_0-output-chatOpenAI-ChatOpenAI|BaseChatModel|BaseLanguageModel|Runnable-toolAgent_0-toolAgent_0-input-model-BaseChatModel"}]},re=r.memo(({...A})=>e.jsx("div",{children:e.jsx(qt,{...A})}),(A,l)=>A.chatflow===l.chatflow);re.displayName="MemoizedFullPageChat";re.propTypes={chatflow:U.object};const po=()=>{const A=Nt(),l=Lt(),G=r.useRef(),P=Re(t=>t.canvas),K=Re(t=>t.customization),S=W(N.getSpecificAssistant),v=W(N.getChatModels),f=W(N.getDocStores),M=W(N.getTools),k=W(se.getSpecificChatflow),{id:D}=Ht(),[Y,ie]=r.useState([]),[le,ce]=r.useState([]),[c,u]=r.useState({}),[x,Ke]=r.useState({}),[X,Q]=r.useState("You are helpful assistant"),[j,Ae]=r.useState(),[de,Ye]=r.useState([]),[m,L]=r.useState([]),[Xe,Qe]=r.useState([]),[Ze,et]=r.useState([]),[y,F]=r.useState([]),[Me,Ie]=r.useState(!1),[tt,at]=r.useState({}),[ot,Se]=r.useState(!1),[st,nt]=r.useState({}),[rt,ke]=r.useState(!1),[it,lt]=r.useState({}),[ct,De]=r.useState(!1),[dt,pt]=r.useState({}),[pe,ue]=r.useState(!1),[ut,me]=r.useState(!1),[mt,ht]=r.useState({}),[gt,he]=r.useState(!1),[ft,yt]=r.useState({}),[Te,H]=r.useState(!1),[q,ge]=r.useState(!0),[Pe,Z]=r.useState(null),ee=Ge(),{confirm:xt}=Vt();Fe();const _=(...t)=>ee(qe(...t)),R=(...t)=>ee(Ve(...t)),fe=()=>{_({message:"Please fill in all mandatory fields.",options:{key:new Date().getTime()+Math.random(),variant:"warning",action:t=>e.jsx(w,{style:{color:"white"},onClick:()=>R(t),children:e.jsx(B,{})})}})},ye=()=>{let t=!0;const o=(c.inputParams??[]).filter(a=>!a.hidden);for(const a of o)if(!a.optional&&(!c.inputs[a.name]||!c.credential)){if(a.type==="credential"&&!c.credential){t=!1;break}else if(a.type!=="credential"&&!c.inputs[a.name]){t=!1;break}}if(y.length>0)for(let a=0;a<y.length;a++){const s=y[a],i=(s.inputParams??[]).filter(n=>!n.hidden);for(const n of i)if(!n.optional&&(!s.inputs[n.name]||!s.credential)){if(n.type==="credential"&&!s.credential){t=!1;break}else if(n.type!=="credential"&&!s.inputs[n.name]){t=!1;break}}}return t},bt=()=>{let t=!0;if((!c||!c.name)&&(t=!1),t=ye(),m.length>0){for(let o=0;o<m.length;o++)if(!m[o].description){t=!1;break}}return t||fe(),t},Oe=async()=>{if(bt()){H(!0);const t=await vt();if(!t)return;const o={id:D,name:x.name,flowData:JSON.stringify(t),type:"ASSISTANT"};try{let a;if(j?a=await se.updateChatflow(j,o):a=await se.createNewChatflow(o),a.data){Ae(a.data.id),ee({type:Ee,chatflow:a.data});const s={...x,chatModel:c,instruction:X,flowId:a.data.id,documentStores:m,tools:y};(await N.updateAssistant(D,{details:JSON.stringify(s)})).data&&(H(!1),_({message:"Assistant saved successfully",options:{key:new Date().getTime()+Math.random(),variant:"success",action:n=>e.jsx(w,{style:{color:"white"},onClick:()=>R(n),children:e.jsx(B,{})})}}))}}catch(a){H(!1),_({message:`Failed to save assistant: ${typeof a.response.data=="object"?a.response.data.message:a.response.data}`,options:{key:new Date().getTime()+Math.random(),variant:"error",action:s=>e.jsx(w,{style:{color:"white"},onClick:()=>R(s),children:e.jsx(B,{})})}})}}},wt=async t=>{const o=[],a=[];for(let s=0;s<y.length;s++)try{const i=y[s],n=`${i.name}_${s}`,d=I.cloneDeep(i);I.set(d,"inputs",i.inputs);const p={id:n,data:{...d,id:n}};o.push(p);const g={source:n,sourceHandle:`${n}-output-${i.name}-Tool`,target:t,targetHandle:`${t}-input-tools-Tool`,type:"buttonedge",id:`${n}-${n}-output-${i.name}-Tool-${t}-${t}-input-tools-Tool`};a.push(g)}catch(i){console.error("Error adding tool",i)}return{nodes:o,edges:a}},Ct=async t=>{const o=await Le.getSpecificNode("documentStoreVS"),a=await Le.getSpecificNode("retrieverTool"),s=[],i=[];for(let n=0;n<m.length;n++)try{const d=`documentStoreVS_${n}`,p=`retrieverTool_${n}`,g=I.cloneDeep(oe(o.data,d)),V=I.cloneDeep(oe(a.data,p));I.set(g,"inputs.selectedStore",m[n].id);const T=de.find(Ot=>Ot.name===m[n].id),E=((T==null?void 0:T.label)||"").toLowerCase().replace(/ /g,"_").replace(/[^a-z0-9_-]/g,""),h=m[n].description||(T==null?void 0:T.description)||"";I.set(V,"inputs",{name:E,description:h,retriever:`{{${d}.data.instance}}`,returnSourceDocuments:!0});const C={id:d,data:{...g,id:d}};s.push(C);const O={id:p,data:{...V,id:p}};s.push(O);const Tt={source:d,sourceHandle:`${d}-output-retriever-BaseRetriever`,target:p,targetHandle:`${p}-input-retriever-BaseRetriever`,type:"buttonedge",id:`${d}-${d}-output-retriever-BaseRetriever-${p}-${p}-input-retriever-BaseRetriever`};i.push(Tt);const Pt={source:p,sourceHandle:`${p}-output-retrieverTool-RetrieverTool|DynamicTool|Tool|StructuredTool|Runnable`,target:t,targetHandle:`${t}-input-tools-Tool`,type:"buttonedge",id:`${p}-${p}-output-retrieverTool-RetrieverTool|DynamicTool|Tool|StructuredTool|Runnable-${t}-${t}-input-tools-Tool`};i.push(Pt)}catch(d){console.error("Error adding doc store",d)}return{nodes:s,edges:i}},vt=async()=>{var t;try{const o={},a=ze.nodes,s=ze.edges,i=`${c.name}_0`,n=(t=a.find(h=>h.data.category==="Chat Models"))==null?void 0:t.id;let d=a.filter(h=>h.data.category!=="Chat Models");const p={id:i,data:{...c,id:i}};d.push(p);const g=d.find(h=>h.data.name==="toolAgent"),V=g.id;I.set(g.data.inputs,"model",`{{${i}}}`),I.set(g.data.inputs,"systemMessage",`${X}`);const T=[];if(m.length>0){const h=m.map((C,O)=>`{{retrieverTool_${O}}}`);T.push(...h)}if(y.length>0){const h=y.map((C,O)=>`{{${y[O].id}}}`);T.push(...h)}I.set(g.data.inputs,"tools",T),d=d.map(h=>h.id===g.id?g:h);let E=s.map(h=>{const C={...h};return Object.keys(C).forEach(O=>{C[O].includes(n)&&(C[O]=C[O].replaceAll(n,i))}),C});if(m.length>0){const{nodes:h,edges:C}=await Ct(V);d=[...d,...h],E=[...E,...C]}if(y.length>0){const{nodes:h,edges:C}=await wt(V);d=[...d,...h],E=[...E,...C]}return o.nodes=d,o.edges=E,o}catch(o){console.error("Error preparing config",o),_({message:`Failed to save assistant: ${typeof o.response.data=="object"?o.response.data.message:o.response.data}`,options:{key:new Date().getTime()+Math.random(),variant:"error",action:a=>e.jsx(w,{style:{color:"white"},onClick:()=>R(a),children:e.jsx(B,{})})}});return}},jt=t=>{ue(!1),t==="deleteAssistant"?Be():t==="viewMessages"?(nt({title:"View Messages",chatflow:P.chatflow}),Se(!0)):t==="viewLeads"?(lt({title:"View Leads",chatflow:P.chatflow}),ke(!0)):t==="chatflowConfiguration"&&(pt({title:"Assistant Configuration",chatflow:P.chatflow}),De(!0))},Be=async()=>{const t={title:"Delete",description:`Delete ${x.name}?`,confirmButtonName:"Delete",cancelButtonName:"Cancel"};if(await xt(t)&&D)try{(await N.deleteAssistant(D)).data&&j&&await se.deleteChatflow(j),A(-1)}catch(a){_({message:typeof a.response.data=="object"?a.response.data.message:a.response.data,options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!0,action:s=>e.jsx(w,{style:{color:"white"},onClick:()=>R(s),children:e.jsx(B,{})})}})}},At=t=>{yt({value:t,inputParam:{label:"Instructions",name:"instructions",type:"string"},confirmButtonName:"Save",cancelButtonName:"Cancel"}),he(!0)},Mt=async t=>{var a,s;if(!ye()){fe();return}try{H(!0);const i={name:c.name,inputs:c.inputs},n=await ra.generateDocStoreToolDesc(t,{selectedChatModel:i});if(n.data){H(!1);const d=((a=n.data)==null?void 0:a.content)||((s=n.data.kwargs)==null?void 0:s.content),p=m.map(g=>g.id===t?{...g,description:d}:g);L(p),_({message:"Document Store Tool Description generated successfully",options:{key:new Date().getTime()+Math.random(),variant:"success",action:g=>e.jsx(w,{style:{color:"white"},onClick:()=>R(g),children:e.jsx(B,{})})}})}}catch(i){console.error("Error generating doc store tool desc",i),H(!1),_({message:typeof i.response.data=="object"?i.response.data.message:i.response.data,options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!0,action:n=>e.jsx(w,{style:{color:"white"},onClick:()=>R(n),children:e.jsx(B,{})})}})}},It=async()=>{if(!ye()){fe();return}ht({title:"Generate Instructions",description:"You can generate a prompt template by sharing basic details about your task.",data:{selectedChatModel:c}}),me(!0)},St=()=>{at({title:"Embed in website or use as API",chatflowid:j,chatflowApiKeyId:P.chatflow.apikeyid,isSessionMemory:!0}),Ie(!0)},kt=t=>{const o=JSON.parse(t),a=[];for(const s of o){const i=m.find(p=>p.id===s),n=de.find(p=>p.name===s),d={id:s,name:(n==null?void 0:n.label)||"",description:(i==null?void 0:i.description)||(n==null?void 0:n.description)||""};a.push(d)}L(a)},Dt=t=>{const o=m.filter(a=>a.id!==t);L(o)};r.useEffect(()=>{v.request(),f.request(),M.request()},[]),r.useEffect(()=>{if(f.data){const t=f.data.map(o=>({label:o.label,name:o.name,description:o.description}));Ye(t)}},[f.data]),r.useEffect(()=>{if(M.data){Qe(M.data);const t=M.data.map(o=>({label:o.label,name:o.name,description:o.description}));et(t)}},[M.data]),r.useEffect(()=>{if(v.data){ie(v.data);const t=v.data.map(o=>({label:o.label,name:o.name,imageSrc:`${be}/api/v1/node-icon/${o.name}`}));ce(t),D&&(ge(!0),S.request(D))}},[v.data]),r.useEffect(()=>{if(S.data){ge(!1);try{const t=JSON.parse(S.data.details);Ke(t),t.chatModel&&u(t.chatModel),t.instruction&&Q(t.instruction),t.flowId&&(Ae(t.flowId),k.request(t.flowId)),t.documentStores&&L(t.documentStores),t.tools&&F(t.tools)}catch(t){console.error("Error parsing assistant details",t)}}},[S.data]),r.useEffect(()=>{if(k.data){const t=k.data;ee({type:Ee,chatflow:t})}else k.error&&Z(`Failed to retrieve: ${k.error.response.data.message}`)},[k.data,k.error]),r.useEffect(()=>{S.error&&(ge(!1),Z(S.error))},[S.error]),r.useEffect(()=>{v.error&&Z(v.error)},[v.error]),r.useEffect(()=>{f.error&&Z(f.error)},[f.error]);const xe=()=>j&&!q?6:12,_e=()=>window.innerHeight-130;return e.jsxs(e.Fragment,{children:[e.jsx(zt,{children:Pe?e.jsx(Kt,{error:Pe}):e.jsx(z,{flexDirection:"column",children:e.jsx(b,{children:e.jsxs(Ce,{container:!0,spacing:"2",children:[e.jsx(Ce,{item:!0,xs:12,md:xe(),lg:xe(),sm:xe(),children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",paddingRight:15},children:[e.jsx(b,{sx:{flexGrow:1,py:1.25,width:"100%"},children:e.jsxs(Gt,{disableGutters:!0,sx:{p:0,display:"flex",justifyContent:"space-between",width:"100%"},children:[e.jsxs(b,{sx:{display:"flex",alignItems:"center",flexDirection:"row"},children:[e.jsx(Jt,{size:"small",color:"secondary","aria-label":"back",title:"Back",onClick:()=>A(-1),children:e.jsx(Ue,{})}),e.jsx($,{sx:{ml:2,mr:2},variant:"h3",children:(x==null?void 0:x.name)??""})]}),e.jsx("div",{style:{flex:1}}),j&&!q&&e.jsx(te,{title:"API Endpoint",sx:{borderRadius:"50%",mr:2},children:e.jsx(ae,{variant:"rounded",sx:{...l.typography.commonAvatar,...l.typography.mediumAvatar,transition:"all .2s ease-in-out",background:l.palette.canvasHeader.deployLight,color:l.palette.canvasHeader.deployDark,"&:hover":{background:l.palette.canvasHeader.deployDark,color:l.palette.canvasHeader.deployLight}},color:"inherit",onClick:St,children:e.jsx(We,{stroke:1.5,size:"1.3rem"})})}),e.jsx(te,{title:"Save",sx:{borderRadius:"50%",mr:2},children:e.jsx(ae,{variant:"rounded",sx:{...l.typography.commonAvatar,...l.typography.mediumAvatar,transition:"all .2s ease-in-out",background:l.palette.canvasHeader.saveLight,color:l.palette.canvasHeader.saveDark,"&:hover":{background:l.palette.canvasHeader.saveDark,color:l.palette.canvasHeader.saveLight}},color:"inherit",onClick:Oe,children:e.jsx(ia,{stroke:1.5,size:"1.3rem"})})}),j&&!q&&e.jsx(te,{ref:G,title:"Settings",sx:{borderRadius:"50%"},children:e.jsx(ae,{variant:"rounded",sx:{...l.typography.commonAvatar,...l.typography.mediumAvatar,transition:"all .2s ease-in-out",background:l.palette.canvasHeader.settingsLight,color:l.palette.canvasHeader.settingsDark,"&:hover":{background:l.palette.canvasHeader.settingsDark,color:l.palette.canvasHeader.settingsLight}},onClick:()=>ue(!pe),children:e.jsx(Ft,{stroke:1.5,size:"1.3rem"})})}),!j&&!q&&e.jsx(te,{ref:G,title:"Delete Assistant",sx:{borderRadius:"50%"},children:e.jsx(ae,{variant:"rounded",sx:{...l.typography.commonAvatar,...l.typography.mediumAvatar,transition:"all .2s ease-in-out",background:l.palette.error.light,color:l.palette.error.dark,"&:hover":{background:l.palette.error.dark,color:l.palette.error.light}},onClick:Be,children:e.jsx(He,{stroke:1.5,size:"1.3rem"})})})]})}),e.jsxs(b,{sx:{p:2,mt:1,mb:1,border:1,borderColor:l.palette.grey[900]+25,borderRadius:2},children:[e.jsx("div",{style:{display:"flex",flexDirection:"row"},children:e.jsxs($,{children:["Select Model",e.jsx("span",{style:{color:"red"},children:" *"})]})}),e.jsx(Ne,{name:"chatModel",options:le??[],onSelect:t=>{if(!t)u({});else{const o=Y.find(a=>a.name===t);if(o){const a=`${o.name}_0`,s=I.cloneDeep(o),i=oe(s,a);u(i)}}},value:c?c==null?void 0:c.name:"choose an option"},JSON.stringify(c))]}),e.jsxs(b,{sx:{p:2,mt:1,mb:1,border:1,borderColor:l.palette.grey[900]+25,borderRadius:2},children:[e.jsxs(z,{sx:{position:"relative",alignItems:"center"},direction:"row",children:[e.jsxs($,{children:["Instructions",e.jsx("span",{style:{color:"red"},children:" *"})]}),e.jsx("div",{style:{flex:1}}),e.jsx(ve,{size:"small",sx:{height:25,width:25},title:"Expand",color:"secondary",onClick:()=>At(X),children:e.jsx(la,{})}),(c==null?void 0:c.name)&&e.jsx(w,{title:"Generate instructions using model",sx:{borderRadius:20},size:"small",variant:"text",onClick:()=>It(),startIcon:e.jsx(je,{size:20}),children:"Generate"})]}),e.jsx(ne,{sx:{mt:1,width:"100%"},type:"text",multiline:!0,rows:6,value:X,onChange:t=>Q(t.target.value)})]}),e.jsxs(b,{sx:{p:2,mt:1,mb:1,border:1,borderColor:l.palette.grey[900]+25,borderRadius:2},children:[e.jsxs(z,{sx:{position:"relative",alignItems:"center"},direction:"row",children:[e.jsx($,{children:"Knowledge (Document Stores)"}),e.jsx(we,{title:"Give your assistant context about different document sources. Document stores must be upserted in advance."})]}),e.jsx(Yt,{name:JSON.stringify(m),options:de??[],onSelect:t=>{t?kt(t):L([])},value:m.map(t=>t.id)??"choose an option"},JSON.stringify(m)),m.length>0&&e.jsxs(z,{sx:{mt:3,position:"relative",alignItems:"center"},direction:"row",children:[e.jsxs($,{children:["Describe Knowledge",e.jsx("span",{style:{color:"red"},children:" *"})]}),e.jsx(we,{title:"Describe what the knowledge base is about, this is useful for the AI to know when and how to search for correct information"})]}),m.map((t,o)=>e.jsxs(b,{sx:{mt:1,mb:2},children:[e.jsxs(z,{sx:{position:"relative",alignItems:"center"},direction:"row",children:[e.jsxs("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",width:"max-content",height:"max-content",borderRadius:15,background:"rgb(254,252,191)",paddingLeft:15,paddingRight:15,paddingTop:5,paddingBottom:5,marginRight:10,marginBottom:10},children:[e.jsx("span",{style:{color:"rgb(116,66,16)",marginRight:10},children:t.name}),e.jsx(ve,{sx:{height:15,width:15,p:0},onClick:()=>Dt(t.id),children:e.jsx(B,{})})]}),e.jsx("div",{style:{flex:1}}),(c==null?void 0:c.name)&&e.jsx(w,{title:"Generate description using model",sx:{borderRadius:20},size:"small",variant:"text",onClick:()=>Mt(t.id),startIcon:e.jsx(je,{size:20}),children:"Generate"})]}),e.jsx(ne,{sx:{mt:1,width:"100%"},type:"text",multiline:!0,rows:3,value:t.description,onChange:a=>{const s=[...m];s[o].description=a.target.value,L(s)}})]},o))]}),c&&Object.keys(c).length>0&&e.jsx(b,{sx:{p:0,mt:1,mb:1,border:1,borderColor:l.palette.grey[900]+25,borderRadius:2},children:(c.inputParams??[]).filter(t=>!t.hidden).map((t,o)=>e.jsx($e,{inputParam:t,data:c},o))}),e.jsxs(b,{sx:{p:2,mt:1,mb:1,border:1,borderColor:l.palette.grey[900]+25,borderRadius:2},children:[e.jsxs(z,{sx:{position:"relative",alignItems:"center"},direction:"row",children:[e.jsx($,{children:"Tools"}),e.jsx(we,{title:"Tools are actions that your assistant can perform"})]}),y.map((t,o)=>e.jsxs(b,{sx:{border:1,borderColor:l.palette.grey[900]+25,borderRadius:2,mt:2,mb:2},children:[e.jsxs(b,{sx:{pl:2,pr:2,pt:2,pb:0},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"row"},children:[e.jsxs($,{children:["Tool",e.jsx("span",{style:{color:"red"},children:" *"})]}),e.jsx("div",{style:{flex:1}}),e.jsx(ve,{color:"error",sx:{height:15,width:15,p:0},onClick:()=>{const a=y.filter((s,i)=>i!==o);F(a)},children:e.jsx(He,{})})]}),e.jsx(Ne,{name:t.name,options:Ze??[],onSelect:a=>{if(a){const s=Xe.find(i=>i.name===a);if(s){const i=`${s.name}_${o}`,n=I.cloneDeep(s),d=oe(n,i),p=[...y];p[o]=d,F(p)}}else{const s=[...y];s[o]={},F(s)}},value:(t==null?void 0:t.name)||"choose an option"},JSON.stringify(t))]}),t&&Object.keys(t).length===0&&e.jsx(b,{sx:{pl:2,pr:2,pt:0,pb:2}}),t&&Object.keys(t).length>0&&e.jsx(b,{sx:{p:0,mt:2,mb:1},children:(t.inputParams??[]).filter(a=>!a.hidden).map((a,s)=>e.jsx($e,{inputParam:a,data:t},s))})]},o)),e.jsx(w,{fullWidth:!0,title:"Add Tool",sx:{mt:1,mb:1,borderRadius:20},variant:"outlined",onClick:()=>F([...y,{}]),children:"Add Tool"})]}),c&&Object.keys(c).length>0&&e.jsx(w,{fullWidth:!0,title:"Save Assistant",sx:{mt:1,mb:1,borderRadius:20,background:"linear-gradient(45deg, #673ab7 30%, #1e88e5 90%)"},variant:"contained",onClick:Oe,children:"Save Assistant"})]})}),j&&!q&&e.jsx(Ce,{item:!0,xs:12,md:6,lg:6,sm:6,children:e.jsxs(b,{sx:{mt:2},children:[K.isDarkMode&&e.jsx(re,{chatflowid:j,chatflow:P.chatflow,apiHost:be,chatflowConfig:{},theme:{button:{backgroundColor:"#32353b",iconColor:"#ffffff"},chatWindow:{height:_e(),showTitle:!0,backgroundColor:"#23262c",title:"  Preview",botMessage:{backgroundColor:"#32353b",textColor:"#ffffff"},userMessage:{backgroundColor:"#191b1f",textColor:"#ffffff"},textInput:{backgroundColor:"#32353b",textColor:"#ffffff"},footer:{showFooter:!1}}}}),!K.isDarkMode&&e.jsx(re,{chatflowid:j,chatflow:P.chatflow,apiHost:be,chatflowConfig:{},theme:{button:{backgroundColor:"#eeeeee",iconColor:"#333333"},chatWindow:{height:_e(),showTitle:!0,backgroundColor:"#fafafa",title:"  Preview",botMessage:{backgroundColor:"#ffffff",textColor:"#303235"},userMessage:{backgroundColor:"#f7f8ff",textColor:"#303235"},textInput:{backgroundColor:"#ffffff",textColor:"#303235"},footer:{showFooter:!1}}}})]})})]})})})}),Te&&e.jsx(Ut,{open:Te}),Me&&e.jsx(Xt,{show:Me,dialogProps:tt,onCancel:()=>Ie(!1)}),pe&&e.jsx(Qt,{chatflow:P.chatflow,isSettingsOpen:pe,anchorEl:G.current,onClose:()=>ue(!1),onSettingsItemClick:jt,isCustomAssistant:!0}),e.jsx(Zt,{show:ot,dialogProps:st,onCancel:()=>Se(!1)}),e.jsx(ea,{show:rt,dialogProps:it,onCancel:()=>ke(!1)}),e.jsx(ta,{show:ct,dialogProps:dt,onCancel:()=>De(!1)},"chatflowConfiguration"),e.jsx(Je,{show:ut,dialogProps:mt,onCancel:()=>me(!1),onConfirm:t=>{Q(t),me(!1)}}),e.jsx(sa,{show:gt,dialogProps:ft,onCancel:()=>he(!1),onConfirm:t=>{Q(t),he(!1)}}),e.jsx(Wt,{})]})};export{po as default};
