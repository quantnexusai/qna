import{a3 as J,P as U,r,x as Ge,y as ze,j as e,D as kt,q as Dt,t as Tt,w,v as Pt,A as Ot,I as _,K as Fe,L as qe,u as _t,a as Bt,R as _e,b as W,ac as Rt,c as be,ad as Be,M as $t,S as G,B as x,ae as Et,T as E,h as Z,af as ee,ag as Nt,ah as I,ai as te}from"./index-YrBb95ol.js";import{i as Lt}from"./index-DTPreCSy.js";import{u as Ht,C as Gt}from"./ConfirmDialog-KE28Mtnw.js";import{B as zt}from"./BackdropLoader-CslNJVg7.js";import{D as Re}from"./DocStoreInputHandler-BPevKxcV.js";import{D as $e}from"./Dropdown-B8fdFRp4.js";import{S as Ft}from"./StyledFab-DqqBf6Tt.js";import{E as qt}from"./ErrorBoundary-CUY0ZYII.js";import{a as xe}from"./TooltipWithParser-DKPjkixU.js";import{M as Vt}from"./MultiDropdown-wxNqtYoC.js";import{I as Ve,A as Wt,S as Ut,V as Jt,a as Kt,C as Yt}from"./index-DpRP1zH5.js";import{S as Xt}from"./StyledButton-DXZyQiwo.js";import{a as N}from"./assistants-Wx-_qNk1.js";import{O as oe}from"./OutlinedInput-BhZIIZoj.js";import{L as Qt}from"./ManageScrapedLinksDialog-ChuAEx6z.js";import{I as We}from"./IconArrowLeft-ByFHgJ8H.js";import{I as Zt}from"./IconLanguage-Csaj12yt.js";import{c as ae}from"./chatflows-CDziwBvw.js";import{n as Ee}from"./nodes-BVY53Wx2.js";import{d as ea}from"./documentstore-DL5qOG7D.js";import{G as we}from"./Grid-DjQ4cn3D.js";import{I as ta}from"./IconDeviceFloppy-BP6UcCj8.js";import{I as Ne}from"./IconTrash-Ssd3AIfJ.js";import{I as Le}from"./IconSearch-D-OoqJyQ.js";import"./CircularProgress-BFk_RX-E.js";import"./CredentialInputHandler-BzNGMmJx.js";import"./CredentialListDialog-IIU7ZM0n.js";import"./Input-B4-co-4L.js";import"./FormControl-wstEAgUr.js";import"./Popover-BvGEjH7D.js";import"./main-Dkicd77k.js";import"./TextField-LGUd3qul.js";import"./Menu-B86QUi--.js";import"./File-DPjeuW7d.js";import"./CodeEditor-tl_RgJZo.js";import"./IconCopy-CsKaXIZ_.js";import"./CodeBlock-C89wN1l6.js";import"./DataGrid-DWwuEQgy.js";import"./Delete-BF9vyW48.js";import"./IconPlus-BaXmZWfM.js";import"./ExpandMore-DwWgoSjj.js";import"./Tabs-Bc6quiMH.js";import"./apikey-D8q6OrhH.js";import"./variables-CFKzWGCE.js";import"./Table-B1nl_7s4.js";import"./IconBulb-Dwb7Zq86.js";import"./StatsCard-BGfvLE3r.js";import"./SpeechToText-ZrYAsUYL.js";import"./IconTemplate-mextczkR.js";/**
 * @license @tabler/icons-react v3.3.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var aa=J("outline","mail","IconMail",[["path",{d:"M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z",key:"svg-0"}],["path",{d:"M3 7l9 6l9 -6",key:"svg-1"}]]);/**
 * @license @tabler/icons-react v3.3.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var oa=J("outline","notebook","IconNotebook",[["path",{d:"M6 4h11a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-11a1 1 0 0 1 -1 -1v-14a1 1 0 0 1 1 -1m3 0v18",key:"svg-0"}],["path",{d:"M13 8l2 0",key:"svg-1"}],["path",{d:"M13 12l2 0",key:"svg-2"}]]);/**
 * @license @tabler/icons-react v3.3.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var sa=J("outline","report","IconReport",[["path",{d:"M8 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h5.697",key:"svg-0"}],["path",{d:"M18 14v4h4",key:"svg-1"}],["path",{d:"M18 11v-4a2 2 0 0 0 -2 -2h-2",key:"svg-2"}],["path",{d:"M8 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z",key:"svg-3"}],["path",{d:"M18 18m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0",key:"svg-4"}],["path",{d:"M8 11h4",key:"svg-5"}],["path",{d:"M8 15h3",key:"svg-6"}]]);/**
 * @license @tabler/icons-react v3.3.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Ce=J("outline","wand","IconWand",[["path",{d:"M6 21l15 -15l-3 -3l-15 15l3 3",key:"svg-0"}],["path",{d:"M15 6l3 3",key:"svg-1"}],["path",{d:"M9 3a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2",key:"svg-2"}],["path",{d:"M19 13a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2",key:"svg-3"}]]);/**
 * @license @tabler/icons-react v3.3.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var na=J("outline","world","IconWorld",[["path",{d:"M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0",key:"svg-0"}],["path",{d:"M3.6 9h16.8",key:"svg-1"}],["path",{d:"M3.6 15h16.8",key:"svg-2"}],["path",{d:"M11.5 3a17 17 0 0 0 0 18",key:"svg-3"}],["path",{d:"M12.5 3a17 17 0 0 1 0 18",key:"svg-4"}]]);const ra=[{text:"Summarize a document",img:e.jsx(oa,{})},{text:"Translate the language",img:e.jsx(Zt,{})},{text:"Write me an email",img:e.jsx(aa,{})},{text:"Convert the code to another language",img:e.jsx(Ve,{})},{text:"Research and generate a report",img:e.jsx(sa,{})},{text:"Plan a trip",img:e.jsx(na,{})}],Ue=({show:A,dialogProps:l,onCancel:z,onConfirm:P})=>{const K=document.getElementById("portal"),[S,v]=r.useState(""),[f,M]=r.useState(""),[k,D]=r.useState(!1),Y=Ge();ze();const ne=(...u)=>Y(Fe(...u)),re=(...u)=>Y(qe(...u)),ie=async()=>{try{D(!0);const u={name:l.data.selectedChatModel.name,inputs:l.data.selectedChatModel.inputs},b=await N.generateAssistantInstruction({selectedChatModel:u,task:S});b.data&&(D(!1),b.data.content&&M(b.data.content))}catch(u){D(!1),ne({message:typeof u.response.data=="object"?u.response.data.message:u.response.data,options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!0,action:b=>e.jsx(w,{style:{color:"white"},onClick:()=>re(b),children:e.jsx(_,{})})}})}};r.useEffect(()=>{A||(v(""),M(""))},[A]);const c=A?e.jsx(e.Fragment,{children:e.jsxs(kt,{fullWidth:!0,maxWidth:"md",open:A,onClose:z,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[e.jsx(Dt,{sx:{fontSize:"1rem"},id:"alert-dialog-title",children:l.title}),e.jsxs(Tt,{children:[e.jsx("span",{children:l.description}),e.jsx("div",{style:{display:"block",flexDirection:"row",width:"100%",marginTop:"15px"},children:ra.map((u,b)=>e.jsx(w,{size:"small",sx:{textTransform:"none",mr:1,mb:1,borderRadius:"16px"},variant:"outlined",color:"inherit",onClick:()=>{v(u.text),M("")},startIcon:u.img,children:u.text},b))}),!f&&e.jsx(oe,{sx:{mt:2,width:"100%"},type:"text",multiline:!0,rows:12,disabled:k,value:S,placeholder:"Describe your task here",onChange:u=>v(u.target.value)}),f&&e.jsx(oe,{sx:{mt:2,width:"100%"},type:"text",multiline:!0,rows:12,value:f,onChange:u=>M(u.target.value)})]}),e.jsxs(Pt,{sx:{pb:3,pr:3},children:[!f&&e.jsx(Qt,{loading:k,variant:"contained",onClick:()=>{ie()},startIcon:e.jsx(Ce,{size:20}),children:"Generate"}),f&&e.jsx(w,{variant:"outlined",startIcon:e.jsx(We,{size:20}),onClick:()=>{M("")},children:"Back"}),f&&e.jsx(Xt,{variant:"contained",onClick:()=>P(f),children:"Apply"})]})]})}):null;return Ot.createPortal(c,K)};Ue.propTypes={show:U.bool,dialogProps:U.object,onConfirm:U.func,onCancel:U.func};const He={nodes:[{id:"bufferMemory_0",data:{id:"bufferMemory_0",label:"Buffer Memory",version:2,name:"bufferMemory",type:"BufferMemory",baseClasses:["BufferMemory","BaseChatMemory","BaseMemory"],category:"Memory",description:"Retrieve chat messages stored in database",inputParams:[{label:"Session Id",name:"sessionId",type:"string",description:'If not specified, a random id will be used. Learn <a target="_blank" href="https://docs.flowiseai.com/memory#ui-and-embedded-chat">more</a>',default:"",additionalParams:!0,optional:!0,id:"bufferMemory_0-input-sessionId-string"},{label:"Memory Key",name:"memoryKey",type:"string",default:"chat_history",additionalParams:!0,id:"bufferMemory_0-input-memoryKey-string"}],inputAnchors:[],inputs:{sessionId:"",memoryKey:"chat_history"},outputAnchors:[{id:"bufferMemory_0-output-bufferMemory-BufferMemory|BaseChatMemory|BaseMemory",name:"bufferMemory",label:"BufferMemory",description:"Retrieve chat messages stored in database",type:"BufferMemory | BaseChatMemory | BaseMemory"}],outputs:{}}},{id:"chatOpenAI_0",data:{id:"chatOpenAI_0",label:"ChatOpenAI",version:8,name:"chatOpenAI",type:"ChatOpenAI",baseClasses:["ChatOpenAI","BaseChatModel","BaseLanguageModel","Runnable"],category:"Chat Models",description:"Wrapper around OpenAI large language models that use the Chat endpoint",inputParams:[{label:"Connect Credential",name:"credential",type:"credential",credentialNames:["openAIApi"],id:"chatOpenAI_0-input-credential-credential"},{label:"Model Name",name:"modelName",type:"asyncOptions",loadMethod:"listModels",default:"gpt-4o-mini",id:"chatOpenAI_0-input-modelName-asyncOptions"},{label:"Temperature",name:"temperature",type:"number",step:.1,default:.9,optional:!0,id:"chatOpenAI_0-input-temperature-number"},{label:"Streaming",name:"streaming",type:"boolean",default:!0,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-streaming-boolean"},{label:"Max Tokens",name:"maxTokens",type:"number",step:1,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-maxTokens-number"},{label:"Top Probability",name:"topP",type:"number",step:.1,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-topP-number"},{label:"Frequency Penalty",name:"frequencyPenalty",type:"number",step:.1,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-frequencyPenalty-number"},{label:"Presence Penalty",name:"presencePenalty",type:"number",step:.1,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-presencePenalty-number"},{label:"Timeout",name:"timeout",type:"number",step:1,optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-timeout-number"},{label:"BasePath",name:"basepath",type:"string",optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-basepath-string"},{label:"Proxy Url",name:"proxyUrl",type:"string",optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-proxyUrl-string"},{label:"Stop Sequence",name:"stopSequence",type:"string",rows:4,optional:!0,description:"List of stop words to use when generating. Use comma to separate multiple stop words.",additionalParams:!0,id:"chatOpenAI_0-input-stopSequence-string"},{label:"BaseOptions",name:"baseOptions",type:"json",optional:!0,additionalParams:!0,id:"chatOpenAI_0-input-baseOptions-json"},{label:"Allow Image Uploads",name:"allowImageUploads",type:"boolean",description:'Allow image input. Refer to the <a href="https://docs.flowiseai.com/using-flowise/uploads#image" target="_blank">docs</a> for more details.',default:!1,optional:!0,id:"chatOpenAI_0-input-allowImageUploads-boolean"},{label:"Image Resolution",description:"This parameter controls the resolution in which the model views the image.",name:"imageResolution",type:"options",options:[{label:"Low",name:"low"},{label:"High",name:"high"},{label:"Auto",name:"auto"}],default:"low",optional:!1,additionalParams:!0,id:"chatOpenAI_0-input-imageResolution-options"}],inputAnchors:[{label:"Cache",name:"cache",type:"BaseCache",optional:!0,id:"chatOpenAI_0-input-cache-BaseCache"}],inputs:{cache:"",modelName:"gpt-4o-mini",temperature:.9,streaming:!0,maxTokens:"",topP:"",frequencyPenalty:"",presencePenalty:"",timeout:"",basepath:"",proxyUrl:"",stopSequence:"",baseOptions:"",allowImageUploads:"",imageResolution:"low"},outputAnchors:[{id:"chatOpenAI_0-output-chatOpenAI-ChatOpenAI|BaseChatModel|BaseLanguageModel|Runnable",name:"chatOpenAI",label:"ChatOpenAI",description:"Wrapper around OpenAI large language models that use the Chat endpoint",type:"ChatOpenAI | BaseChatModel | BaseLanguageModel | Runnable"}],outputs:{}}},{id:"toolAgent_0",data:{id:"toolAgent_0",label:"Tool Agent",version:2,name:"toolAgent",type:"AgentExecutor",baseClasses:["AgentExecutor","BaseChain","Runnable"],category:"Agents",description:"Agent that uses Function Calling to pick the tools and args to call",inputParams:[{label:"System Message",name:"systemMessage",type:"string",default:"You are a helpful AI assistant.",description:"If Chat Prompt Template is provided, this will be ignored",rows:4,optional:!0,additionalParams:!0,id:"toolAgent_0-input-systemMessage-string"},{label:"Max Iterations",name:"maxIterations",type:"number",optional:!0,additionalParams:!0,id:"toolAgent_0-input-maxIterations-number"}],inputAnchors:[{label:"Tools",name:"tools",type:"Tool",list:!0,id:"toolAgent_0-input-tools-Tool"},{label:"Memory",name:"memory",type:"BaseChatMemory",id:"toolAgent_0-input-memory-BaseChatMemory"},{label:"Tool Calling Chat Model",name:"model",type:"BaseChatModel",description:"Only compatible with models that are capable of function calling: ChatOpenAI, ChatMistral, ChatAnthropic, ChatGoogleGenerativeAI, ChatVertexAI, GroqChat",id:"toolAgent_0-input-model-BaseChatModel"},{label:"Chat Prompt Template",name:"chatPromptTemplate",type:"ChatPromptTemplate",description:"Override existing prompt with Chat Prompt Template. Human Message must includes {input} variable",optional:!0,id:"toolAgent_0-input-chatPromptTemplate-ChatPromptTemplate"},{label:"Input Moderation",description:"Detect text that could generate harmful output and prevent it from being sent to the language model",name:"inputModeration",type:"Moderation",optional:!0,list:!0,id:"toolAgent_0-input-inputModeration-Moderation"}],inputs:{tools:[],memory:"{{bufferMemory_0.data.instance}}",model:"{{chatOpenAI_0.data.instance}}",chatPromptTemplate:"",systemMessage:"You are helpful assistant",inputModeration:"",maxIterations:""},outputAnchors:[{id:"toolAgent_0-output-toolAgent-AgentExecutor|BaseChain|Runnable",name:"toolAgent",label:"AgentExecutor",description:"Agent that uses Function Calling to pick the tools and args to call",type:"AgentExecutor | BaseChain | Runnable"}],outputs:{}}}],edges:[{source:"bufferMemory_0",sourceHandle:"bufferMemory_0-output-bufferMemory-BufferMemory|BaseChatMemory|BaseMemory",target:"toolAgent_0",targetHandle:"toolAgent_0-input-memory-BaseChatMemory",type:"buttonedge",id:"bufferMemory_0-bufferMemory_0-output-bufferMemory-BufferMemory|BaseChatMemory|BaseMemory-toolAgent_0-toolAgent_0-input-memory-BaseChatMemory"},{source:"chatOpenAI_0",sourceHandle:"chatOpenAI_0-output-chatOpenAI-ChatOpenAI|BaseChatModel|BaseLanguageModel|Runnable",target:"toolAgent_0",targetHandle:"toolAgent_0-input-model-BaseChatModel",type:"buttonedge",id:"chatOpenAI_0-chatOpenAI_0-output-chatOpenAI-ChatOpenAI|BaseChatModel|BaseLanguageModel|Runnable-toolAgent_0-toolAgent_0-input-model-BaseChatModel"}]},se=r.memo(({...A})=>e.jsx("div",{children:e.jsx(Lt,{...A})}),(A,l)=>A.chatflow===l.chatflow);se.displayName="MemoizedFullPageChat";se.propTypes={chatflow:U.object};const ao=()=>{const A=_t(),l=Bt(),z=r.useRef(),P=_e(t=>t.canvas),K=_e(t=>t.customization),S=W(N.getSpecificAssistant),v=W(N.getChatModels),f=W(N.getDocStores),M=W(N.getTools),k=W(ae.getSpecificChatflow),{id:D}=Rt(),[Y,ne]=r.useState([]),[re,ie]=r.useState([]),[c,u]=r.useState({}),[b,Je]=r.useState({}),[le,ce]=r.useState("You are helpful assistant"),[j,ve]=r.useState(),[de,Ke]=r.useState([]),[m,L]=r.useState([]),[Ye,Xe]=r.useState([]),[Qe,Ze]=r.useState([]),[y,F]=r.useState([]),[je,Ae]=r.useState(!1),[et,tt]=r.useState({}),[at,Me]=r.useState(!1),[ot,st]=r.useState({}),[nt,Ie]=r.useState(!1),[rt,it]=r.useState({}),[lt,Se]=r.useState(!1),[ct,dt]=r.useState({}),[pe,ue]=r.useState(!1),[pt,me]=r.useState(!1),[ut,mt]=r.useState({}),[ke,H]=r.useState(!1),[q,he]=r.useState(!0),[De,X]=r.useState(null),Q=Ge(),{confirm:ht}=Ht();ze();const B=(...t)=>Q(Fe(...t)),R=(...t)=>Q(qe(...t)),ge=()=>{B({message:"Please fill in all mandatory fields.",options:{key:new Date().getTime()+Math.random(),variant:"warning",action:t=>e.jsx(w,{style:{color:"white"},onClick:()=>R(t),children:e.jsx(_,{})})}})},fe=()=>{let t=!0;const o=(c.inputParams??[]).filter(a=>!a.hidden);for(const a of o)if(!a.optional&&(!c.inputs[a.name]||!c.credential)){if(a.type==="credential"&&!c.credential){t=!1;break}else if(a.type!=="credential"&&!c.inputs[a.name]){t=!1;break}}if(y.length>0)for(let a=0;a<y.length;a++){const s=y[a],i=(s.inputParams??[]).filter(n=>!n.hidden);for(const n of i)if(!n.optional&&(!s.inputs[n.name]||!s.credential)){if(n.type==="credential"&&!s.credential){t=!1;break}else if(n.type!=="credential"&&!s.inputs[n.name]){t=!1;break}}}return t},gt=()=>{let t=!0;if((!c||!c.name)&&(t=!1),t=fe(),m.length>0){for(let o=0;o<m.length;o++)if(!m[o].description){t=!1;break}}return t||ge(),t},Te=async()=>{if(gt()){H(!0);const t=await bt();if(!t)return;const o={id:D,name:b.name,flowData:JSON.stringify(t),type:"ASSISTANT"};try{let a;if(j?a=await ae.updateChatflow(j,o):a=await ae.createNewChatflow(o),a.data){ve(a.data.id),Q({type:Be,chatflow:a.data});const s={...b,chatModel:c,instruction:le,flowId:a.data.id,documentStores:m,tools:y};(await N.updateAssistant(D,{details:JSON.stringify(s)})).data&&(H(!1),B({message:"Assistant saved successfully",options:{key:new Date().getTime()+Math.random(),variant:"success",action:n=>e.jsx(w,{style:{color:"white"},onClick:()=>R(n),children:e.jsx(_,{})})}}))}}catch(a){H(!1),B({message:`Failed to save assistant: ${typeof a.response.data=="object"?a.response.data.message:a.response.data}`,options:{key:new Date().getTime()+Math.random(),variant:"error",action:s=>e.jsx(w,{style:{color:"white"},onClick:()=>R(s),children:e.jsx(_,{})})}})}}},ft=async t=>{const o=[],a=[];for(let s=0;s<y.length;s++)try{const i=y[s],n=`${i.name}_${s}`,d=I.cloneDeep(i);I.set(d,"inputs",i.inputs);const p={id:n,data:{...d,id:n}};o.push(p);const g={source:n,sourceHandle:`${n}-output-${i.name}-Tool`,target:t,targetHandle:`${t}-input-tools-Tool`,type:"buttonedge",id:`${n}-${n}-output-${i.name}-Tool-${t}-${t}-input-tools-Tool`};a.push(g)}catch(i){console.error("Error adding tool",i)}return{nodes:o,edges:a}},yt=async t=>{const o=await Ee.getSpecificNode("documentStoreVS"),a=await Ee.getSpecificNode("retrieverTool"),s=[],i=[];for(let n=0;n<m.length;n++)try{const d=`documentStoreVS_${n}`,p=`retrieverTool_${n}`,g=I.cloneDeep(te(o.data,d)),V=I.cloneDeep(te(a.data,p));I.set(g,"inputs.selectedStore",m[n].id);const T=de.find(St=>St.name===m[n].id),$=((T==null?void 0:T.label)||"").toLowerCase().replace(/ /g,"_"),h=m[n].description||(T==null?void 0:T.description)||"";I.set(V,"inputs",{name:$,description:h,retriever:`{{${d}.data.instance}}`,returnSourceDocuments:!0});const C={id:d,data:{...g,id:d}};s.push(C);const O={id:p,data:{...V,id:p}};s.push(O);const Mt={source:d,sourceHandle:`${d}-output-retriever-BaseRetriever`,target:p,targetHandle:`${p}-input-retriever-BaseRetriever`,type:"buttonedge",id:`${d}-${d}-output-retriever-BaseRetriever-${p}-${p}-input-retriever-BaseRetriever`};i.push(Mt);const It={source:p,sourceHandle:`${p}-output-retrieverTool-RetrieverTool|DynamicTool|Tool|StructuredTool|Runnable`,target:t,targetHandle:`${t}-input-tools-Tool`,type:"buttonedge",id:`${p}-${p}-output-retrieverTool-RetrieverTool|DynamicTool|Tool|StructuredTool|Runnable-${t}-${t}-input-tools-Tool`};i.push(It)}catch(d){console.error("Error adding doc store",d)}return{nodes:s,edges:i}},bt=async()=>{var t;try{const o={},a=He.nodes,s=He.edges,i=`${c.name}_0`,n=(t=a.find(h=>h.data.category==="Chat Models"))==null?void 0:t.id;let d=a.filter(h=>h.data.category!=="Chat Models");const p={id:i,data:{...c,id:i}};d.push(p);const g=d.find(h=>h.data.name==="toolAgent"),V=g.id;I.set(g.data.inputs,"model",`{{${i}}}`),I.set(g.data.inputs,"systemMessage",`${le}`);const T=[];if(m.length>0){const h=m.map((C,O)=>`{{retrieverTool_${O}}}`);T.push(...h)}if(y.length>0){const h=y.map((C,O)=>`{{${y[O].id}}}`);T.push(...h)}I.set(g.data.inputs,"tools",T),d=d.map(h=>h.id===g.id?g:h);let $=s.map(h=>{const C={...h};return Object.keys(C).forEach(O=>{C[O].includes(n)&&(C[O]=C[O].replaceAll(n,i))}),C});if(m.length>0){const{nodes:h,edges:C}=await yt(V);d=[...d,...h],$=[...$,...C]}if(y.length>0){const{nodes:h,edges:C}=await ft(V);d=[...d,...h],$=[...$,...C]}return o.nodes=d,o.edges=$,o}catch(o){console.error("Error preparing config",o),B({message:`Failed to save assistant: ${typeof o.response.data=="object"?o.response.data.message:o.response.data}`,options:{key:new Date().getTime()+Math.random(),variant:"error",action:a=>e.jsx(w,{style:{color:"white"},onClick:()=>R(a),children:e.jsx(_,{})})}});return}},xt=t=>{ue(!1),t==="deleteAssistant"?Pe():t==="viewMessages"?(st({title:"View Messages",chatflow:P.chatflow}),Me(!0)):t==="viewLeads"?(it({title:"View Leads",chatflow:P.chatflow}),Ie(!0)):t==="chatflowConfiguration"&&(dt({title:"Assistant Configuration",chatflow:P.chatflow}),Se(!0))},Pe=async()=>{const t={title:"Delete",description:`Delete ${b.name}?`,confirmButtonName:"Delete",cancelButtonName:"Cancel"};if(await ht(t)&&D)try{(await N.deleteAssistant(D)).data&&j&&await ae.deleteChatflow(j),A(-1)}catch(a){B({message:typeof a.response.data=="object"?a.response.data.message:a.response.data,options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!0,action:s=>e.jsx(w,{style:{color:"white"},onClick:()=>R(s),children:e.jsx(_,{})})}})}},wt=async t=>{var a,s;if(!fe()){ge();return}try{H(!0);const i={name:c.name,inputs:c.inputs},n=await ea.generateDocStoreToolDesc(t,{selectedChatModel:i});if(n.data){H(!1);const d=((a=n.data)==null?void 0:a.content)||((s=n.data.kwargs)==null?void 0:s.content),p=m.map(g=>g.id===t?{...g,description:d}:g);L(p),B({message:"Document Store Tool Description generated successfully",options:{key:new Date().getTime()+Math.random(),variant:"success",action:g=>e.jsx(w,{style:{color:"white"},onClick:()=>R(g),children:e.jsx(_,{})})}})}}catch(i){console.error("Error generating doc store tool desc",i),H(!1),B({message:typeof i.response.data=="object"?i.response.data.message:i.response.data,options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!0,action:n=>e.jsx(w,{style:{color:"white"},onClick:()=>R(n),children:e.jsx(_,{})})}})}},Ct=async()=>{if(!fe()){ge();return}mt({title:"Generate Instructions",description:"You can generate a prompt template by sharing basic details about your task.",data:{selectedChatModel:c}}),me(!0)},vt=()=>{tt({title:"Embed in website or use as API",chatflowid:j,chatflowApiKeyId:P.chatflow.apikeyid,isSessionMemory:!0}),Ae(!0)},jt=t=>{const o=JSON.parse(t),a=[];for(const s of o){const i=m.find(p=>p.id===s),n=de.find(p=>p.name===s),d={id:s,name:(n==null?void 0:n.label)||"",description:(i==null?void 0:i.description)||(n==null?void 0:n.description)||""};a.push(d)}L(a)},At=t=>{const o=m.filter(a=>a.id!==t);L(o)};r.useEffect(()=>{v.request(),f.request(),M.request()},[]),r.useEffect(()=>{if(f.data){const t=f.data.map(o=>({label:o.label,name:o.name,description:o.description}));Ke(t)}},[f.data]),r.useEffect(()=>{if(M.data){Xe(M.data);const t=M.data.map(o=>({label:o.label,name:o.name,description:o.description}));Ze(t)}},[M.data]),r.useEffect(()=>{if(v.data){ne(v.data);const t=v.data.map(o=>({label:o.label,name:o.name,imageSrc:`${be}/api/v1/node-icon/${o.name}`}));ie(t),D&&(he(!0),S.request(D))}},[v.data]),r.useEffect(()=>{if(S.data){he(!1);try{const t=JSON.parse(S.data.details);Je(t),t.chatModel&&u(t.chatModel),t.instruction&&ce(t.instruction),t.flowId&&(ve(t.flowId),k.request(t.flowId)),t.documentStores&&L(t.documentStores),t.tools&&F(t.tools)}catch(t){console.error("Error parsing assistant details",t)}}},[S.data]),r.useEffect(()=>{if(k.data){const t=k.data;Q({type:Be,chatflow:t})}else k.error&&X(`Failed to retrieve: ${k.error.response.data.message}`)},[k.data,k.error]),r.useEffect(()=>{S.error&&(he(!1),X(S.error))},[S.error]),r.useEffect(()=>{v.error&&X(v.error)},[v.error]),r.useEffect(()=>{f.error&&X(f.error)},[f.error]);const ye=()=>j&&!q?6:12,Oe=()=>window.innerHeight-130;return e.jsxs(e.Fragment,{children:[e.jsx($t,{children:De?e.jsx(qt,{error:De}):e.jsx(G,{flexDirection:"column",children:e.jsx(x,{children:e.jsxs(we,{container:!0,spacing:"2",children:[e.jsx(we,{item:!0,xs:12,md:ye(),lg:ye(),sm:ye(),children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",paddingRight:15},children:[e.jsx(x,{sx:{flexGrow:1,py:1.25,width:"100%"},children:e.jsxs(Et,{disableGutters:!0,sx:{p:0,display:"flex",justifyContent:"space-between",width:"100%"},children:[e.jsxs(x,{sx:{display:"flex",alignItems:"center",flexDirection:"row"},children:[e.jsx(Ft,{size:"small",color:"secondary","aria-label":"back",title:"Back",onClick:()=>A(-1),children:e.jsx(We,{})}),e.jsx(E,{sx:{ml:2,mr:2},variant:"h3",children:(b==null?void 0:b.name)??""})]}),e.jsx("div",{style:{flex:1}}),j&&!q&&e.jsx(Z,{title:"API Endpoint",sx:{borderRadius:"50%",mr:2},children:e.jsx(ee,{variant:"rounded",sx:{...l.typography.commonAvatar,...l.typography.mediumAvatar,transition:"all .2s ease-in-out",background:l.palette.canvasHeader.deployLight,color:l.palette.canvasHeader.deployDark,"&:hover":{background:l.palette.canvasHeader.deployDark,color:l.palette.canvasHeader.deployLight}},color:"inherit",onClick:vt,children:e.jsx(Ve,{stroke:1.5,size:"1.3rem"})})}),e.jsx(Z,{title:"Save",sx:{borderRadius:"50%",mr:2},children:e.jsx(ee,{variant:"rounded",sx:{...l.typography.commonAvatar,...l.typography.mediumAvatar,transition:"all .2s ease-in-out",background:l.palette.canvasHeader.saveLight,color:l.palette.canvasHeader.saveDark,"&:hover":{background:l.palette.canvasHeader.saveDark,color:l.palette.canvasHeader.saveLight}},color:"inherit",onClick:Te,children:e.jsx(ta,{stroke:1.5,size:"1.3rem"})})}),j&&!q&&e.jsx(Z,{ref:z,title:"Settings",sx:{borderRadius:"50%"},children:e.jsx(ee,{variant:"rounded",sx:{...l.typography.commonAvatar,...l.typography.mediumAvatar,transition:"all .2s ease-in-out",background:l.palette.canvasHeader.settingsLight,color:l.palette.canvasHeader.settingsDark,"&:hover":{background:l.palette.canvasHeader.settingsDark,color:l.palette.canvasHeader.settingsLight}},onClick:()=>ue(!pe),children:e.jsx(Nt,{stroke:1.5,size:"1.3rem"})})}),!j&&!q&&e.jsx(Z,{ref:z,title:"Delete Assistant",sx:{borderRadius:"50%"},children:e.jsx(ee,{variant:"rounded",sx:{...l.typography.commonAvatar,...l.typography.mediumAvatar,transition:"all .2s ease-in-out",background:l.palette.error.light,color:l.palette.error.dark,"&:hover":{background:l.palette.error.dark,color:l.palette.error.light}},onClick:Pe,children:e.jsx(Ne,{stroke:1.5,size:"1.3rem"})})})]})}),e.jsxs(x,{sx:{p:2,mt:1,mb:1,border:1,borderColor:l.palette.grey[900]+25,borderRadius:2},children:[e.jsx("div",{style:{display:"flex",flexDirection:"row"},children:e.jsxs(E,{children:["Select Model",e.jsx("span",{style:{color:"red"},children:" *"})]})}),e.jsx($e,{name:"chatModel",options:re??[],onSelect:t=>{if(!t)u({});else{const o=Y.find(a=>a.name===t);if(o){const a=`${o.name}_0`,s=I.cloneDeep(o),i=te(s,a);u(i)}}},value:c?c==null?void 0:c.name:"choose an option"},JSON.stringify(c))]}),e.jsxs(x,{sx:{p:2,mt:1,mb:1,border:1,borderColor:l.palette.grey[900]+25,borderRadius:2},children:[e.jsxs(G,{sx:{position:"relative",alignItems:"center"},direction:"row",children:[e.jsxs(E,{children:["Instructions",e.jsx("span",{style:{color:"red"},children:" *"})]}),e.jsx("div",{style:{flex:1}}),(c==null?void 0:c.name)&&e.jsx(w,{title:"Generate instructions using model",sx:{borderRadius:20},size:"small",variant:"text",onClick:()=>Ct(),startIcon:e.jsx(Ce,{size:20}),children:"Generate"})]}),e.jsx(oe,{sx:{mt:1,width:"100%"},type:"text",multiline:!0,rows:6,value:le,onChange:t=>ce(t.target.value)})]}),e.jsxs(x,{sx:{p:2,mt:1,mb:1,border:1,borderColor:l.palette.grey[900]+25,borderRadius:2},children:[e.jsxs(G,{sx:{position:"relative",alignItems:"center"},direction:"row",children:[e.jsx(E,{children:"Knowledge (Document Stores)"}),e.jsx(xe,{title:"Give your assistant context about different document sources. Document stores must be upserted in advance."})]}),e.jsx(Vt,{name:JSON.stringify(m),options:de??[],onSelect:t=>{t?jt(t):L([])},value:m.map(t=>t.id)??"choose an option"},JSON.stringify(m)),m.length>0&&e.jsxs(G,{sx:{mt:3,position:"relative",alignItems:"center"},direction:"row",children:[e.jsxs(E,{children:["Describe Knowledge",e.jsx("span",{style:{color:"red"},children:" *"})]}),e.jsx(xe,{title:"Describe what the knowledge base is about, this is useful for the AI to know when and how to search for correct information"})]}),m.map((t,o)=>e.jsxs(x,{sx:{mt:1,mb:2},children:[e.jsxs(G,{sx:{position:"relative",alignItems:"center"},direction:"row",children:[e.jsxs("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",width:"max-content",height:"max-content",borderRadius:15,background:"rgb(254,252,191)",paddingLeft:15,paddingRight:15,paddingTop:5,paddingBottom:5,marginRight:10,marginBottom:10},children:[e.jsx("span",{style:{color:"rgb(116,66,16)",marginRight:10},children:t.name}),e.jsx(Le,{sx:{height:15,width:15,p:0},onClick:()=>At(t.id),children:e.jsx(_,{})})]}),e.jsx("div",{style:{flex:1}}),(c==null?void 0:c.name)&&e.jsx(w,{title:"Generate description using model",sx:{borderRadius:20},size:"small",variant:"text",onClick:()=>wt(t.id),startIcon:e.jsx(Ce,{size:20}),children:"Generate"})]}),e.jsx(oe,{sx:{mt:1,width:"100%"},type:"text",multiline:!0,rows:3,value:t.description,onChange:a=>{const s=[...m];s[o].description=a.target.value,L(s)}})]},o))]}),c&&Object.keys(c).length>0&&e.jsx(x,{sx:{p:0,mt:1,mb:1,border:1,borderColor:l.palette.grey[900]+25,borderRadius:2},children:(c.inputParams??[]).filter(t=>!t.hidden).map((t,o)=>e.jsx(Re,{inputParam:t,data:c},o))}),e.jsxs(x,{sx:{p:2,mt:1,mb:1,border:1,borderColor:l.palette.grey[900]+25,borderRadius:2},children:[e.jsxs(G,{sx:{position:"relative",alignItems:"center"},direction:"row",children:[e.jsx(E,{children:"Tools"}),e.jsx(xe,{title:"Tools are actions that your assistant can perform"})]}),y.map((t,o)=>e.jsxs(x,{sx:{border:1,borderColor:l.palette.grey[900]+25,borderRadius:2,mt:2,mb:2},children:[e.jsxs(x,{sx:{pl:2,pr:2,pt:2,pb:0},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"row"},children:[e.jsxs(E,{children:["Tool",e.jsx("span",{style:{color:"red"},children:" *"})]}),e.jsx("div",{style:{flex:1}}),e.jsx(Le,{color:"error",sx:{height:15,width:15,p:0},onClick:()=>{const a=y.filter((s,i)=>i!==o);F(a)},children:e.jsx(Ne,{})})]}),e.jsx($e,{name:t.name,options:Qe??[],onSelect:a=>{if(a){const s=Ye.find(i=>i.name===a);if(s){const i=`${s.name}_${o}`,n=I.cloneDeep(s),d=te(n,i),p=[...y];p[o]=d,F(p)}}else{const s=[...y];s[o]={},F(s)}},value:(t==null?void 0:t.name)||"choose an option"},JSON.stringify(t))]}),t&&Object.keys(t).length===0&&e.jsx(x,{sx:{pl:2,pr:2,pt:0,pb:2}}),t&&Object.keys(t).length>0&&e.jsx(x,{sx:{p:0,mt:2,mb:1},children:(t.inputParams??[]).filter(a=>!a.hidden).map((a,s)=>e.jsx(Re,{inputParam:a,data:t},s))})]},o)),e.jsx(w,{fullWidth:!0,title:"Add Tool",sx:{mt:1,mb:1,borderRadius:20},variant:"outlined",onClick:()=>F([...y,{}]),children:"Add Tool"})]}),c&&Object.keys(c).length>0&&e.jsx(w,{fullWidth:!0,title:"Save Assistant",sx:{mt:1,mb:1,borderRadius:20,background:"linear-gradient(45deg, #673ab7 30%, #1e88e5 90%)"},variant:"contained",onClick:Te,children:"Save Assistant"})]})}),j&&!q&&e.jsx(we,{item:!0,xs:12,md:6,lg:6,sm:6,children:e.jsxs(x,{sx:{mt:2},children:[K.isDarkMode&&e.jsx(se,{chatflowid:j,chatflow:P.chatflow,apiHost:be,chatflowConfig:{},theme:{button:{backgroundColor:"#32353b",iconColor:"#ffffff"},chatWindow:{height:Oe(),showTitle:!0,backgroundColor:"#23262c",title:"  Preview",botMessage:{backgroundColor:"#32353b",textColor:"#ffffff"},userMessage:{backgroundColor:"#191b1f",textColor:"#ffffff"},textInput:{backgroundColor:"#32353b",textColor:"#ffffff"},footer:{showFooter:!1}}}}),!K.isDarkMode&&e.jsx(se,{chatflowid:j,chatflow:P.chatflow,apiHost:be,chatflowConfig:{},theme:{button:{backgroundColor:"#eeeeee",iconColor:"#333333"},chatWindow:{height:Oe(),showTitle:!0,backgroundColor:"#fafafa",title:"  Preview",botMessage:{backgroundColor:"#ffffff",textColor:"#303235"},userMessage:{backgroundColor:"#f7f8ff",textColor:"#303235"},textInput:{backgroundColor:"#ffffff",textColor:"#303235"},footer:{showFooter:!1}}}})]})})]})})})}),ke&&e.jsx(zt,{open:ke}),je&&e.jsx(Wt,{show:je,dialogProps:et,onCancel:()=>Ae(!1)}),pe&&e.jsx(Ut,{chatflow:P.chatflow,isSettingsOpen:pe,anchorEl:z.current,onClose:()=>ue(!1),onSettingsItemClick:xt,isCustomAssistant:!0}),e.jsx(Jt,{show:at,dialogProps:ot,onCancel:()=>Me(!1)}),e.jsx(Kt,{show:nt,dialogProps:rt,onCancel:()=>Ie(!1)}),e.jsx(Yt,{show:lt,dialogProps:ct,onCancel:()=>Se(!1)},"chatflowConfiguration"),e.jsx(Ue,{show:pt,dialogProps:ut,onCancel:()=>me(!1),onConfirm:t=>{ce(t),me(!1)}}),e.jsx(Gt,{})]})};export{ao as default};
